<!-- This file was generated by @travetto/doc and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/main/related/todo-app/README.ts and execute "npx trv doc" to rebuild -->
# Getting Started: A Todo App

The following tutorial wil walk you through setting up a [Travetto](https://travetto.dev) application from scratch.  We'll be building a simple todo application. The entire source of the finished project can be found at [Todo App](https://github.com/travetto/travetto/tree/main/module/todo-app).  Additionally, you can use the [App Scaffold](module/scaffold#readme "App Scaffold for the Travetto framework").

### Overview   
   1. [Prerequisites](#prerequisites})
   1. [Project Initialization](#project-initialization})
   1. [Establishing The Model](#establishing-the-model})
   1. [Building the Service Layer](#building-the-service-layer})
   1. [Writing Unit tests](#writing-unit-tests})
   1. [Adding Rest Routes](#adding-rest-routes})
   1. [Running the App](#running-the-app})

## Prerequisites

Install
   
   *  [Node](https://nodejs.org/en/download/current/) v19.x+ (recommended, but v18.x+ supported)
   *  [Mongodb](https://docs.mongodb.com/manual/administration/install-community/) 3.6+ (required)
   *  [VSCode](https://code.visualstudio.com/download) (recommended)
   *  [VSCode plugin](https://marketplace.visualstudio.com/items?itemName=arcsine.travetto-plugin) (recommended)

## Project Initialization

**Terminal: Getting Ready**
```bash
$ mkdir todo-project
$ cd todo-project

$ git init .

$ npm init -f
$ npm i @travetto/{log,test,rest-express,model-mongo,compiler,cli}
```

## Establishing The Model

Let's create the model for the todo application.  The fields we will need should be:

   
   *  `id` as a unique identifier
   *  `text` as the actual todo information
   *  `created` the date the todo was created
   *  `completed` whether or not the todo was completed

Create the file `src/model.ts`

**Code: Models**
```typescript
import { Model } from '@travetto/model';
import { Schema } from '@travetto/schema';

@Model()
export class Todo {
  id: string;
  text: string;
  created?: Date;
  completed?: boolean;
  priority?: number;
  who?: string;
  #color?: string;

  set color(c: string | undefined) {
    this.#color = c;
  }

  get color() {
    return this.#color;
  }
}

@Schema()
export class TodoSearch {
  q?: string;
  offset?: number;
  limit?: number;
}
```

as you can see, the model structure is simple.  Everything that uses the [@Model](https://github.com/travetto/travetto/tree/main/module/model/src/registry/decorator.ts#L12) services needs to implement [ModelType](https://github.com/travetto/travetto/tree/main/module/model/src/types/model.ts#L1).

## Building the Service Layer

Next we establish the functionality for the service layer. The operations we need are:
   
   *  Create a new todo
   *  Complete a todo
   *  Remove a todo
   *  Get all todos

Now we need to create `src/service.ts`

**Code: Service Definition**
```typescript
import { MongoModelService } from '@travetto/model-mongo';
import { Injectable, Inject } from '@travetto/di';

import { Todo, TodoSearch } from './model';

@Injectable()
export class TodoService {

  @Inject()
  private modelService: MongoModelService;

  async add(todo: Todo) {
    todo.created = new Date();
    const saved = await this.modelService.create(Todo, todo);
    return saved;
  }

  async update(todo: Todo) {
    return await this.modelService.updatePartial(Todo, todo);
  }

  async get(id: string) {
    return this.modelService.get(Todo, id);
  }

  async getAll(search: TodoSearch) {
    return this.modelService.query(Todo, { where: { text: { $regex: search.q ?? '.*' } }, ...search, sort: [{ created: -1 }] });
  }

  async deleteAllCompleted() {
    return this.modelService.deleteByQuery(Todo, { where: { completed: true } });
  }

  async complete(id: string, completed = true) {
    return this.modelService.updatePartial(Todo, Todo.from({ id, completed }));
  }

  async remove(id: string) {
    return this.modelService.delete(Todo, id);
  }
}
```

## Writing Unit tests

After we have established our service layer, we will now construct some simple tests to verify the service layer is running correctly. By default we set the database schema name under `test/resources/application.yml` to ensure we aren't writing to our dev database.

**Code: Test YAML**
```yaml
---
mongo.model.namespace: app-test
```

Now the tests should be defined at `test/service.ts`

**Code: Test bed**
```typescript
import assert from 'assert';

import { Suite, Test } from '@travetto/test';
import { Inject } from '@travetto/di';
import { MongoModelConfig, MongoModelService } from '@travetto/model-mongo';
import { InjectableSuite } from '@travetto/di/support/test/suite';
import { ModelSuite } from '@travetto/model/support/test/suite';

import { TodoService } from '../src/service';
import { Todo } from '../src/model';

@Suite()
@ModelSuite()
@InjectableSuite()
export class TodoTest {

  serviceClass = MongoModelService;
  configClass = MongoModelConfig;

  @Inject()
  svc: TodoService;

  @Test('Create todo')
  async create() {
    const test = Todo.from({
      text: 'Sample Task'
    });

    const saved = await this.svc.add(test);

    assert.ok(saved.id);
  }

  @Test('Complete todo')
  async complete() {
    const test = Todo.from({
      text: 'Sample Task'
    });

    const saved = await this.svc.add(test);
    assert.ok(saved.id);

    let updated = await this.svc.complete(saved.id);
    assert(updated.completed === true);

    updated = await this.svc.complete(saved.id, false);
    assert(updated.completed === false);
  }

  @Test('Delete todo')
  async remove() {
    const test = Todo.from({
      text: 'Sample Task'
    });

    const saved = await this.svc.add(test);
    assert.ok(saved.id);
    assert(test.text === 'Sample Task');

    await this.svc.remove(saved.id);

    await assert.rejects(() => this.svc.get(saved.id), /Todo.*not found/);
  }
}
```

## Adding Rest Routes
Now we establish the routes, providing an interface to the service layer.

Finally, we establish the controller at `src/route.ts`

**Code: Controller contents**
```typescript
import { Controller, Get, Post, Put, Delete } from '@travetto/rest';
import { Inject } from '@travetto/di';

import { TodoService } from './service';
import { Todo, TodoSearch } from './model';

@Controller('/todo')
export class TodoController {

  _svc: TodoService;

  @Inject()
  set svc(v: TodoService) {
    this._svc = v;
  }

  /**
   * Get all todos
   */
  @Get('/')
  async getAll(search: TodoSearch) {
    return await this._svc.getAll(search);
  }

  /**
   * Delete all todos
   */
  @Delete('/')
  async deleteAllCompleted() {
    await this._svc.deleteAllCompleted();
  }

  /**
   * Get Todo by id
   * @param id Todo id
   */
  @Get('/:id')
  async getById(id: string) {
    return this._svc.get(id);
  }

  /**
   * Create a todo
   */
  @Post('/')
  async create(todo: Todo) {
    return await this._svc.add(todo);
  }

  /**
   * Update a todo
   * @param id Todo id
   * @param todo Todo to update
   */
  @Put('/:id')
  async update(id: string, todo: Todo) {
    todo.id = id;
    return await this._svc.update(todo);
  }

  /**
   * Complete a todo
   * @param id Todo id
   */
  @Put('/:id/complete')
  async complete(id: string, completed: boolean = true) {
    return await this._svc.complete(id, completed);
  }

  /**
   * Delete a todo
   * @param id Todo id
   */
  @Delete('/:id')
  async remove(id: string) {
    console.log('Hello');
    await this._svc.remove(id);
  }
}
```

## Running the App

First we must start the application:

**Terminal: Application Startup**
```bash
2022-03-14T04:00:00.618Z info  [@travetto/app:src/registry.ts:61] Running application { name: 'rest', filename: '@travetto/rest/src/application/rest.ts' }
2022-03-14T04:00:00.837Z info  [@travetto/app:src/registry.ts:67] Manifest {
  info: {
    name: '@travetto/todo-app',
    main: undefined,
    author: { email: 'travetto.framework@gmail.com', name: 'Travetto Framework' },
    license: 'ISC',
    version: '0.0.0',
    framework: '3.0.0'
  },
  env: { name: 'dev', prod: false, dynamic: false, profiles: [], nodeVersion: 'v18.12.1' }
}
2022-03-14T04:00:01.510Z debug [@travetto/rest:src/application/rest.ts:92] Sorting interceptors {
  count: 13,
  names: [
    'AcceptsInterceptor',
    'BodyParseInterceptor',
    'LoggingInterceptor',
    'SerializeInterceptor',
    'CorsInterceptor',
    'CookiesInterceptor',
    'GetCacheInterceptor',
    'AsyncContextInterceptor',
    'SessionWriteInterceptor',
    'AuthReadWriteInterceptor',
    'AuthVerifyInterceptor',
    'AuthLoginInterceptor',
    'SessionReadInterceptor',
    [length]: 13
  ]
}
2022-03-14T04:00:02.450Z debug [@travetto/rest:src/application/rest.ts:139] Registering Controller Instance { id: '@travetto/todo-app:src/ui￮UIController', path: '/ui', endpointCount: 3 }
2022-03-14T04:00:02.762Z debug [@travetto/rest:src/application/rest.ts:139] Registering Controller Instance { id: '@travetto/todo-app:src/auth￮ApiController', path: '/auth', endpointCount: 3 }
2022-03-14T04:00:02.947Z debug [@travetto/rest:src/application/rest.ts:139] Registering Controller Instance { id: '@travetto/openapi:src/controller￮OpenApiController', path: '/', endpointCount: 2 }
2022-03-14T04:00:03.093Z debug [@travetto/rest:src/application/rest.ts:139] Registering Controller Instance { id: '@travetto/todo-app:src/route￮TodoController', path: '/todo', endpointCount: 7 }
2022-03-14T04:00:04.003Z info  [@travetto/app:src/registry.ts:81] Config {
  sources: [ 'application.1 - file://application.yml', 'override.3 - memory://override' ],
  active: {
    ApiHostConfig: {
      servers: [ ServerObject_1856065672_49_163Ⲑsyn { url: 'http://localhost:3000' } ],
      openapi: '3.0.1'
    },
    ApiInfoConfig: {
      contact: ContactObject_1856065672_40_123Ⲑsyn {
        name: 'Travetto Framework',
        email: 'travetto.framework@gmail.com'
      },
      description: '',
      license: LicenseObject_1856065672_45_102Ⲑsyn { name: 'ISC' },
      title: '@travetto/todo-app',
      version: '0.0.0'
    },
    ApiSpecConfig: { output: './openapi.yml', persist: false, skipRoutes: false, exposeAllSchemas: false },
    FileModelConfig: { folder: '/tmp/4a387b568d', namespace: '.' },
    MemoryModelConfig: {},
    MongoModelConfig: {
      hosts: [ 'localhost' ],
      namespace: 'app',
      username: '',
      password: '',
      port: 27017,
      connectionOptions: connectionOptions_34_2Ⲑsyn {},
      srvRecord: false,
      options: {}
    },
    RestAcceptsConfig: { types: [] },
    RestAsyncContextConfig: {},
    RestAuthConfig: {},
    RestAuthLoginConfig: {},
    RestAuthVerifyConfig: { roles: [] },
    RestBodyParseConfig: { limit: '100kb', parsingTypes: {} },
    RestConfig: {
      serve: true,
      port: 3000,
      trustProxy: false,
      hostname: 'localhost',
      bindAddress: '0.0.0.0',
      baseUrl: 'http://localhost:3000',
      defaultMessage: true
    },
    RestCookieConfig: { signed: true, httpOnly: true, sameSite: 'lax' },
    RestCorsConfig: {},
    RestGetCacheConfig: {},
    RestLogRoutesConfig: {},
    RestSessionConfig: {},
    RestSslConfig: { active: false },
    SessionConfig: {
      autoCommit: true,
      maxAge: 1800000,
      renew: true,
      rolling: false,
      sign: true,
      keyName: 'trv_sid',
      transport: 'cookie'
    }
  }
}
2022-03-14T04:00:04.495Z info  [@travetto/rest:src/application/rest.ts:193] Listening { port: 3000 }
```

next, let's execute [fetch](https://www.npmjs.com/package/node-fetch) requests to interact with the new api:

**Code: Creating Todo by fetch**
```typescript
import fetch from 'node-fetch';

export async function main() {
  const res = await fetch('http://localhost:3000/todo', {
    method: 'POST',
    body: JSON.stringify({ text: 'New Todo' }),
    headers: {
      'Content-Type': 'application/json'
    }
  })
    .then(r => r.json());
  console.log!(res);
}
```

**Terminal: Create Output**
```bash
$ trv main support/main.create-todo.ts

{
  text: 'New Todo',
  created: '2022-03-14T04:00:05.066Z',
  id: '3aed76ee063d13feec2e5e95b45513eb'
}
```

**Code: Listing Todos by fetch**
```typescript
import fetch from 'node-fetch';

export async function main() {
  const res = await fetch('http://localhost:3000/todo').then(r => r.json());
  console.log!(res);
}
```

**Terminal: Listing Output**
```bash
$ trv main support/main.list-todo.ts

[
  {
    id: '3aed76ee063d13feec2e5e95b45513eb',
    text: 'New Todo',
    created: '2022-03-14T04:00:05.719Z'
  }
]
```
