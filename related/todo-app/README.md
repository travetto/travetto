<!-- This file was generated by @travetto/doc and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/main/related/todo-app/DOC.tsx and execute "npx trv doc" to rebuild -->
# Getting Started: A Todo App

The following tutorial wil walk you through setting up a [Travetto](https://travetto.dev) application from scratch.  We'll be building a simple todo application. The entire source of the finished project can be found at [Todo App](https://github.com/travetto/travetto/tree/main/module/todo-app).  Additionally, you can use the [App Scaffold](https://github.com/travetto/travetto/tree/main/module/scaffold#readme "App Scaffold for the Travetto framework").

## Overview

   1. [Prerequisites](#prerequisites)
   1. [Project Initialization](#project-initialization)
   1. [Establishing The Model](#establishing-the-model)
   1. [Building the Service Layer](#building-the-service-layer)
   1. [Writing Unit tests](#writing-unit-tests)
   1. [Adding Rest Routes](#adding-rest-routes)
   1. [Running the App](#running-the-app)

## Prerequisites
Install
   *  [Node](https://nodejs.org/en/download/current/) v19.x+ (recommended, but v18.x+ supported)
   *  [Mongodb](https://docs.mongodb.com/manual/administration/install-community/) 3.6+ (required, but 4.4+ recommended)
   *  [VSCode](https://code.visualstudio.com/download) (recommended)
   *  [VSCode plugin](https://marketplace.visualstudio.com/items?itemName=arcsine.travetto-plugin) (recommended)

## Project Initialization

**Terminal: Getting Ready**
```bash
$ mkdir todo-project
$ cd todo-project

$ git init .

$ npm init -f
$ npm i @travetto/{log,rest-express,model-mongo,cli}
$ npm i -D @travetto/{eslint,compiler,test}

$ npx trv lint:register
```

## Establishing The Model
Let's create the model for the todo application.  The fields we will need should be:
   *  `id` as a unique identifier
   *  `text` as the actual todo information
   *  `created` the date the todo was created
   *  `completed` whether or not the todo was completed
Create the file `src/model.ts`

**Code: Models**
```typescript
import { Model } from '@travetto/model';
import { Schema } from '@travetto/schema';

@Model()
export class Todo {
  id: string;
  text: string;
  created?: Date;
  completed?: boolean;
  priority?: number;
  who?: string;
  #color?: string;

  set color(c: string | undefined) {
    this.#color = c;
  }

  get color(): string | undefined {
    return this.#color;
  }
}

@Schema()
export class TodoSearch {
  q?: string;
  offset?: number;
  limit?: number;
}
```

as you can see, the model structure is simple.  Everything that uses the [@Model](https://github.com/travetto/travetto/tree/main/module/model/src/registry/decorator.ts#L13) services needs to implement [ModelType](https://github.com/travetto/travetto/tree/main/module/model/src/types/model.ts#L1).

## Building the Service Layer
Next we establish the functionality for the service layer. The operations we need are:
   *  Create a new todo
   *  Complete a todo
   *  Remove a todo
   *  Get all todos
Now we need to create `src/service.ts`

**Code: Service Definition**
```typescript
import { MongoModelService } from '@travetto/model-mongo';
import { Injectable, Inject } from '@travetto/di';

import { Todo, TodoSearch } from './model';

@Injectable()
export class TodoService {

  @Inject()
  private modelService: MongoModelService;

  async add(todo: Todo): Promise<Todo> {
    todo.created = new Date();
    const saved = await this.modelService.create(Todo, todo);
    return saved;
  }

  async update(todo: Todo): Promise<Todo> {
    return await this.modelService.updatePartial(Todo, todo);
  }

  async get(id: string): Promise<Todo> {
    return this.modelService.get(Todo, id);
  }

  async getAll(search: TodoSearch): Promise<Todo[]> {
    return this.modelService.query(Todo, { where: { text: { $regex: search.q ?? '.*' } }, ...search, sort: [{ created: -1 }] });
  }

  async deleteAllCompleted(): Promise<number> {
    return this.modelService.deleteByQuery(Todo, { where: { completed: true } });
  }

  async complete(id: string, completed = true): Promise<Todo> {
    return this.modelService.updatePartial(Todo, Todo.from({ id, completed }));
  }

  async remove(id: string): Promise<void> {
    return this.modelService.delete(Todo, id);
  }
}
```

## Writing Unit tests
After we have established our service layer, we will now construct some simple tests to verify the service layer is running correctly. By default we set the database schema name under `test/resources/application.yml` to ensure we aren't writing to our dev database.

**Code: Test YAML**
```yaml
---
mongo.model.namespace: app-test
```

Now the tests should be defined at `test/service.ts`

**Code: Test bed**
```typescript
import assert from 'assert';

import { Suite, Test } from '@travetto/test';
import { Inject } from '@travetto/di';
import { MongoModelConfig, MongoModelService } from '@travetto/model-mongo';
import { InjectableSuite } from '@travetto/di/support/test/suite';
import { ModelSuite } from '@travetto/model/support/test/suite';

import { TodoService } from '../src/service';
import { Todo } from '../src/model';

@Suite()
@ModelSuite()
@InjectableSuite()
export class TodoTest {

  serviceClass = MongoModelService;
  configClass = MongoModelConfig;

  @Inject()
  svc: TodoService;

  @Test('Create todo')
  async create() {
    const test = Todo.from({
      text: 'Sample Task'
    });

    const saved = await this.svc.add(test);

    assert.ok(saved.id);
  }

  @Test('Complete todo')
  async complete() {
    const test = Todo.from({
      text: 'Sample Task'
    });

    const saved = await this.svc.add(test);
    assert.ok(saved.id);

    let updated = await this.svc.complete(saved.id);
    assert(updated.completed === true);

    updated = await this.svc.complete(saved.id, false);
    assert(updated.completed === false);
  }

  @Test('Delete todo')
  async remove() {
    const test = Todo.from({
      text: 'Sample Task'
    });

    const saved = await this.svc.add(test);
    assert.ok(saved.id);
    assert(test.text === 'Sample Task');

    await this.svc.remove(saved.id);

    await assert.rejects(() => this.svc.get(saved.id), /Todo with id .* not found/);
  }
}
```

## Adding Rest Routes
Now we establish the routes, providing an interface to the service layer.

Finally, we establish the controller at `src/route.ts`

**Code: Controller contents**
```typescript
import { Controller, Get, Post, Put, Delete } from '@travetto/rest';
import { Inject } from '@travetto/di';

import { TodoService } from './service';
import { Todo, TodoSearch } from './model';

@Controller('/todo')
export class TodoController {

  _svc: TodoService;

  @Inject()
  set svc(v: TodoService) {
    this._svc = v;
  }

  /**
   * Get all todos
   */
  @Get('/')
  async getAll(search: TodoSearch): Promise<Todo[]> {
    return await this._svc.getAll(search);
  }

  /**
   * Delete all todos
   */
  @Delete('/')
  async deleteAllCompleted(): Promise<void> {
    await this._svc.deleteAllCompleted();
  }

  /**
   * Get Todo by id
   * @param id Todo id
   */
  @Get('/:id')
  async getById(id: string): Promise<Todo> {
    return this._svc.get(id);
  }

  /**
   * Create a todo
   */
  @Post('/')
  async create(todo: Todo): Promise<Todo> {
    return await this._svc.add(todo);
  }

  /**
   * Update a todo
   * @param id Todo id
   * @param todo Todo to update
   */
  @Put('/:id')
  async update(id: string, todo: Todo): Promise<Todo> {
    todo.id = id;
    return await this._svc.update(todo);
  }

  /**
   * Complete a todo
   * @param id Todo id
   */
  @Put('/:id/complete')
  async complete(id: string, completed: boolean = false): Promise<Todo> {
    return await this._svc.complete(id, completed);
  }

  /**
   * Delete a todo
   * @param id Todo id
   */
  @Delete('/:id')
  async remove(id: string): Promise<void> {
    console.log('Hello');
    await this._svc.remove(id);
  }
}
```

## Running the App
First we must start the application:

**Terminal: Start the Application**
```bash
npx trv run:rest
```

**Terminal: Application Startup**
```bash
2029-03-14T04:00:00.618Z info  [@travetto/config:src/service.ts:143] Initialized {
  manifest: { mainModule: '@travetto/todo-app', frameworkVersion: '3.3.1', version: '0.0.0' },
  env: {
    envName: 'dev',
    debug: '0',
    devMode: true,
    test: false,
    dynamic: false,
    profiles: [ 'dev' ],
    resourcePaths: [],
    nodeVersion: '20'
  },
  config: {
    sources: [
      'application.1 - file://./resources/application.yml',
      'dev.1 - file://./resources/dev.yml',
      'override.3 - memory://override'
    ],
    active: {
      ApiHostConfig: { openapi: '3.0.0' },
      ApiInfoConfig: { description: '', title: '@travetto/todo-app', version: '0.0.0' },
      ApiSpecConfig: {
        output: './openapi.yml',
        persist: false,
        skipRoutes: false,
        exposeAllSchemas: false
      },
      CommonLoggerConfig: { format: 'line', output: 'console' },
      ConsoleLogAppenderConfig: { logToLevel: true },
      FileLogAppenderConfig: {
        output: './.trv_build/logs/@travetto/todo-app.log',
        writeSync: false
      },
      FileModelConfig: { folder: '/tmp/<temp-folder>', namespace: '.' },
      JSONLogFormatterConfig: {},
      LineLogFormatterConfig: {
        plain: false,
        time: 'ms',
        colorize: true,
        align: true,
        level: true,
        location: true
      },
      MemoryModelConfig: {},
      MongoModelConfig: {
        hosts: { '0': 'localhost' },
        namespace: 'app',
        username: '',
        port: 27017,
        connectionOptions: {},
        srvRecord: false,
        options: {}
      },
      RestAcceptsConfig: { types: {} },
      RestAsyncContextConfig: {},
      RestAuthConfig: {},
      RestAuthContextConfig: {},
      RestAuthLoginConfig: {},
      RestAuthVerifyConfig: { permissions: {} },
      RestBodyParseConfig: { limit: '100kb', parsingTypes: {} },
      RestClientConfig: { providers: { '0': [Object], '1': [Object] } },
      RestConfig: {
        serve: true,
        port: 12555,
        trustProxy: false,
        hostname: 'localhost',
        bindAddress: '0.0.0.0',
        baseUrl: 'http://localhost:12555',
        defaultMessage: true,
        ssl: { active: false }
      },
      RestCookieConfig: { signed: true, httpOnly: true, sameSite: 'lax' },
      RestCorsConfig: {},
      RestGetCacheConfig: {},
      RestLogRoutesConfig: {},
      RestSessionConfig: {},
      RestSslConfig: { active: false },
      SessionConfig: {
        autoCommit: true,
        maxAge: 1800000,
        renew: true,
        rolling: false,
        sign: true,
        keyName: 'trv_sid',
        transport: 'cookie'
      }
    }
  }
}
2029-03-14T04:00:00.837Z info  [@travetto/rest:src/application/rest.ts:192] Listening { port: 12555 }
```

next, let's execute [fetch](https://www.npmjs.com/package/node-fetch) requests to interact with the new api. 

Create `support/create-todo.ts` with the following contents:

**Code: Creating Todo by fetch**
```typescript
export async function main(key: string, port: number) {
  const res = await fetch(`http://localhost:${port}/todo`, {
    method: 'POST',
    body: JSON.stringify({ text: `New Todo - ${key}` }),
    headers: {
      'Content-Type': 'application/json'
    }
  })
    .then(r => r.json());
  console.log!(res);
}
```

**Terminal: Create Output**
```bash
$ trv main support/create-todo.ts <key> <port>

{
  text: 'New Todo - <key>',
  created: '2029-03-14T04:00:01.510Z',
  id: '<uniqueId>'
}
```

Now create `support/list-todo.ts` with the following contents:

**Code: Listing Todos by fetch**
```typescript
export async function main(key: string, port: number) {
  const res = await fetch(`http://localhost:${port}/todo?q=${key}`).then(r => r.json());
  console.log!(res);
}
```

**Terminal: Listing Output**
```bash
$ trv main support/list-todo.ts <key> <port>

[
  {
    id: '<uniqueId>',
    text: 'New Todo - <key>',
    created: '2029-03-14T04:00:01.814Z'
  }
]
```
