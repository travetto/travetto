<!-- This file was generated by the framweork and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/master/related/todo-app/doc.ts and execute "npm run docs" to rebuild -->

# Getting Started: A Todo App

The following tutorial wil walk you through setting up a [Travetto](https://travetto.dev) application from scratch.  We'll be building a simple todo application. The entire source of the finished project can be found at [Todo App](https://github.com/travetto/travetto/tree/master/related/todo-app).  Additionally, you can use the [Yeoman Generator](https://github.com/travetto/travetto/tree/master/related/generator-app#readme "Yeoman app generator for the Travetto framework").
### Overview   
   1. [Prerequisites](#prerequisites})
   1. [Project Initialization](#project-initialization})
   1. [Establishing The Model](#establishing-the-model})
   1. [Building the Service Layer](#building-the-service-layer})
   1. [Writing Unit tests](#writing-unit-tests})
   1. [Adding Rest Routes](#adding-rest-routes})
   1. [Running the App](#running-the-app})


## Prerequisites

Install
   
   *  [Node](https://nodejs.org/en/download/current/) v12.x + (required)
   *  [Mongodb](https://docs.mongodb.com/manual/administration/install-community/) 3.6+ (required)
   *  [VSCode](https://code.visualstudio.com/download) (recommended)
   *  [VSCode plugin](https://marketplace.visualstudio.com/items?itemName=arcsine.travetto-plugin) (recommended)

## Project Initialization

**Terminal: Getting Ready**
```bash
$ mkdir todo-project
$ cd todo-project

$ git init .

$ npm init -f
$ npm i @travetto/{log,test,rest-express,model-mongo}
```

## Establishing The Model

Let's create the model for the todo application.  The fields we will need should be:

   
   *  `id` as a unique identifier
   *  `text` as the actual todo information
   *  `created` the date the todo was created
   *  `completed` whether or not the todo was completed

Create the file `src/model.ts`

**Code: Models**
```typescript
import { Model } from '@travetto/model';
import { Schema } from '@travetto/schema';

@Model()
export class Todo {
  id: string;
  text: string;
  created?: Date;
  completed?: boolean;
  priority?: number;
  who?: string;
  color?: string;
}

@Schema()
export class TodoSearch {
  offset?: number;
  limit?: number;
}
```

as you can see, the model structure is simple.  Everything that uses the [@Model](https://github.com/travetto/travetto/tree/master/module/model/src/registry/decorator.ts#L13) services needs to implement [ModelType](https://github.com/travetto/travetto/tree/master/module/model/src/types/model.ts#L1).

## Building the Service Layer

Next we establish the functionality for the service layer. The operations we need are:
   
   *  Create a new todo
   *  Complete a todo
   *  Remove a todo
   *  Get all todos

Now we need to create `src/service.ts`

**Code: Service Definition**
```typescript
import { ElasticsearchModelService } from '@travetto/model-elasticsearch';
import { Injectable, Inject } from '@travetto/di';
import { Todo, TodoSearch } from './model';

@Injectable()
export class TodoService {

  @Inject()
  private modelService: ElasticsearchModelService;

  async add(todo: Todo) {
    todo.created = new Date();
    const saved = await this.modelService.create(Todo, todo);
    return saved;
  }

  async get(id: string) {
    return this.modelService.get(Todo, id);
  }

  async getAll(search: TodoSearch) {
    return await this.modelService.list(Todo);
  }

  async complete(id: string, completed = true) {
    return this.modelService.updatePartial(Todo, Todo.from({ id, completed }));
  }

  async remove(id: string) {
    return this.modelService.delete(Todo, id);
  }
}
```

## Writing Unit tests

After we have established our service layer, we will now construct some simple tests to verify the service layer is running correctly. By default we set the database schema name under `test/resources/application.yml` to ensure we aren't writing to our dev database.

**Code: Test YAML**
```yaml
---
mongo.model.namespace: app-test
```

Now the tests should be defined at `test/service.ts`

**Code: Test bed**
```typescript
import * as assert from 'assert';

import { Suite, Test } from '@travetto/test';
import { Inject } from '@travetto/di';
import { BaseModelSuite } from '@travetto/model/test-support/base';
import { ModelCrudSupport } from '@travetto/model';
import { ElasticsearchModelConfig, ElasticsearchModelService } from '@travetto/model-elasticsearch';
import { InjectableSuite } from '@travetto/di/test-support/suite';

import { TodoService } from '../src/service';
import { Todo } from '../src/model';

@Suite()
@InjectableSuite()
export class TodoTest extends BaseModelSuite<ModelCrudSupport> {

  @Inject()
  svc: TodoService;

  constructor() {
    super(ElasticsearchModelService, ElasticsearchModelConfig);
  }

  @Test('Create todo')
  async create() {
    const test = Todo.from({
      text: 'Sample Task'
    });

    const saved = await this.svc.add(test);

    assert.ok(saved.id);
  }

  @Test('Complete todo')
  async complete() {
    const test = Todo.from({
      text: 'Sample Task'
    });

    const saved = await this.svc.add(test);
    assert.ok(saved.id);

    let updated = await this.svc.complete(saved.id);
    assert(updated.completed === true);

    updated = await this.svc.complete(saved.id, false);
    assert(updated.completed === false);
  }

  @Test('Delete todo')
  async remove() {
    const test = Todo.from({
      text: 'Sample Task'
    });

    const saved = await this.svc.add(test);
    assert.ok(saved.id);
    assert(test.text === 'Sample Task');

    await this.svc.remove(saved.id);

    try {
      await this.svc.get(saved.id);
    } catch (e) {
      assert(e.message);
    }
  }
}
```

## Adding Rest Routes
Now we establish the routes, providing an interface to the service layer.

Finally, we establish the controller at `src/route.ts`

**Code: Controller contents**
```typescript
import { Controller, Get, Post, Put, Delete, Path, Query, SchemaBody, SchemaQuery } from '@travetto/rest';
import { Inject } from '@travetto/di';

import { TodoService } from './service';
import { Todo, TodoSearch } from './model';

@Controller('/todo')
export class TodoController {

  @Inject()
  private svc: TodoService;

  /**
   * Get all todos
   */
  @Get('/')
  async getAll(@SchemaQuery() search: TodoSearch) {
    const itr = await this.svc.getAll(search);
    const out = [];
    for await (const item of itr) {
      out.push(item);
    }
    return out;
  }

  /**
   * Get Todo by id
   * @param id Todo id
   */
  @Get('/:id')
  async getById(@Path() id: string) {
    return this.svc.get(id);
  }

  /**
   * Create a todo
   */
  @Post('/')
  async create(@SchemaBody() todo: Todo) {
    return await this.svc.add(todo);
  }

  /**
   * Complete a todo
   * @param id Todo id
   */
  @Put('/:id/complete')
  async complete(@Path() id: string, @Query() completed: boolean = true) {
    return await this.svc.complete(id, completed);
  }

  /**
   * Delete a todo
   * @param id Todo id
   */
  @Delete('/:id')
  async remove(@Path() id: string) {
    await this.svc.remove(id);
  }
}
```

## Running the App

First we must start the application:

**Terminal: Application Startup**
```bash
$ ./doc/startup.sh 

2021-03-14T05:00:00.618Z info  [@trv:app/registry:30] Running application { name: 'rest', filename: '/home/tim/Code/travetto/module/rest/src/application/rest.ts' }
2021-03-14T05:00:00.837Z info  [@trv:app/registry:34] Configured {
  info: {
    name: '@travetto/todo-app',
    description: '',
    version: undefined,
    license: 'ISC',
    author: '',
    frameworkVersion: '2.0.0'
  },
  env: {
    name: 'dev',
    profiles: [ 'application', 'dev' ],
    prod: false,
    debug: { status: false, value: undefined },
    resources: [ 'resources', 'doc/resources' ],
    shutdownWait: 2000,
    watch: true,
    readonly: false
  },
  source: {
    common: [ 'src' ],
    local: [ '^doc' ],
    excludeModules: Set(3) { '@travetto/cli', '@travetto/doc', '@travetto/boot' },
    dynamicModules: {
      '@travetto/app': '/home/tim/Code/travetto/module/app',
      '@travetto/base': '/home/tim/Code/travetto/module/base',
      '@travetto/boot': '/home/tim/Code/travetto/module/boot',
      '@travetto/cli': '/home/tim/Code/travetto/module/cli',
      '@travetto/compiler': '/home/tim/Code/travetto/module/compiler',
      '@travetto/config': '/home/tim/Code/travetto/module/config',
      '@travetto/di': '/home/tim/Code/travetto/module/di',
      '@travetto/doc': '/home/tim/Code/travetto/module/doc',
      '@travetto/log': '/home/tim/Code/travetto/module/log',
      '@travetto/model': '/home/tim/Code/travetto/module/model',
      '@travetto/model-elasticsearch': '/home/tim/Code/travetto/module/model-elasticsearch',
      '@travetto/model-query': '/home/tim/Code/travetto/module/model-query',
      '@travetto/openapi': '/home/tim/Code/travetto/module/openapi',
      '@travetto/pack': '/home/tim/Code/travetto/module/pack',
      '@travetto/registry': '/home/tim/Code/travetto/module/registry',
      '@travetto/rest': '/home/tim/Code/travetto/module/rest',
      '@travetto/rest-express': '/home/tim/Code/travetto/module/rest-express',
      '@travetto/schema': '/home/tim/Code/travetto/module/schema',
      '@travetto/test': '/home/tim/Code/travetto/module/test',
      '@travetto/transformer': '/home/tim/Code/travetto/module/transformer',
      '@travetto/watch': '/home/tim/Code/travetto/module/watch',
      '@travetto/worker': '/home/tim/Code/travetto/module/worker',
      '@travetto/yaml': '/home/tim/Code/travetto/module/yaml'
    }
  },
  config: {
    rest: { cors: { active: true } },
    api: { spec: { output: './openapi.yml' } },
    sql: { model: { namespace: 'todo', user: 'root', password: 'password' } }
  }
}
2021-03-14T05:00:01.510Z info  [@trv:rest/application/rest:192] Listening { port: 3000 }
```
 

next, let's execute [curl](https://curl.haxx.se/) requests to interact with the new api:

**Code: Creating Todo by curl**
```bash
curl -s -XPOST localhost:3000/todo -H 'Content-Type: application/json' -d '{ "text": "New Todo" }' | jq
```

**Terminal: Create Output**
```bash
$ ./doc/create.sh 

{
  "text": "New Todo",
  "created": "2021-03-14T05:00:02.450Z",
  "id": "422e793aed76ee063d13feec2e5e95b4"
}
```

**Code: Listing Todos by curl**
```bash
curl -s -XGET localhost:3000/todo -H 'Content-Type: application/json' | jq
```

**Terminal: Listing Output**
```bash
$ ./doc/list.sh 

[
  {
    "id": "422e793aed76ee063d13feec2e5e95b4",
    "text": "New Todo",
    "created": "2021-03-14T05:00:02.819Z"
  }
]
```

