<div class="documentation"><h2 id="cache" id="cache">Cache</h2>
<app-section-header headerType="install">Primary</app-section-header>
<pre><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> @travetto/cache</code></pre><p>Provides a foundational structure for integrating caching at the method level.  This allows for easy extension with a variety of providers, and is usable with or without <a class="module-link" routerLink="/docs/di"  null><code class="inline">Dependency Injection</code></a>.  The code aims to handle use cases surrounding common/basic usage.</p>
<h3 id="decorators">Decorators</h3>
<p>The caching framework provides method decorators that enables simple use cases.  One of the requirements to use the caching decorators is that the method arguments, and return values need to be serializable into JSON.  Any other data types are not currently supported and would require either manual usage of the caching services directly, or specification of serialization/deserialization routines in the cache config.</p>
<p>Additionally, to use the decorators you will need to have a <a class="source-link" href="https://github.com/travetto/travetto/tree/master/module/cache/src/source/types.ts" target="_blank" null><code class="inline">CacheSource</code></a> object accessible on the class instance. This can be dependency injected, or manually constructed. The decorators will detect the field at time of method execution, which decouples construction of your class from the cache construction.</p>
<p><code class="decorator inline">@Cache</code> is a decorator that will cache all successful results, keyed by a computation based on the method arguments.  Given the desire for supporting remote caches (e.g. redis, memcached), only asynchronous methods are supported. Though if you do have a cache source that is synchronous, you can use it directly to support synchronous workloads.</p>
<app-section-header headerType="code">Using decorators to cache expensive async call</app-section-header>
<pre><code class="language-typescript"><span class="token keyword">class</span> <span class="token class-name">Worker</span> <span class="token punctuation">{{ '{' }}</span>

  myCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryCacheSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  @<span class="token meta">Cache</span><span class="token punctuation">(</span><span class="token string">'myCache'</span><span class="token punctuation">,</span> <span class="token punctuation">{{ '{' }}</span> maxAge<span class="token operator">:</span> <span class="token number">1000</span> <span class="token punctuation">{{ '}' }}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">calculateExpensiveResult</span><span class="token punctuation">(</span><span class="token parameter">expression<span class="token operator">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://google.com?q=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${{ '{' }}</span>expression<span class="token interpolation-punctuation punctuation">{{ '}' }}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">{{ '}' }}</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><h4 id="cache-1">@Cache</h4>
<p>The <code class="decorator inline">@Cache</code> decorator supports configurations on:</p>
<ul>
<li><code class="inline">name</code> the field name of the current class which points to the desired cache source.</li>
<li><code class="inline">config</code> the additional/optional config options, on a per invocation basis<ul>
<li><code class="inline">keySpace</code> the key space within the cache.  Defaults to class name plus method name.</li>
<li><code class="inline">key</code> the function  will use the inputs to determine the cache key, defaults to all params <code class="inline">JSON.stringify</code>ied</li>
<li><code class="inline">params</code> the function used to determine the inputs for computing the cache key.  This is an easier place to start to define what parameters are important in caching. This defaults to all inputs.</li>
<li><code class="inline">maxAge</code> the number of milliseconds will hold the value before considering the cache entry to be invalid.  By default values will live infinitely.</li>
<li><code class="inline">extendOnAccess</code> determines if the cache timeout should be extended on access.  This only applies to cache values that have specified a <code class="inline">maxAge</code>.</li>
<li><code class="inline">serialize</code> the function to execute before storing a cacheable value.  This allows for any custom data modification needed to persist as a string properly. </li>
<li><code class="inline">reinstate</code> the function to execute on return of a cached value.  This allows for any necessary operations to conform to expected output (e.g. re-establishing class instances, etc.).  This method should not be used often, as the return values of the methods should naturally serialize to/from <code class="inline">JSON</code> and the values should be usable either way.</li>
</ul>
</li>
</ul>
<h4 id="evictcache">@EvictCache</h4>
<p>Additionally, there is support for planned eviction via the <code class="decorator inline">@EvictCache</code> decorator.  On successful execution of a method with this decorator, the matching keySpace/key value will be evicted from the cache.  This requires coordination between multiple methods, to use the same <code class="inline">keySpace</code> and <code class="inline">key</code> to compute the expected key.</p>
<app-section-header headerType="code">Using decorators to cache/evict user access</app-section-header>
<pre><code class="language-typescript"><span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{{ '{' }}</span>

  myCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryCacheSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  @<span class="token meta">Cache</span><span class="token punctuation">(</span><span class="token string">'myCache'</span><span class="token punctuation">,</span> <span class="token punctuation">{{ '{' }}</span> keySpace<span class="token operator">:</span> <span class="token string">'user.id'</span> <span class="token punctuation">{{ '}' }}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token operator">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">return</span> database<span class="token punctuation">.</span><span class="token function">lookupUser</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{ '}' }}</span>

  @<span class="token meta">EvictCache</span><span class="token punctuation">(</span><span class="token string">'myCache'</span><span class="token punctuation">,</span> <span class="token punctuation">{{ '{' }}</span> keySpace<span class="token operator">:</span> <span class="token string">'user.id'</span><span class="token punctuation">,</span> <span class="token function-variable function">params</span><span class="token operator">:</span> <span class="token parameter">user</span> <span class="token operator">=></span> <span class="token punctuation">[</span>user<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token punctuation">{{ '}' }}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">updateUser</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token operator">:</span> User</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token operator">...</span> update user <span class="token operator">...</span>
  <span class="token punctuation">{{ '}' }}</span>

  @<span class="token meta">EvictCache</span><span class="token punctuation">(</span><span class="token string">'myCache'</span><span class="token punctuation">,</span> <span class="token punctuation">{{ '{' }}</span> keySpace<span class="token operator">:</span> <span class="token string">'user.id'</span> <span class="token punctuation">{{ '}' }}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">deleteUser</span><span class="token punctuation">(</span><span class="token parameter">userId<span class="token operator">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token operator">...</span> <span class="token keyword">delete</span> user <span class="token operator">...</span>
  <span class="token punctuation">{{ '}' }}</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><h3 id="building-a-custom-source">Building a Custom Source</h3>
<p>The module comes with a <a class="source-link" href="https://github.com/travetto/travetto/tree/master/module/cache/src/source/memory.ts" target="_blank" null><code class="inline">MemoryCacheSource</code></a> and a <a class="source-link" href="https://github.com/travetto/travetto/tree/master/module/cache/src/source/file.ts" target="_blank" null><code class="inline">FileCacheSource</code></a>. The module also has extension for a <a class="module-link" routerLink="/docs/model"  null><code class="inline">Redis</code>] source and [<code class="inline">Model</code></a>-backed source.  </p>
<app-section-header headerType="code">Primary Source structure</app-section-header>
<pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">CacheSource</span> <span class="token punctuation">{{ '{' }}</span>
  <span class="token keyword">abstract</span> <span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token type">CacheEntry</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token type">CacheEntry</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token keyword">abstract</span> <span class="token function">has</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token keyword">abstract</span> <span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> entry<span class="token operator">:</span> <span class="token type">CacheEntry</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token type">CacheEntry</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token type">CacheEntry</span><span class="token punctuation">;</span>
  <span class="token keyword">abstract</span> <span class="token keyword">delete</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>

  <span class="token keyword">abstract</span> <span class="token function">isExpired</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token keyword">abstract</span> <span class="token function">touch</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> expiresAt<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token keyword">abstract</span> <span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token type">Iterable</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">>></span> <span class="token operator">|</span> <span class="token type">Iterable</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">;</span>

  clear<span class="token operator">?</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

  postConstruct<span class="token operator">?</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><p>For the source, all abstract methods must be implemented. All of the more complex logic is implemented in other methods within the base <code class="inline">CacheSource</code>.   The structure follows that of the javascript <code class="inline">Map</code> class for consistency. All that is needed is basic input/output support:</p>
<ul>
<li><code class="inline">get(key: string)</code> - Fetch entry from source, and return in the structure of an entry, ready to go</li>
<li><code class="inline">has(key: string)</code> - Indicates whether or not the key exists</li>
<li><code class="inline">set(key: string, entry: CacheEntry)</code> - Sources entry, given <code class="inline">key</code>.  </li>
<li><code class="inline">delete(key: string)</code> - Removes entry by key</li>
<li><code class="inline">isExpired(key: string)</code> - Determines if entry is expired</li>
<li><code class="inline">touch(key: string, expiresAt: number)</code> - Updates expiry information to date provided</li>
<li><code class="inline">keys()</code> - Returns list of all keys in the source</li>
</ul>
<p>Additionally, for setting/getting the burden is on the source author to properly serialize/deserialize as needed.  This is a low level detail and cannot be accounted for in a generic way.</p>
<app-section-header headerType="code">MemorySource</app-section-header>
<pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MemoryCacheSource</span> <span class="token keyword">extends</span> <span class="token class-name">CacheSource</span> <span class="token punctuation">{{ '{' }}</span>

  source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span> <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">{{ '}' }}</span>

  <span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">{{ '}' }}</span>

  <span class="token function">has</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token operator">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">{{ '}' }}</span>

  <span class="token keyword">delete</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">{{ '{' }}</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">{{ '}' }}</span>

  <span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">postLoad</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{ '}' }}</span>
  <span class="token punctuation">{{ '}' }}</span>

  <span class="token keyword">async</span> <span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> entry<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    entry <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prePersist</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">postLoad</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token punctuation">{{ '}' }}</span>

  <span class="token function">touch</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> expiresAt<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">.</span>expiresAt <span class="token operator">=</span> expiresAt<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{ '}' }}</span>

  <span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token operator">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
      <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>entry<span class="token punctuation">.</span>maxAge <span class="token operator">&amp;&amp;</span> entry<span class="token punctuation">.</span>expiresAt<span class="token operator">!</span> <span class="token operator">&lt;</span> <span class="token type">Date</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{ '}' }}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{ '}' }}</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><p>The memory source is simple but illustrates the structure well.</p>
</div>