<!-- This file was generated by @travetto/doc and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/main/module/cache/README.ts and execute "npx trv doc" to rebuild -->
<h1>Caching
          <small>Caching functionality with decorators for declarative use.</small>

        </h1>

      <figure class="install">
      <figcaption class="install">Install @travetto/cache
      
      </figcaption>
      <pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> @travetto/cache</code></pre>     
      </figure>

Provides a foundational structure for integrating caching at the method level.  This allows for easy extension with a variety of providers, and is usable with or without <a class="module-link" routerLink="/docs/di" title="Dependency registration/management and injection support.">Dependency Injection</a>.  The code aims to handle use cases surrounding common/basic usage.

The cache module requires an <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/model/src/service/expiry.ts#L11">Expiry</a> to provide functionality for reading and writing streams. You can use any existing providers to serve as your <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/model/src/service/expiry.ts#L11">Expiry</a>, or you can roll your own.

      <figure class="install">
      <figcaption class="install">provider
      
      </figcaption>
      <pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> @travetto/model-<span class="token punctuation">{{'{'}}</span>provider<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>

Currently, the following are packages that provide <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/model/src/service/expiry.ts#L11">Expiry</a>:
<ul> <li><a class="module-link" routerLink="/docs/model" title="Datastore abstraction for core operations.">Data Modeling Support</a> - @travetto/model: <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/model/src/provider/file.ts#L51">FileModelService</a>, <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/model/src/provider/memory.ts#L54">MemoryModelService</a></li>
 <li><a class="module-link" routerLink="/docs/model-dynamodb" title="DynamoDB backing for the travetto model module.">DynamoDB Model Support</a> - @travetto/model-dynamodb</li>
 <li><a class="module-link" routerLink="/docs/model-elasticsearch" title="Elasticsearch backing for the travetto model module, with real-time modeling support for Elasticsearch mappings.">Elasticsearch Model Source</a> - @travetto/model-elasticsearch</li>
 <li><a class="module-link" routerLink="/docs/model-mongo" title="Mongo backing for the travetto model module.">MongoDB Model Support</a> - @travetto/model-mongo</li>
 <li><a class="module-link" routerLink="/docs/model-redis" title="Redis backing for the travetto model module.">Redis Model Support</a> - @travetto/model-redis</li>
 <li><a class="module-link" routerLink="/docs/model-s3" title="S3 backing for the travetto model module.">S3 Model Support</a> - @travetto/model-s3</li>
 <li><a class="module-link" routerLink="/docs/model-postgres" title="PostgreSQL backing for the travetto model module, with real-time modeling support for SQL schemas.">PostgreSQL Model Service</a> - @travetto/model-postgres</li>
 <li><a class="module-link" routerLink="/docs/model-mysql" title="MySQL backing for the travetto model module, with real-time modeling support for SQL schemas.">MySQL Model Service</a> - @travetto/model-mysql</li>
 <li><a class="module-link" routerLink="/docs/model-sqlite" title="SQLite backing for the travetto model module, with real-time modeling support for SQL schemas.">SQLite Model Service</a> - @travetto/model-sqlite</li></ul>

<h2 id="decorators">Decorators</h2>
The caching framework provides method decorators that enables simple use cases.  One of the requirements to use the caching decorators is that the method arguments, and return values need to be serializable into <a target="_blank" class="external-link" href="https://www.json.org">JSON</a>.  Any other data types are not currently supported and would require either manual usage of the caching services directly, or specification of serialization/deserialization routines in the cache config.

Additionally, to use the decorators you will need to have a <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/cache/src/service.ts#L29">CacheService</a> object accessible on the class instance. This can be dependency injected, or manually constructed. The decorators will detect the field at time of method execution, which decouples construction of your class from the cache construction.

<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/cache/src/decorator.ts#L13">@Cache</a> is a decorator that will cache all successful results, keyed by a computation based on the method arguments.  Given the desire for supporting remote caches (e.g. <a target="_blank" class="external-link" href="https://redis.io">redis</a>, <a target="_blank" class="external-link" href="https://memcached.org">memcached</a>), only asynchronous methods are supported.

      <figure class="code">
      <figcaption class="code">Using decorators to cache expensive async call
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/cache/doc/async.ts">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> MemoryModelService <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/model'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Cache<span class="token punctuation">,</span> CacheService <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/cache'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token punctuation">{{'{'}}</span>
  <span class="token keyword">let</span> value<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">// ...fetch content</span>
  <span class="token keyword">return</span> value<span class="token operator">!</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Worker</span> <span class="token punctuation">{{'{'}}</span>

  myCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheService</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">MemoryModelService</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span> namespace<span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Cache</span></span><span class="token punctuation">(</span><span class="token string">'myCache'</span><span class="token punctuation">,</span> <span class="token string">'1s'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">calculateExpensiveResult</span><span class="token punctuation">(</span>expression<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://google.com?q=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${{'{'}}</span>expression<span class="token interpolation-punctuation punctuation">{{'}'}}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>

<h3 id="cache"><a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/cache/src/decorator.ts#L13">@Cache</a></h3>

The <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/cache/src/decorator.ts#L13">@Cache</a> decorator supports configurations on:

<ul> <li><code class="item input">name</code> the field name of the current class which points to the desired cache source.</li>
 <li><code class="item input">config</code> the additional/optional config options, on a per invocation basis <ul> <li><code class="item input">keySpace</code> the key space within the cache.  Defaults to class name plus method name.</li>
 <li><code class="item input">key</code> the function  will use the inputs to determine the cache key, defaults to all params <code class="item method">JSON.stringify</code>ied</li>
 <li><code class="item input">params</code> the function used to determine the inputs for computing the cache key.  This is an easier place to start to define what parameters are important in ,caching. This defaults to all inputs.</li>
 <li><code class="item input">maxAge</code> the number of milliseconds will hold the value before considering the cache entry to be invalid.  By default values will live infinitely.</li>
 <li><code class="item input">extendOnAccess</code> determines if the cache timeout should be extended on access.  This only applies to cache values that have specified a <code class="item input">maxAge</code>.</li>
 <li><code class="item input">serialize</code> the function to execute before storing a cacheable value.  This allows for any custom data modification needed to persist as a string properly.</li>
 <li><code class="item input">reinstate</code> the function to execute on return of a cached value.  This allows for any necessary operations to conform to expected output (e.g. re-establishing class instances, etc.).  This method should not be used often, as the return values of the methods should naturally serialize to/from <code class="item input">JSON</code> and the values should be usable either way.</li></ul></li></ul>

<h3 id="evictcache"><a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/cache/src/decorator.ts#L40">@EvictCache</a></h3>

Additionally, there is support for planned eviction via the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/cache/src/decorator.ts#L40">@EvictCache</a> decorator.  On successful execution of a method with this decorator, the matching keySpace/key value will be evicted from the cache.  This requires coordination between multiple methods, to use the same <code class="item input">keySpace</code> and <code class="item input">key</code> to compute the expected key.

      <figure class="code">
      <figcaption class="code">Using decorators to cache/evict user access
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/cache/doc/evict.ts">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> MemoryModelService <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/model'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Cache<span class="token punctuation">,</span> EvictCache<span class="token punctuation">,</span> CacheService <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/cache'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{{'{'}}</span> <span class="token punctuation">{{'}'}}</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{{'{'}}</span>

  myCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheService</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MemoryModelService</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span> namespace<span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  database<span class="token operator">:</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token function">lookupUser</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>User<span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token function">deleteUser</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token function">updateUser</span><span class="token punctuation">(</span>user<span class="token operator">:</span> User<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>User<span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Cache</span></span><span class="token punctuation">(</span><span class="token string">'myCache'</span><span class="token punctuation">,</span> <span class="token string">'5m'</span><span class="token punctuation">,</span> <span class="token punctuation">{{'{'}}</span> keySpace<span class="token operator">:</span> <span class="token string">'user.id'</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">getUser</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>User<span class="token operator">></span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>database<span class="token punctuation">.</span><span class="token function">lookupUser</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">EvictCache</span></span><span class="token punctuation">(</span><span class="token string">'myCache'</span><span class="token punctuation">,</span> <span class="token punctuation">{{'{'}}</span> keySpace<span class="token operator">:</span> <span class="token string">'user.id'</span><span class="token punctuation">,</span> <span class="token function-variable function">params</span><span class="token operator">:</span> user <span class="token operator">=></span> <span class="token punctuation">[</span>user<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">updateUser</span><span class="token punctuation">(</span>user<span class="token operator">:</span> User<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>database<span class="token punctuation">.</span><span class="token function">updateUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">EvictCache</span></span><span class="token punctuation">(</span><span class="token string">'myCache'</span><span class="token punctuation">,</span> <span class="token punctuation">{{'{'}}</span> keySpace<span class="token operator">:</span> <span class="token string">'user.id'</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">deleteUser</span><span class="token punctuation">(</span>userId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>database<span class="token punctuation">.</span><span class="token function">deleteUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>

<h2 id="extending-the-cache-service">Extending the Cache Service</h2>

By design, the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/cache/src/service.ts#L29">CacheService</a> relies solely on the <a class="module-link" routerLink="/docs/model" title="Datastore abstraction for core operations.">Data Modeling Support</a> module.  Specifically on the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/model/src/service/expiry.ts#L11">Expiry</a>.   This combines basic support for CRUD as well as knowledge of how to manage expirable content.  Any model service that honors these contracts is a valid candidate to power the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/cache/src/service.ts#L29">CacheService</a>.  The <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/cache/src/service.ts#L29">CacheService</a> is expecting the model service to be registered using the @travetto/cache:model:

      <figure class="code">
      <figcaption class="code">Registering a Custom Model Source
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/cache/doc/custom.ts">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> InjectableFactory <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/di'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> ModelExpirySupport <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/model'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> CacheModelⲐ <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/cache'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">InjectableFactory</span></span><span class="token punctuation">(</span>CacheModelⲐ<span class="token punctuation">)</span>
  <span class="token keyword">static</span> <span class="token function">getModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ModelExpirySupport <span class="token punctuation">{{'{'}}</span>
    <span class="token comment">// @ts-expect-error</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CustomAwesomeModelService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span>

<span class="token comment">// @ts-expect-error</span>
<span class="token keyword">class</span> <span class="token class-name">CustomAwesomeModelService</span> <span class="token keyword">implements</span> <span class="token class-name">ModelExpirySupport</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">// Implement all the things</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>
