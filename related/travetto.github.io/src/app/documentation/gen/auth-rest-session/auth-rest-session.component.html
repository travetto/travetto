<!-- This file was generated by @travetto/doc and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/main/module/auth-rest-session/DOC.ts and execute "npx trv doc" to rebuild -->
<h1>Rest Auth Session
          <small>Rest authentication session integration support for the Travetto framework</small>

        </h1>

      <figure class="install">
      <figcaption class="install">Install @travetto/auth-rest-session
      
      </figcaption>
      <pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> @travetto/auth-rest-session

<span class="token comment"># or</span>

<span class="token function">yarn</span> <span class="token function">add</span> @travetto/auth-rest-session</code></pre>     
      </figure>

One of <a class="module-link" routerLink="/docs/auth-rest" title="Rest authentication integration support for the Travetto framework">Rest Auth</a>'s main responsibilities is being able to send and receive authentication/authorization information from the client.  This data can be encoded in many different forms, and this module provides the ability to encode into and decode from the user's <a class="module-link" routerLink="/docs/rest-session" title="Session provider for the travetto rest module.">REST Session</a> context. This module fulfills the contract required by <a class="module-link" routerLink="/docs/auth-rest" title="Rest authentication integration support for the Travetto framework">Rest Auth</a> of being able to encode and decode a user principal by storing the user principal in the session.

The <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth-rest-session/src/principal-encoder.ts#L12">SessionPrincipalEncoder</a> is exposed as a tool for allowing for decoding/encoding principals into the session. 

      <figure class="code">
      <figcaption class="code">SessionPrincipalEncoder
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/auth-rest-session/src/principal-encoder.ts">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Injectable<span class="token punctuation">,</span> Inject <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/di'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> FilterContext <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/rest'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Principal <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/auth'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> PrincipalEncoder <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/auth-rest'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> SessionService <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/rest-session'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Integration with the auth module, using the session as a backing
 * store for the auth principal.
 */</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SessionPrincipalEncoder</span> <span class="token keyword">implements</span> <span class="token class-name">PrincipalEncoder</span> <span class="token punctuation">{{'{'}}</span>
  #key <span class="token operator">=</span> <span class="token string">'_trv_auth_principal'</span><span class="token punctuation">;</span> <span class="token comment">// Must be serializable, so it cannot be a symbol</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  service<span class="token operator">:</span> SessionService<span class="token punctuation">;</span>

  <span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span> req <span class="token punctuation">{{'}'}}</span><span class="token operator">:</span> FilterContext<span class="token punctuation">,</span> p<span class="token operator">:</span> Principal<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
      p<span class="token punctuation">.</span>expiresAt <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>expiresAt<span class="token punctuation">;</span> <span class="token comment">// Let principal live as long as the session</span>
      req<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#key<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{'}'}}</span> <span class="token keyword">else</span> <span class="token punctuation">{{'{'}}</span>
      req<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Kill session</span>
    <span class="token punctuation">{{'}'}}</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token keyword">async</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span> req <span class="token punctuation">{{'}'}}</span><span class="token operator">:</span> FilterContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Principal <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">></span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">readRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Preload session if not already loaded</span>
    <span class="token keyword">return</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">getValue</span><span class="token generic class-name"><span class="token operator">&lt;</span>Principal<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>

As you can see, encode and decode just read and write from the session context.  The main feature here, is that if the authentication expires, the session should be destroyed.  Additionally, the user's expiry time is assumed to live as long as the session for simplicity's sake.
