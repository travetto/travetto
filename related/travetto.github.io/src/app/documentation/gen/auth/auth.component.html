<div class="documentation">
<h1>Authentication
          <small>Authentication scaffolding for the travetto framework</small>

        </h1>

      <figure class="install">
      <figcaption class="install">Install @travetto/auth
      
      </figcaption>
      <pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> @travetto/auth</code></pre>     
      </figure>

This module provides the high-level backdrop for managing security principals.  The goal of this module is to be a centralized location for various security frameworks to plug into.  The primary contributions are:

<ul> <li>Interfaces for standard security primitive</li>
 <li>Patterns for producing a <a target="_blank" class="source-link" href="./src/types.ts#L4">Principal</a></li>
 <li>Common security-related utilities for <ul> <li>Checking permissions</li>
 <li>Generating passwords</li></ul></li></ul>

<h2>Interfaces / Primitives</h2>
The module's goal is to be as flexible as possible.  To that end, the primary contract that this module defines, is that of the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/1.0.0-docs-overhaul/module/auth/src/context.ts#L11">AuthContext</a>.

      <figure class="code">
      <figcaption class="code">Auth context structure
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/1.0.0-docs-overhaul/module/auth/src/context.ts">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> AppError <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/base'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> AuthUtil <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'./util'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Principal<span class="token punctuation">,</span> Identity <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'./types'</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * Combination of an identity and a principal, to be used for
 * authorizing. Provides simple access to permissions and
 * additional principal details.
 */</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthContext</span><span class="token operator">&lt;</span>
  <span class="token constant">U</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
  <span class="token constant">I</span> <span class="token keyword">extends</span> <span class="token class-name">Identity</span> <span class="token operator">=</span> Identity<span class="token punctuation">,</span>
  <span class="token constant">P</span> <span class="token keyword">extends</span> <span class="token class-name">Principal</span> <span class="token operator">=</span> Principal<span class="token operator">></span> <span class="token punctuation">{{'{'}}</span>
  <span class="token keyword">private</span> permsSet<span class="token operator">:</span> Set<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> permsArr<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Identity of the context
   */</span>
  <span class="token keyword">public</span> identity<span class="token operator">:</span> <span class="token constant">I</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * The principal of the context
   */</span>
  <span class="token keyword">public</span> principal<span class="token operator">:</span> <span class="token constant">P</span><span class="token punctuation">;</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>identity<span class="token operator">:</span> <span class="token constant">I</span><span class="token punctuation">,</span> principal<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">P</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token comment">/**
   * Get the principal/identity id
   */</span>
  <span class="token keyword">get</span> <span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token comment">/**
   * Get list of permissions
   */</span>
  <span class="token keyword">get</span> <span class="token function">permissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Readonly<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">;</span>
  <span class="token comment">/**
   * Set list of permissions
   */</span>
  <span class="token keyword">set</span> <span class="token function">permissions</span><span class="token punctuation">(</span>perms<span class="token operator">:</span> Readonly<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token comment">/**
   * Get permissions as a set
   */</span>
  <span class="token keyword">get</span> <span class="token function">permissionSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ReadonlySet<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token punctuation">;</span>
  <span class="token comment">/**
   * Get principal's details
   */</span>
  <span class="token keyword">get</span> <span class="token function">principalDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token comment">/**
   * Set principal's details
   * @param details Details to set
   */</span>
  <span class="token keyword">set</span> <span class="token function">principalDetails</span><span class="token punctuation">(</span>details<span class="token operator">:</span> <span class="token constant">U</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token comment">/**
   * Update the principal's details
   * @param details Details to update
   */</span>
  <span class="token function">updatePrincipalDetails</span><span class="token punctuation">(</span>details<span class="token operator">:</span> <span class="token constant">U</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token comment">/**
   * Check permissions for a given principal
   *
   * @param include The list of permissions that should be included.
   * @param exclude The list of permissions that should be excluded.
   * @param matchAll Do all permissions need to be matched or any?
   */</span>
  <span class="token function">checkPermissions</span><span class="token punctuation">(</span>include<span class="token operator">:</span> Iterable<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">,</span> exclude<span class="token operator">:</span> Iterable<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">,</span> mode<span class="token operator">:</span> <span class="token string">'all'</span> <span class="token operator">|</span> <span class="token string">'any'</span> <span class="token operator">=</span> <span class="token string">'any'</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>

As referenced above, a <a target="_blank" class="source-link" href="./src/types.ts#L4">Principal</a> is defined as a user with respect to a security context.  This is generally understood to be the information that the application knows about a user, specifically the configuration the application has about a user.

Comparatively, <a target="_blank" class="source-link" href="./src/types.ts#L26">Identity</a> is defined as an authenticated user session that can be provided by the application or derived from some other source.  In simpler systems the identity will be equal to the principal, but in systems where you support 3rd party logins (e.g. Google/Facebook/Twitter/etc.) your identity will be external to the system.

Overall, the structure is simple, but drives home the primary use cases of the framework.  The goals are:
<ul> <li>Be able to identify a user uniquely</li>
 <li>To have a reference to a user's set of permissions</li>
 <li>To have access to the raw principal</li>
 <li>To have access to the raw identity</li></ul>

<h2>Customization</h2>
By default, the module does not provide an implementation for the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/1.0.0-docs-overhaul/module/auth/src/principal.ts#L9">PrincipalSource</a>. By default the structure of the provider can be boiled down to:

      <figure class="code">
      <figcaption class="code">Principal Source
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/1.0.0-docs-overhaul/module/auth/src/principal.ts">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> AppError <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/base'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Identity<span class="token punctuation">,</span> Principal <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'./types'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> AuthContext <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'./context'</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * Produces a principal from an identity
 */</span>
<span class="token keyword">export</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">PrincipalSource</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Optional ability to create a principal as opposed to just reading
   * @param principal The principal to create
   */</span>
  createPrincipal<span class="token operator">?</span><span class="token punctuation">(</span>principal<span class="token operator">:</span> Principal<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Principal<span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Authorizes an identity to produce an AuthContext
   * @param ident The identity to authorize
   */</span>
  <span class="token keyword">async</span> <span class="token function">authorize</span><span class="token punctuation">(</span>ident<span class="token operator">:</span> Identity<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>AuthContext<span class="token operator">></span> <span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>

The provider only requires one method to be defined, and that is <code class="item method">resolvePrincipal</code>.  This method receives an identity as an input, and is responsible for converting that to a principal (external user to internal user).  If you want to be able to auto-provision users from a remote source, you can set <code class="item input">autoCreate</code> to <code class="item input">true</code>, and supply <code class="item method">createPrincipal</code>'s functionality for storing the user as well.

The <a class="module-link" href="/docs/auth-model" title="Model-based authentication and registration support for the travetto framework">Model Auth Source</a> module is a good example of a principal provider that is also an identity source.  This is a common use case for simple internal auth.

<h2>Common Utilities</h2>
The <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/1.0.0-docs-overhaul/module/auth/src/util.ts#L18">AuthUtil</a> provides the following functionality:

      <figure class="code">
      <figcaption class="code">Auth util structure
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/1.0.0-docs-overhaul/module/auth/src/util.ts">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> crypto <span class="token keyword">from</span> <span class="token string">'crypto'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> util <span class="token keyword">from</span> <span class="token string">'util'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Util<span class="token punctuation">,</span> AppError <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/base'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pbkdf2 <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>crypto<span class="token punctuation">.</span>pbkdf2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">type</span> PermSet <span class="token operator">=</span> Set<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token operator">|</span> ReadonlySet<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token keyword">type</span> PermissionChecker <span class="token operator">=</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token function-variable function">all</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">perms<span class="token operator">:</span> PermSet</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token function-variable function">any</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">perms<span class="token operator">:</span> PermSet</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * Standard auth utilities
 */</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthUtil</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token constant">CHECK_EXC_CACHE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> PermissionChecker<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token constant">CHECK_INC_CACHE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> PermissionChecker<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Build a permission checker against the provided permissions
   *
   * @param perms Set of permissions to check
   * @param defaultIfEmpty If no perms passed, default to empty
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">buildChecker</span><span class="token punctuation">(</span>perms<span class="token operator">:</span> Iterable<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">,</span> defaultIfEmpty<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> PermissionChecker <span class="token punctuation">;</span>
  <span class="token comment">/**
   * Generate a hash for a given value
   *
   * @param value Value to hash
   * @param salt The salt value
   * @param iterations Number of iterations on hashing
   * @param keylen Length of hash
   * @param digest Digest method
   */</span>
  <span class="token keyword">static</span> <span class="token function">generateHash</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> salt<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> iterations <span class="token operator">=</span> <span class="token number">25000</span><span class="token punctuation">,</span> keylen <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">,</span> digest <span class="token operator">=</span> <span class="token string">'sha256'</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token comment">/**
   * Generate a salted password, with the ability to validate the password
   *
   * @param password
   * @param saltLen Length of salt
   * @param validator Optional function to validate your password
   */</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">generatePassword</span><span class="token punctuation">(</span>password<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> saltLen <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token comment">/**
   * Build a permission checker off of an include, and exclude set
   *
   * @param include Which permissions to include
   * @param exclude Which permissions to exclude
   * @param matchAll Whether not all permissions should be matched
   */</span>
  <span class="token keyword">static</span> <span class="token function">permissionSetChecker</span><span class="token punctuation">(</span>include<span class="token operator">:</span> Iterable<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">,</span> exclude<span class="token operator">:</span> Iterable<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">,</span> mode<span class="token operator">:</span> <span class="token string">'all'</span> <span class="token operator">|</span> <span class="token string">'any'</span> <span class="token operator">=</span> <span class="token string">'any'</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>

<code class="item method">permissionSetChecker</code> is probably the only functionality that needs to be explained. The function operates in a <code class="item input">DENY</code> / <code class="item input">ALLOW</code> mode.  This means that a permission check will succeed only if:

<ul> <li>The user is logged in  <ul> <li>If <code class="item input">matchAll</code> is false: <ul> <li>The user does not have any permissions in the exclusion list</li>
 <li>The include list is empty, or the user has at least one permission in the include list.</li></ul></li>
 <li>Else <ul> <li>The user does not have all permissions in the exclusion list</li>
 <li>The include list is empty, or the user has all permissions in the include list.</li></ul></li></ul></li></ul>
</div>