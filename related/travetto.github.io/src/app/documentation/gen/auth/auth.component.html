<!-- This file was generated by @travetto/doc and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/master/module/auth/doc.ts and execute "npx trv doc" to rebuild -->
<div class="documentation">
<h1>Authentication
          <small>Authentication scaffolding for the travetto framework</small>

        </h1>

      <figure class="install">
      <figcaption class="install">Install @travetto/auth
      
      </figcaption>
      <pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> @travetto/auth</code></pre>     
      </figure>

This module provides the high-level backdrop for managing security principals.  The goal of this module is to be a centralized location for various security frameworks to plug into.  The primary contributions are:

<ul> <li>Standard Types</li>
 <li>Authentication Contract</li>
 <li>Authorization Contract</li>
 <li>Common security-related utilities for <ul> <li>Checking permissions</li>
 <li>Generating passwords</li></ul></li></ul>

<h2 id="standard-types">Standard Types</h2>
The module's goal is to be as flexible as possible.  To that end, the primary contract that this module defines, is that of the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/master/module/auth/src/types/principal.ts#L8">Principal Structure</a>.

      <figure class="code">
      <figcaption class="code">Principal Structure
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/master/module/auth/src/types/principal.ts#L8">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Principal<span class="token operator">&lt;</span><span class="token constant">D</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">></span></span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Primary identifier for a user
   */</span>
  id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Date of expiration
   */</span>
  expiresAt<span class="token operator">?</span><span class="token operator">:</span> Date<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Date of issuance
   */</span>
  issuedAt<span class="token operator">?</span><span class="token operator">:</span> Date<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Max age in seconds a principal is valid
   */</span>
  maxAge<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * The source of the issuance
   */</span>
  issuer<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Supplemental details
   */</span>
  details<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">D</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * List of all provided permissions
   */</span>
  permissions<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>

As referenced above, a <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/master/module/auth/src/types/principal.ts#L8">Principal Structure</a> is defined as a user with respect to a security context. This can be information the application knows about the user (authorized) or what a separate service may know about a user (3rd-party authenticatino).

<h2 id="authentication">Authentication</h2>

      <figure class="code">
      <figcaption class="code">Authenticator
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/master/module/auth/src/types/authenticator.ts#L8">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Authenticator<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span> <span class="token constant">P</span> <span class="token keyword">extends</span> Principal <span class="token operator">=</span> Principal<span class="token punctuation">,</span> <span class="token constant">C</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token operator">></span></span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Verify the payload, verifying the payload is correctly identified.
   * @returns Valid principal if authenticated
   * @returns undefined if authentication is valid, but incomplete (multi-step)
   * @throws AppError if authentication fails
   */</span>
  <span class="token function">authenticate</span><span class="token punctuation">(</span>payload<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> ctx<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">P</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token constant">P</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>

The <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/master/module/auth/src/types/authenticator.ts#L8">Authenticator</a> only requires one method to be defined, and that is <code class="item method">authenticate</code>. This method receives a generic payload, and a supplemental context as an input. The interface is respon for converting that to an authenticated principal.

<h3 id="example">Example</h3>
The <a class="module-link" routerLink="/docs/jwt" title="JSON Web Token implementation">JWT</a> module is a good example of an authenticator. This is a common use case for simple internal auth.

<h2 id="authorization">Authorization</h2>

      <figure class="code">
      <figcaption class="code">Authorizer
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/master/module/auth/src/types/authorizer.ts#L8">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Authorizer<span class="token operator">&lt;</span><span class="token constant">P</span> <span class="token keyword">extends</span> Principal <span class="token operator">=</span> Principal<span class="token operator">></span></span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Authorize inbound principal, verifying it's permission to access the system.
   * @param principal
   * @returns New principal that conforms to the required principal shape
   */</span>
  <span class="token function">authorize</span><span class="token punctuation">(</span>principal<span class="token operator">:</span> Principal<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">P</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token constant">P</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>
Authorizers are generally seen as a secondary step post-authentication. Authentication acts as a very basic form of authorization, assuming the principal store is owned by the application.

The <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/master/module/auth/src/types/authorizer.ts#L8">Authorizer</a> only requires one method to be defined, and that is <code class="item method">authorizer</code>. This method receives an authenticated principal as an input, and is responsible for converting that to an authorized principal.

<h3 id="example">Example</h3>
The <a class="module-link" routerLink="/docs/model" title="Datastore abstraction for core operations.">Data Modeling Support</a> extension is a good example of an authenticator. This is a common use case for simple internal auth.

Overall, the structure is simple, but drives home the primary use cases of the framework. The goals are:
<ul> <li>Be able to identify a user uniquely</li>
 <li>To have a reference to a user's set of permissions</li>
 <li>To have access to the principal</li></ul>

<h2 id="common-utilities">Common Utilities</h2>
The <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/master/module/auth/src/util.ts#L18">AuthUtil</a> provides the following functionality:

      <figure class="code">
      <figcaption class="code">Auth util structure
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/master/module/auth/src/util.ts">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> crypto <span class="token keyword">from</span> <span class="token string">'crypto'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> util <span class="token keyword">from</span> <span class="token string">'util'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> AppError<span class="token punctuation">,</span> Util <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/base'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pbkdf2 <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>crypto<span class="token punctuation">.</span>pbkdf2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">type</span> <span class="token class-name">PermSet</span> <span class="token operator">=</span> Set<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token operator">|</span> ReadonlySet<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token keyword">type</span> <span class="token class-name">PermissionChecker</span> <span class="token operator">=</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token function-variable function">all</span><span class="token operator">:</span> <span class="token punctuation">(</span>perms<span class="token operator">:</span> PermSet<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token function-variable function">any</span><span class="token operator">:</span> <span class="token punctuation">(</span>perms<span class="token operator">:</span> PermSet<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * Standard auth utilities
 */</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthUtil</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Build a permission checker against the provided permissions
   *
   * @param perms Set of permissions to check
   * @param defaultIfEmpty If no perms passed, default to empty
   */</span>
  <span class="token comment">/**
   * Build a permission checker off of an include, and exclude set
   *
   * @param include Which permissions to include
   * @param exclude Which permissions to exclude
   * @param matchAll Whether not all permissions should be matched
   */</span>
  <span class="token keyword">static</span> <span class="token function">permissionChecker</span><span class="token punctuation">(</span>include<span class="token operator">:</span> Iterable<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">,</span> exclude<span class="token operator">:</span> Iterable<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">,</span> mode<span class="token operator">:</span> <span class="token string">'all'</span> <span class="token operator">|</span> <span class="token string">'any'</span> <span class="token operator">=</span> <span class="token string">'any'</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token comment">/**
   * Build a permission checker off of an include, and exclude set
   *
   * @param include Which permissions to include
   * @param exclude Which permissions to exclude
   * @param matchAll Whether not all permissions should be matched
   */</span>
  <span class="token keyword">static</span> <span class="token function">checkPermissions</span><span class="token punctuation">(</span>permissions<span class="token operator">:</span> Iterable<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">,</span> include<span class="token operator">:</span> Iterable<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">,</span> exclude<span class="token operator">:</span> Iterable<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">,</span> mode<span class="token operator">:</span> <span class="token string">'all'</span> <span class="token operator">|</span> <span class="token string">'any'</span> <span class="token operator">=</span> <span class="token string">'any'</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token comment">/**
   * Generate a hash for a given value
   *
   * @param value Value to hash
   * @param salt The salt value
   * @param iterations Number of iterations on hashing
   * @param keylen Length of hash
   * @param digest Digest method
   */</span>
  <span class="token keyword">static</span> <span class="token function">generateHash</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> salt<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> iterations <span class="token operator">=</span> <span class="token number">25000</span><span class="token punctuation">,</span> keylen <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">,</span> digest <span class="token operator">=</span> <span class="token string">'sha256'</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token comment">/**
   * Generate a salted password, with the ability to validate the password
   *
   * @param password
   * @param salt Salt value, or if a number, length of salt
   * @param validator Optional function to validate your password
   */</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">generatePassword</span><span class="token punctuation">(</span>password<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> salt<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>

<code class="item method">permissionSetChecker</code> is probably the only functionality that needs to be explained.The function operates in a <code class="item input">DENY</code> / <code class="item input">ALLOW</code> mode.  This means that a permission check will succeed only if:

<ul> <li>The user is logged in  <ul> <li>If <code class="item input">matchAll</code> is false: <ul> <li>The user does not have any permissions in the exclusion list</li>
 <li>The include list is empty, or the user has at least one permission in the include list.</li></ul></li>
 <li>Else <ul> <li>The user does not have all permissions in the exclusion list</li>
 <li>The include list is empty, or the user has all permissions in the include list.</li></ul></li></ul></li></ul> 

<h2 id="extension-model">Extension - Model</h2>

This module also supports the integration between the <a class="module-link" routerLink="/docs/auth" title="Authentication scaffolding for the travetto framework">Authentication</a> module and the <a class="module-link" routerLink="/docs/model" title="Datastore abstraction for core operations.">Data Modeling Support</a>. 

The asset module requires an <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/master/module/model/src/service/crud.ts#L11">CRUD</a> to provide functionality for reading and storing user information. You can use any existing providers to serve as your <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/master/module/model/src/service/crud.ts#L11">CRUD</a>, or you can roll your own.

      <figure class="install">
      <figcaption class="install">provider
      
      </figcaption>
      <pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> @travetto/model-<span class="token punctuation">{{'{'}}</span>provider<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>

Currently, the following are packages that provide <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/master/module/model/src/service/crud.ts#L11">CRUD</a>:
<ul> <li><a class="module-link" routerLink="/docs/model-dynamodb" title="DynamoDB backing for the travetto model module.">DynamoDB Model Support</a> - @travetto/model-dynamodb</li>
 <li><a class="module-link" routerLink="/docs/model-elasticsearch" title="Elasticsearch backing for the travetto model module, with real-time modeling support for Elasticsearch mappings.">Elasticsearch Model Source</a> @travetto/model-elasticsearch</li>
 <li><a class="module-link" routerLink="/docs/model-firestore" title="Firestore backing for the travetto model module.">Firestore Model Support</a> @travetto/model-firestore</li>
 <li><a class="module-link" routerLink="/docs/model-mongo" title="Mongo backing for the travetto model module.">MongoDB Model Support</a> @travetto/model-mongo</li>
 <li><a class="module-link" routerLink="/docs/model-redis" title="Redis backing for the travetto model module.">Redis Model Support</a> @travetto/model-redis</li>
 <li><a class="module-link" routerLink="/docs/model-s3" title="S3 backing for the travetto model module.">S3 Model Support</a> @travetto/model-s3</li>
 <li><a class="module-link" routerLink="/docs/model-sql" title="SQL backing for the travetto model module, with real-time modeling support for SQL schemas.">SQL Model Service</a> @travetto/model-sql</li></ul>

The module itself is fairly straightforward, and truly the only integration point for this module to work is defined at the model level.  The contract for authentication is established in code as providing translation to and from a <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/master/module/auth/src/extension/model.ts#L16">Registered Principal</a>

A registered principal extends the base concept of an principal, by adding in additional fields needed for local registration, specifically password management information.

      <figure class="code">
      <figcaption class="code">Registered Principal
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/master/module/auth/src/extension/model.ts#L16">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">RegisteredPrincipal</span> <span class="token keyword">extends</span> <span class="token class-name">Principal</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Password hash
   */</span>
  hash<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Password salt
   */</span>
  salt<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Temporary Reset Token
   */</span>
  resetToken<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * End date for the reset token
   */</span>
  resetExpires<span class="token operator">?</span><span class="token operator">:</span> Date<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The actual password, only used on password set/update
   */</span>
  password<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>

      <figure class="code">
      <figcaption class="code">A valid user model
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/master/module/auth/doc/model/model.ts">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Model<span class="token punctuation">,</span> BaseModel <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/model'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> RegisteredPrincipal <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/auth'</span><span class="token punctuation">;</span>

@<span class="token meta">Model</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">BaseModel</span> <span class="token keyword">implements</span> <span class="token class-name">RegisteredPrincipal</span> <span class="token punctuation">{{'{'}}</span>
  source<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  details<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">></span><span class="token punctuation">;</span>
  password<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  salt<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  hash<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  resetToken<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  resetExpires<span class="token operator">?</span><span class="token operator">:</span> Date<span class="token punctuation">;</span>
  permissions<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>

<h2 id="configuration">Configuration</h2>

Additionally, there exists a common practice of mapping various external security principals into a local contract. These external identities, as provided from countless authentication schemes, need to be homogeonized for use.  This has been handled in other frameworks by using external configuration, and creating a mapping between the two set of fields.  Within this module, the mappings are defined as functions in which you can translate to the model from an identity or to an identity from a model.

      <figure class="code">
      <figcaption class="code">Principal Source configuration
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/master/module/auth/doc/model/config.ts">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> InjectableFactory <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/di'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> ModelAuthService<span class="token punctuation">,</span> RegisteredPrincipal <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/auth'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> ModelCrudSupport <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/model'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> User <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'./model'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">AuthConfig</span> <span class="token punctuation">{{'{'}}</span>
  @<span class="token meta">InjectableFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">static</span> <span class="token function">getModelAuthService</span><span class="token punctuation">(</span>svc<span class="token operator">:</span> ModelCrudSupport<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ModelAuthService</span><span class="token punctuation">(</span>
      svc<span class="token punctuation">,</span>
      User<span class="token punctuation">,</span>
      <span class="token punctuation">(</span>u<span class="token operator">:</span> User<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span>    <span class="token comment">// This converts User to a RegisteredPrincipal</span>
        source<span class="token operator">:</span> <span class="token string">'model'</span><span class="token punctuation">,</span>
        provider<span class="token operator">:</span> <span class="token string">'model'</span><span class="token punctuation">,</span>
        id<span class="token operator">:</span> u<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        permissions<span class="token operator">:</span> u<span class="token punctuation">.</span>permissions<span class="token punctuation">,</span>
        hash<span class="token operator">:</span> u<span class="token punctuation">.</span>hash<span class="token punctuation">,</span>
        salt<span class="token operator">:</span> u<span class="token punctuation">.</span>salt<span class="token punctuation">,</span>
        resetToken<span class="token operator">:</span> u<span class="token punctuation">.</span>resetToken<span class="token punctuation">,</span>
        resetExpires<span class="token operator">:</span> u<span class="token punctuation">.</span>resetExpires<span class="token punctuation">,</span>
        password<span class="token operator">:</span> u<span class="token punctuation">.</span>password<span class="token punctuation">,</span>
        details<span class="token operator">:</span> u<span class="token punctuation">,</span>
      <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span>u<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>RegisteredPrincipal<span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">=></span> User<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span>   <span class="token comment">// This converts a RegisteredPrincipal to a User</span>
        id<span class="token operator">:</span> u<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        permissions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>permissions <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        hash<span class="token operator">:</span> u<span class="token punctuation">.</span>hash<span class="token punctuation">,</span>
        salt<span class="token operator">:</span> u<span class="token punctuation">.</span>salt<span class="token punctuation">,</span>
        resetToken<span class="token operator">:</span> u<span class="token punctuation">.</span>resetToken<span class="token punctuation">,</span>
        resetExpires<span class="token operator">:</span> u<span class="token punctuation">.</span>resetExpires<span class="token punctuation">,</span>
      <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>

      <figure class="code">
      <figcaption class="code">Sample usage
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/master/module/auth/doc/model/usage.ts">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> AppError <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/base'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Injectable<span class="token punctuation">,</span> Inject <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/di'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> ModelAuthService <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/auth'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> User <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'./model'</span><span class="token punctuation">;</span>

@<span class="token meta">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{{'{'}}</span>

  @<span class="token meta">Inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> auth<span class="token operator">:</span> ModelAuthService<span class="token operator">&lt;</span>User<span class="token operator">></span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>identity<span class="token operator">:</span> User<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{{'{'}}</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>identity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{'}'}}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token keyword">instanceof</span> <span class="token class-name">AppError</span> <span class="token operator">&amp;&amp;</span> err<span class="token punctuation">.</span>category <span class="token operator">===</span> <span class="token string">'notfound'</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>identity<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">{{'}'}}</span> <span class="token keyword">else</span> <span class="token punctuation">{{'{'}}</span>
        <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
      <span class="token punctuation">{{'}'}}</span>
    <span class="token punctuation">{{'}'}}</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>
</div>
