<!-- This file was generated by @travetto/doc and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/main/module/auth-model/doc.ts and execute "npx trv doc" to rebuild -->
<h1>Authentication Model
          <small>Authentication model support for the travetto framework</small>

        </h1>

      <figure class="install">
      <figcaption class="install">Install @travetto/auth-model
      
      </figcaption>
      <pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> @travetto/auth-model</code></pre>     
      </figure>

This module supports the integration between the <a class="module-link" routerLink="/docs/auth" title="Authentication scaffolding for the travetto framework">Authentication</a> module and the <a class="module-link" routerLink="/docs/model" title="Datastore abstraction for core operations.">Data Modeling Support</a>. 

The asset module requires a <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/model/src/service/crud.ts#L11">CRUD</a>-model to provide functionality for reading and storing user information. You can use any existing providers to serve as your <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/model/src/service/crud.ts#L11">CRUD</a>, or you can roll your own.

      <figure class="install">
      <figcaption class="install">provider
      
      </figcaption>
      <pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> @travetto/model-<span class="token punctuation">{{'{'}}</span>provider<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>

Currently, the following are packages that provide <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/model/src/service/crud.ts#L11">CRUD</a>:
<ul> <li><a class="module-link" routerLink="/docs/model-dynamodb" title="DynamoDB backing for the travetto model module.">DynamoDB Model Support</a> - @travetto/model-dynamodb</li>
 <li><a class="module-link" routerLink="/docs/model-elasticsearch" title="Elasticsearch backing for the travetto model module, with real-time modeling support for Elasticsearch mappings.">Elasticsearch Model Source</a> @travetto/model-elasticsearch</li>
 <li><a class="module-link" routerLink="/docs/model-firestore" title="Firestore backing for the travetto model module.">Firestore Model Support</a> @travetto/model-firestore</li>
 <li><a class="module-link" routerLink="/docs/model-mongo" title="Mongo backing for the travetto model module.">MongoDB Model Support</a> @travetto/model-mongo</li>
 <li><a class="module-link" routerLink="/docs/model-redis" title="Redis backing for the travetto model module.">Redis Model Support</a> @travetto/model-redis</li>
 <li><a class="module-link" routerLink="/docs/model-s3" title="S3 backing for the travetto model module.">S3 Model Support</a> @travetto/model-s3</li>
 <li><a class="module-link" routerLink="/docs/model-mysql" title="MySQL backing for the travetto model module, with real-time modeling support for SQL schemas.">MySQL Model Service</a> @travetto/model-mysql</li>
 <li><a class="module-link" routerLink="/docs/model-postgres" title="PostgreSQL backing for the travetto model module, with real-time modeling support for SQL schemas.">PostgreSQL Model Service</a> @travetto/model-postgres</li>
 <li><a class="module-link" routerLink="/docs/model-sqlite" title="SQLite backing for the travetto model module, with real-time modeling support for SQL schemas.">SQLite Model Service</a> @travetto/model-sqlite</li></ul>

The module itself is fairly straightforward, and truly the only integration point for this module to work is defined at the model level.  The contract for authentication is established in code as providing translation to and from a <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth-model/src/model.ts#L10">Registered Principal</a>

A registered principal extends the base concept of an principal, by adding in additional fields needed for local registration, specifically password management information.

      <figure class="code">
      <figcaption class="code">Registered Principal
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/auth-model/src/model.ts#L10">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">RegisteredPrincipal</span> <span class="token keyword">extends</span> <span class="token class-name">Principal</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Password hash
   */</span>
  hash<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Password salt
   */</span>
  salt<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Temporary Reset Token
   */</span>
  resetToken<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * End date for the reset token
   */</span>
  resetExpires<span class="token operator">?</span><span class="token operator">:</span> Date<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The actual password, only used on password set/update
   */</span>
  password<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>

      <figure class="code">
      <figcaption class="code">A valid user model
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/auth-model/doc/model.ts">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Model <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/model'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> RegisteredPrincipal <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/auth-model'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Model</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">implements</span> <span class="token class-name">RegisteredPrincipal</span> <span class="token punctuation">{{'{'}}</span>
  id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  source<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  details<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">></span><span class="token punctuation">;</span>
  password<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  salt<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  hash<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  resetToken<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  resetExpires<span class="token operator">?</span><span class="token operator">:</span> Date<span class="token punctuation">;</span>
  permissions<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>

<h2 id="configuration">Configuration</h2>

Additionally, there exists a common practice of mapping various external security principals into a local contract. These external identities, as provided from countless authentication schemes, need to be homogenized for use.  This has been handled in other frameworks by using external configuration, and creating a mapping between the two set of fields.  Within this module, the mappings are defined as functions in which you can translate to the model from an identity or to an identity from a model.

      <figure class="code">
      <figcaption class="code">Principal Source configuration
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/auth-model/doc/config.ts">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> InjectableFactory <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/di'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> ModelAuthService<span class="token punctuation">,</span> RegisteredPrincipal <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/auth-model'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> ModelCrudSupport <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/model'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> User <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'./model'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">AuthConfig</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">InjectableFactory</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">static</span> <span class="token function">getModelAuthService</span><span class="token punctuation">(</span>svc<span class="token operator">:</span> ModelCrudSupport<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ModelAuthService</span><span class="token punctuation">(</span>
      svc<span class="token punctuation">,</span>
      User<span class="token punctuation">,</span>
      <span class="token punctuation">(</span>u<span class="token operator">:</span> User<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span>    <span class="token comment">// This converts User to a RegisteredPrincipal</span>
        source<span class="token operator">:</span> <span class="token string">'model'</span><span class="token punctuation">,</span>
        provider<span class="token operator">:</span> <span class="token string">'model'</span><span class="token punctuation">,</span>
        id<span class="token operator">:</span> u<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        permissions<span class="token operator">:</span> u<span class="token punctuation">.</span>permissions<span class="token punctuation">,</span>
        hash<span class="token operator">:</span> u<span class="token punctuation">.</span>hash<span class="token punctuation">,</span>
        salt<span class="token operator">:</span> u<span class="token punctuation">.</span>salt<span class="token punctuation">,</span>
        resetToken<span class="token operator">:</span> u<span class="token punctuation">.</span>resetToken<span class="token punctuation">,</span>
        resetExpires<span class="token operator">:</span> u<span class="token punctuation">.</span>resetExpires<span class="token punctuation">,</span>
        password<span class="token operator">:</span> u<span class="token punctuation">.</span>password<span class="token punctuation">,</span>
        details<span class="token operator">:</span> u<span class="token punctuation">,</span>
      <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span>u<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>RegisteredPrincipal<span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">=></span> User<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span>   <span class="token comment">// This converts a RegisteredPrincipal to a User</span>
        id<span class="token operator">:</span> u<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        permissions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>permissions <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        hash<span class="token operator">:</span> u<span class="token punctuation">.</span>hash<span class="token punctuation">,</span>
        salt<span class="token operator">:</span> u<span class="token punctuation">.</span>salt<span class="token punctuation">,</span>
        resetToken<span class="token operator">:</span> u<span class="token punctuation">.</span>resetToken<span class="token punctuation">,</span>
        resetExpires<span class="token operator">:</span> u<span class="token punctuation">.</span>resetExpires<span class="token punctuation">,</span>
      <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>

      <figure class="code">
      <figcaption class="code">Sample usage
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/auth-model/doc/usage.ts">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> AppError <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/base'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Injectable<span class="token punctuation">,</span> Inject <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/di'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> ModelAuthService <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/auth-model'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> User <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'./model'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{{'{'}}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> auth<span class="token operator">:</span> ModelAuthService<span class="token operator">&lt;</span>User<span class="token operator">></span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>identity<span class="token operator">:</span> User<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{{'{'}}</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>identity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{'}'}}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token keyword">instanceof</span> <span class="token class-name">AppError</span> <span class="token operator">&amp;&amp;</span> err<span class="token punctuation">.</span>category <span class="token operator">===</span> <span class="token string">'notfound'</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>identity<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">{{'}'}}</span> <span class="token keyword">else</span> <span class="token punctuation">{{'{'}}</span>
        <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
      <span class="token punctuation">{{'}'}}</span>
    <span class="token punctuation">{{'}'}}</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>
