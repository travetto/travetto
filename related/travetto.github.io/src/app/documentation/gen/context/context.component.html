<!-- This file was generated by &#64;travetto/doc and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/main/module/context/DOC.tsx and execute "npx trv doc" to rebuild -->
<h1>Async Context
<small>Async-aware state management, maintaining context across asynchronous calls.</small>
</h1>

  <figure class="install">
    <figcaption class="install">Install &#64;travetto/context
    
    </figcaption>
    <pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> &#64;travetto/context

<span class="token comment"># or</span>

<span class="token function">yarn</span> <span class="token function">add</span> &#64;travetto/context</code></pre>
  </figure>

This module provides a wrapper around node's <a target="_blank" class="external-link" href="https://nodejs.org/api/async_hooks.html">async_hooks</a> to maintain context across async calls. This is generally used for retaining contextual user information at various levels of async flow. <br><br>
The most common way of utilizing the context, is via the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/context/src/decorator.ts#L7">WithAsyncContext</a> decorator.  The decorator requires the class it's being used in, to have a <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/context/src/service.ts#L12">AsyncContext</a> member, as it is the source of the contextual information. <br><br>
The decorator will load the context on invocation, and will keep the context active during the entire asynchronous call chain. <br><br>
<strong>NOTE:</strong> while access context properties directly is supported, it is recommended to use <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/context/src/value.ts#L16">AsyncContextValue</a> instead.

  <figure class="code">
    <figcaption class="code">Usage of context within a service
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/context/doc/usage.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> AsyncContext<span class="token punctuation">,</span> WithAsyncContext <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'&#64;travetto/context'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Inject <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'&#64;travetto/di'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">NAME</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">'My Custom name symbol'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ContextAwareService</span> <span class="token punctuation">{{'{'}}</span>

  <span class="token decorator"><span class="token at operator">&#64;</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  context<span class="token operator">:</span> AsyncContext<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">&#64;</span><span class="token function">WithAsyncContext</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">complexOperator</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">NAME</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">additionalOp</span><span class="token punctuation">(</span><span class="token string">'extra'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">finalOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token keyword">async</span> <span class="token function">additionalOp</span><span class="token punctuation">(</span>additional<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">NAME</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${{'{'}}</span>name<span class="token interpolation-punctuation punctuation">{{'}'}}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${{'{'}}</span>additional<span class="token interpolation-punctuation punctuation">{{'}'}}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token keyword">async</span> <span class="token function">finalOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Use name</span>
    <span class="token keyword">return</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h2 id="asynccontextvalue">AsyncContextValue</h2>

Within the framework that is a need to access context values, in a type safe fashion.  Additionally, we have the requirement to keep the data accesses isolated from other operations.  To this end, <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/context/src/value.ts#L16">AsyncContextValue</a> was created to support this use case.  This class represents the ability to define a simple read/write contract for a given context field.  It also provides some supplemental functionality, e.g., the ability to suppress errors if a context is not initialized.

  <figure class="code">
    <figcaption class="code">Source for AsyncContextValue
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/context/src/value.ts#L16">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AsyncContextValue<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token operator">></span></span> <span class="token punctuation">{{'{'}}</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>source<span class="token operator">:</span> StorageSource<span class="token punctuation">,</span> config<span class="token operator">?</span><span class="token operator">:</span> ContextConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Get value
   */</span>
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Set value
   */</span>
  <span class="token function">set</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

  <figure class="code">
    <figcaption class="code">Usage of context value within a service
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/context/doc/usage-value.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> AsyncContext<span class="token punctuation">,</span> AsyncContextValue<span class="token punctuation">,</span> WithAsyncContext <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'&#64;travetto/context'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Inject <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'&#64;travetto/di'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ContextValueService</span> <span class="token punctuation">{{'{'}}</span>

  <span class="token decorator"><span class="token at operator">&#64;</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  context<span class="token operator">:</span> AsyncContext<span class="token punctuation">;</span>

  #name <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncContextValue<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">&#64;</span><span class="token function">WithAsyncContext</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">complexOperator</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>#name<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">additionalOp</span><span class="token punctuation">(</span><span class="token string">'extra'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">finalOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token keyword">async</span> <span class="token function">additionalOp</span><span class="token punctuation">(</span>additional<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#name<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>#name<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${{'{'}}</span>name<span class="token interpolation-punctuation punctuation">{{'}'}}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${{'{'}}</span>additional<span class="token interpolation-punctuation punctuation">{{'}'}}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token keyword">async</span> <span class="token function">finalOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#name<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Use name</span>
    <span class="token keyword">return</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>
