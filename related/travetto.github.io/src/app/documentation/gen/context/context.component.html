<div class="documentation"><h2 id="context" id="context">Context</h2>
<app-section-header headerType="install">Primary</app-section-header>
<pre><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> @travetto/context</code></pre><p>This module provides a wrapper around <code class="inline">nodejs</code>‘s <a class="external-link" href="https://nodejs.org/api/async_hooks.html" target="_blank" null><code class="inline">async_hooks</code></a> to maintain context across async calls. This is generally used for retaining contextual user information at various levels of async flow.</p>
<p>The most common way of utilizing the context, is via the <code class="decorator inline">@WithAsyncContext</code> decorator.  The decorator requires the class it’s being used in, to have a <a class="source-link" href="https://github.com/travetto/travetto/tree/master/module/context/src/service/context.ts" target="_blank" null><code class="inline">AsyncContext</code></a> member, as it is the source of the contextual information.</p>
<p>The decorator will load the context on invocation, and will keep the context active during the entire asynchronous call chain.</p>
<app-section-header headerType="code">Usage of context within a service</app-section-header>
<pre><code class="language-typescript"><span class="token keyword">class</span> <span class="token class-name">ContextAwareService</span> <span class="token punctuation">{{ '{' }}</span>

   <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> context<span class="token operator">:</span>AsyncContext</span><span class="token punctuation">)</span><span class="token punctuation">{{ '{' }}</span><span class="token punctuation">{{ '}' }}</span>

   @<span class="token meta">WithAsyncContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">async</span> <span class="token function">complexOperator</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token operator">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
     <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token punctuation">{{ '{' }}</span> name <span class="token punctuation">{{ '}' }}</span><span class="token punctuation">)</span>
     <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">additionalOp</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'finished'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">{{ '}' }}</span>

   <span class="token keyword">async</span> <span class="token function">additionalOp</span><span class="token punctuation">(</span><span class="token parameter">check<span class="token operator">:</span><span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
     <span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name <span class="token operator">===</span> check<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">finished</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
   <span class="token punctuation">{{ '}' }}</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><p>The decorator also allows for a priming of the contextual information.  This is generally useful for system generated operations that are not initiated by a user.</p>
<app-section-header headerType="code">Using context as an internal invocation</app-section-header>
<pre><code class="language-typescript"><span class="token keyword">class</span> <span class="token class-name">SystemInitiatedContext</span> <span class="token punctuation">{{ '{' }}</span>

   <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> context<span class="token operator">:</span>AsyncContext</span><span class="token punctuation">)</span><span class="token punctuation">{{ '{' }}</span><span class="token punctuation">{{ '}' }}</span>

   @<span class="token meta">WithContext</span><span class="token punctuation">(</span><span class="token punctuation">{{ '{' }}</span>
     user<span class="token operator">:</span> <span class="token string">'system'</span><span class="token punctuation">,</span>
     uid<span class="token operator">:</span> <span class="token number">20</span>
   <span class="token punctuation">{{ '}' }}</span><span class="token punctuation">)</span>
   <span class="token keyword">async</span> <span class="token function">runJob</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token operator">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
     <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"><span class="token type">User</span>=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${{ '{' }}</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>user<span class="token interpolation-punctuation punctuation">{{ '}' }}</span></span><span class="token string">, jobName=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${{ '{' }}</span>name<span class="token interpolation-punctuation punctuation">{{ '}' }}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">{{ '}' }}</span>
<span class="token punctuation">{{ '}' }}</span></code></pre></div>