<!-- This file was generated by @travetto/doc and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/main/module/base/DOC.tsx and execute "npx trv doc" to rebuild -->
<h1>Base
<small>Environment config and common utilities for travetto applications.</small>
</h1>

  <figure class="install">
    <figcaption class="install">Install @travetto/base
    
    </figcaption>
    <pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> @travetto/base

<span class="token comment"># or</span>

<span class="token function">yarn</span> <span class="token function">add</span> @travetto/base</code></pre>
  </figure>

Base is the foundation of all <a target="_blank" class="external-link" href="https://travetto.dev">Travetto</a> applications.  It is intended to be a minimal application set, as well as support for commonly shared functionality. It has support for the following key areas:
<ul> <li>Environment Support</li>
<li>Shared Global Environment State</li>
<li>Console Management</li>
<li>Resource Access</li>
<li>Standard Error Support</li>
<li>Stream Utilities</li>
<li>Object Utilities</li>
<li>Data Utilities</li>
<li>Common Utilities</li>
<li>Time Utilities</li>
<li>Process Execution</li>
<li>Shutdown Management</li>
</ul>

<h2 id="environment-support">Environment Support</h2>

The functionality we support for testing and retrieving environment information:
<ul> <li><code class="item method">isTrue(key: string): boolean;</code> - Test whether or not an environment flag is set and is true</li>
<li><code class="item method">isFalse(key: string): boolean;</code> - Test whether or not an environment flag is set and is false</li>
<li><code class="item method">isSet(key:string): boolean;</code> - Test whether or not an environment value is set (excludes: <code class="item input">null</code>, <code class="item input">''</code>, and <code class="item input">undefined</code>)</li>
<li><code class="item method">get(key: string, def?: string): string;</code> - Retrieve an environmental value with a potential default</li>
<li><code class="item method">getBoolean(key: string, isValue?: boolean)</code> - Retrieve an environmental value as a boolean.  If isValue is provided, determine if the environment variable matches the specified value</li>
<li><code class="item method">getInt(key: string, def?: number): number;</code> - Retrieve an environmental value as a number</li>
<li><code class="item method">getList(key: string): string[];</code> - Retrieve an environmental value as a list</li>
<li><code class="item method">addToList(key: string, value: string): string[];</code> - Add an item to an environment value, ensuring uniqueness</li>
</ul>

<h2 id="shared-global-environment-state">Shared Global Environment State</h2>

<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/global-env.ts#L17">GlobalEnv</a> is a non-cached interface to the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/env.ts#L4">Env</a> class with specific patterns defined.  It provides access to common patterns used at runtime within the framework.

  <figure class="code">
    <figcaption class="code">GlobalEnv Shape
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/base/src/global-env.ts#L17">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">const</span> GlobalEnv <span class="token operator">=</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/** Get environment name */</span>
  <span class="token keyword">get</span> <span class="token function">envName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/** Get debug module expression */</span>
  <span class="token keyword">get</span> <span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token comment">/** Are we in development mode */</span>
  <span class="token keyword">get</span> <span class="token function">devMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token comment">/** Is the app in dynamic mode? */</span>
  <span class="token keyword">get</span> <span class="token function">dynamic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token comment">/** Get list of resource paths */</span>
  <span class="token keyword">get</span> <span class="token function">resourcePaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">/** Is test */</span>
  <span class="token keyword">get</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token comment">/** Get node major version */</span>
  <span class="token keyword">get</span> <span class="token function">nodeVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token comment">/** Export as plain object */</span>
  <span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span></code></pre>
  </figure>

The source for each field is:
<ul> <li><code class="item field">envName</code> - This is derived from <code class="item field">process.env.TRV_ENV</code> with a fallback of <code class="item field">process.NODE_ENV</code></li>
<li><code class="item field">devMode</code> - This is true if <code class="item field">process.env.NODE_ENV</code> is dev* or test</li>
<li><code class="item field">dynamic</code> - This is derived from <code class="item field">process.env.TRV_DYNAMIC</code>. This field reflects certain feature sets used throughout the framework.</li>
<li><code class="item field">resourcePaths</code> - This is a list derived from <code class="item field">process.env.TRV_RESOURCES</code>.  This points to a list of folders that the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/resource.ts#L46">FileResourceProvider</a> will search against, by default.</li>
<li><code class="item field">test</code> - This is true if <code class="item field">envName</code> is <code class="item input">test</code></li>
<li><code class="item field">nodeVersion</code> - This is derived from <code class="item field">process.version</code>, and is used primarily for logging purposes</li>
</ul>
In addition to reading these values, there is a defined method for setting/updating these values:

  <figure class="code">
    <figcaption class="code">GlobalEnv Update
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/base/src/global-env.ts#L53">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineGlobalEnv</span><span class="token punctuation">(</span>cfg<span class="token operator">:</span> GlobalEnvConfig <span class="token operator">=</span> <span class="token punctuation">{{'{'}}</span><span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token keyword">const</span> <span class="token punctuation">{{'{'}}</span> set <span class="token operator">=</span> <span class="token punctuation">{{'{'}}</span><span class="token punctuation">{{'}'}}</span> <span class="token punctuation">{{'}'}}</span> <span class="token operator">=</span> cfg<span class="token punctuation">;</span>
  <span class="token keyword">const</span> resources <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>cfg<span class="token punctuation">.</span>resourcePaths <span class="token operator">??</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">...</span>GlobalEnv<span class="token punctuation">.</span>resourcePaths<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> envName <span class="token operator">=</span> <span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>envName <span class="token operator">??</span> GlobalEnv<span class="token punctuation">.</span>envName<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">readNodeEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>set<span class="token punctuation">,</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token constant">NODE_ENV</span><span class="token operator">:</span> <span class="token function">detectNodeEnv</span><span class="token punctuation">(</span>envName<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token constant">DEBUG</span><span class="token operator">:</span> envName <span class="token operator">!==</span> <span class="token constant">TEST</span> <span class="token operator">?</span> <span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>debug <span class="token operator">??</span> GlobalEnv<span class="token punctuation">.</span>debug <span class="token operator">??</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token constant">TRV_ENV</span><span class="token operator">:</span> envName<span class="token punctuation">,</span>
    <span class="token constant">TRV_DYNAMIC</span><span class="token operator">:</span> cfg<span class="token punctuation">.</span>dynamic <span class="token operator">??</span> GlobalEnv<span class="token punctuation">.</span>dynamic<span class="token punctuation">,</span>
    <span class="token constant">TRV_RESOURCES</span><span class="token operator">:</span> resources<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
  <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>k<span class="token punctuation">,</span> v<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>set<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token punctuation">(</span>v <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> v <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">delete</span> process<span class="token punctuation">.</span>env<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${{'{'}}</span>v<span class="token interpolation-punctuation punctuation">{{'}'}}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

As you can see this method exists to update/change the <code class="item field">process.env</code> values so that the usage of <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/global-env.ts#L17">GlobalEnv</a> reflects these changes.  This is primarily used in testing, or custom environment setups (e.g. CLI invocations for specific applications).

<h2 id="resource-access">Resource Access</h2>

The primary access patterns for resources, is to directly request a file, and to resolve that file either via file-system look up or leveraging the <a class="module-link" routerLink="/docs/manifest" title="Support for project indexing, manifesting, along with file watching">Manifest</a>'s data for what resources were found at manifesting time.

  <figure class="code">
    <figcaption class="code">ResourceProvider contract
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/base/src/resource.ts#L21">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ResourceProvider</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Describe the resource
   * @param pth The path to resolve
   */</span>
  <span class="token function">describe</span><span class="token punctuation">(</span>pth<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ResourceDescription<span class="token operator">></span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Read a resource, mimicking fs.read
   * @param pth The path to read
   */</span>
  <span class="token function">read</span><span class="token punctuation">(</span>pth<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> binary<span class="token operator">?</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span>pth<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> binary<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Buffer<span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span>pth<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> binary<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span> <span class="token operator">|</span> Buffer<span class="token operator">></span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Read a resource as a stream, mimicking fs.readStream
   * @param pth The path to read
   */</span>
  <span class="token function">readStream</span><span class="token punctuation">(</span>pth<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> binary<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Readable<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

The <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/resource.ts#L21">ResourceProvider</a> allows for accessing information about the resources, and subsequently reading the file as text/binary or to access the resource as a <code class="item class">Readable</code> stream.  If a file is not found, it will throw an <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/error.ts#L13">AppError</a> with a category of 'notfound'.  This contract is fairly simple to fill out, and the predominant implementation is <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/resource.ts#L46">FileResourceProvider</a>.  This <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/resource.ts#L21">ResourceProvider</a> will utilize the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/global-env.ts#L17">GlobalEnv</a>'s <code class="item field">resourcePaths</code> information on where to attempt to find a requested resource.
<h3 id="scanning-for-resources">Scanning for Resources</h3>

Beyond directly asking for a resource, there a times where it is helpful to know what resources are available at runtime. This is primarily used during development, and is a discouraged pattern for production as assumptions about the file-system may be incorrect (or change without warning).<br><br>
To that end, <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/resource-query.ts#L10">FileQueryProvider</a> exists, and is a valid <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/resource.ts#L21">ResourceProvider</a>.  It also provides the <code class="item method">query</code> method, to allow for scanning/finding resources that match certain patterns.  Additionally, this class also allows for watching all the resource folders.  This again is helpful during development/compilation, but should not be used in production.

<h2 id="standard-error-support">Standard Error Support</h2>

While the framework is 100 % compatible with standard <code class="item input">Error</code> instances, there are cases in which additional functionality is desired. Within the framework we use <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/error.ts#L13">AppError</a> (or its derivatives) to represent framework errors. This class is available for use in your own projects. Some of the additional benefits of using this class is enhanced error reporting, as well as better integration with other modules (e.g. the <a class="module-link" routerLink="/docs/rest" title="Declarative api for RESTful APIs with support for the dependency injection module.">RESTful API</a> module and HTTP status codes). <br><br>
The <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/error.ts#L13">AppError</a> takes in a message, and an optional payload and / or error classification. The currently supported error classifications are:
<ul> <li><code class="item input">general</code> - General purpose errors</li>
<li><code class="item input">system</code> - Synonym for <code class="item input">general</code></li>
<li><code class="item input">data</code> - Data format, content, etc are incorrect. Generally correlated to bad input.</li>
<li><code class="item input">permission</code> - Operation failed due to lack of permissions</li>
<li><code class="item input">auth</code> - Operation failed due to lack of authentication</li>
<li><code class="item input">missing</code> - Resource was not found when requested</li>
<li><code class="item input">timeout</code> - Operation did not finish in a timely manner</li>
<li><code class="item input">unavailable</code> - Resource was unresponsive</li>
</ul>

<h2 id="console-management">Console Management</h2>

This module provides logging functionality, built upon <a target="_blank" class="external-link" href="https://nodejs.org/api/console.html">console</a> operations. <br><br>
The supported operations are:
<ul> <li><code class="item method">console.error</code> which logs at the <code class="item input">ERROR</code> level</li>
<li><code class="item method">console.warn</code> which logs at the <code class="item input">WARN</code> level</li>
<li><code class="item method">console.info</code> which logs at the <code class="item input">INFO</code> level</li>
<li><code class="item method">console.debug</code> which logs at the <code class="item input">DEBUG</code> level</li>
<li><code class="item method">console.log</code> which logs at the <code class="item input">INFO</code> level</li>
</ul>

<p class="note"><strong>Note</strong> All other console methods are excluded, specifically <code class="item method">trace</code>, <code class="item method">inspect</code>, <code class="item method">dir</code>, <code class="item method">time</code>/<code class="item method">timeEnd</code></p>

<h2 id="how-logging-is-instrumented">How Logging is Instrumented</h2>

All of the logging instrumentation occurs at transpilation time.  All <code class="item method">console.*</code> methods are replaced with a call to a globally defined variable that delegates to the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/console.ts#L44">ConsoleManager</a>.  This module, hooks into the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/console.ts#L44">ConsoleManager</a> and receives all logging events from all files compiled by the <a target="_blank" class="external-link" href="https://travetto.dev">Travetto</a>. <br><br>
A sample of the instrumentation would be:

  <figure class="code">
    <figcaption class="code">Sample logging at various levels
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/base/doc/transpile.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">work</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Start Work'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Divide by zero'</span><span class="token punctuation">,</span> <span class="token punctuation">{{'{'}}</span> error<span class="token operator">:</span> err <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'End Work'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

  <figure class="code">
    <figcaption class="code">Sample After Transpilation
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/base/doc/transpile.js">Source</a></cite>

</figcaption>
    <pre><code class="language-javascript"><span class="token string">"use strict"</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">"__esModule"</span><span class="token punctuation">,</span> <span class="token punctuation">{{'{'}}</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>work <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> tslib_1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"tslib"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ᚕ_c <span class="token operator">=</span> tslib_1<span class="token punctuation">.</span><span class="token function">__importStar</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"@travetto/base/src/console.js"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> ᚕf <span class="token operator">=</span> <span class="token string">"@travetto/base/doc/transpile.js"</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">work</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    ᚕ_c<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span> <span class="token literal-property property">level</span><span class="token operator">:</span> <span class="token string">"debug"</span><span class="token punctuation">,</span> <span class="token literal-property property">source</span><span class="token operator">:</span> ᚕf<span class="token punctuation">,</span> <span class="token literal-property property">line</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token string">"work"</span><span class="token punctuation">,</span> <span class="token literal-property property">args</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Start Work'</span><span class="token punctuation">]</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{{'{'}}</span>
        <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{'}'}}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
        ᚕ_c<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span> <span class="token literal-property property">level</span><span class="token operator">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token literal-property property">source</span><span class="token operator">:</span> ᚕf<span class="token punctuation">,</span> <span class="token literal-property property">line</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token string">"work"</span><span class="token punctuation">,</span> <span class="token literal-property property">args</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Divide by zero'</span><span class="token punctuation">,</span> <span class="token punctuation">{{'{'}}</span> <span class="token literal-property property">error</span><span class="token operator">:</span> err <span class="token punctuation">{{'}'}}</span><span class="token punctuation">]</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{'}'}}</span>
    ᚕ_c<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span> <span class="token literal-property property">level</span><span class="token operator">:</span> <span class="token string">"debug"</span><span class="token punctuation">,</span> <span class="token literal-property property">source</span><span class="token operator">:</span> ᚕf<span class="token punctuation">,</span> <span class="token literal-property property">line</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token string">"work"</span><span class="token punctuation">,</span> <span class="token literal-property property">args</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'End Work'</span><span class="token punctuation">]</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span>
exports<span class="token punctuation">.</span>work <span class="token operator">=</span> work<span class="token punctuation">;</span></code></pre>
  </figure>

<h3 id="filtering-debug">Filtering Debug</h3>

The <code class="item input">debug</code> messages can be filtered using the patterns from the <a target="_blank" class="external-link" href="https://www.npmjs.com/package/debug">debug</a>.  You can specify wild cards to only <code class="item input">DEBUG</code> specific modules, folders or files.  You can specify multiple, and you can also add negations to exclude specific packages.

  <figure class="terminal">
    <figcaption class="terminal">Sample environment flags

</figcaption>
    <pre><code class="language-bash"><span class="token comment"># Debug</span>
$ <span class="token assign-left variable">DEBUG</span><span class="token operator">=</span>-@travetto/model npx trv run app
$ <span class="token assign-left variable">DEBUG</span><span class="token operator">=</span>-@travetto/registry npx trv run app
$ <span class="token assign-left variable">DEBUG</span><span class="token operator">=</span>@travetto/rest npx trv run app
$ <span class="token assign-left variable">DEBUG</span><span class="token operator">=</span>@travetto/*,-@travetto/model npx trv run app</code></pre>
  </figure>

Additionally, the logging framework will merge <a target="_blank" class="external-link" href="https://www.npmjs.com/package/debug">debug</a> into the output stream, and supports the standard usage

  <figure class="terminal">
    <figcaption class="terminal">Sample environment flags for standard usage

</figcaption>
    <pre><code class="language-bash"><span class="token comment"># Debug</span>
$ <span class="token assign-left variable">DEBUG</span><span class="token operator">=</span>express:*,@travetto/rest npx trv run rest</code></pre>
  </figure>

<h2 id="stream-utilities">Stream Utilities</h2>

The <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/stream.ts#L12">StreamUtil</a> class provides basic stream utilities for use within the framework:
<ul> <li><code class="item method">toBuffer(src: Readable | Buffer | string): Promise&lt;Buffer&gt;</code> for converting a stream/buffer/filepath to a Buffer.</li>
<li><code class="item method">toReadable(src: Readable | Buffer | string):Promise&lt;Readable&gt;</code> for converting a stream/buffer/filepath to a Readable</li>
<li><code class="item method">writeToFile(src: Readable, out: string):Promise&lt;void&gt;</code> will stream a readable into a file path, and wait for completion.</li>
<li><code class="item method">waitForCompletion(src: Readable, finish:()=&gt;Promise&lt;any&gt;)</code> will ensure the stream remains open until the promise finish produces is satisfied.</li>
</ul>

<h2 id="object-utilities">Object Utilities</h2>

Simple functions for providing a minimal facsimile to <a target="_blank" class="external-link" href="https://lodash.com">lodash</a>, but without all the weight. Currently <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/object.ts#L10">ObjectUtil</a> includes:
<ul> <li><code class="item method">isPrimitive(el)</code> determines if <code class="item input">el</code> is a <code class="item input">string</code>, <code class="item input">boolean</code>, <code class="item input">number</code> or <code class="item input">RegExp</code></li>
<li><code class="item method">isPlainObject(obj)</code> determines if the obj is a simple object</li>
<li><code class="item method">isFunction(o)</code> determines if <code class="item input">o</code> is a simple <code class="item input">Function</code></li>
<li><code class="item method">isClass(o)</code> determines if <code class="item input">o</code> is a class constructor</li>
<li><code class="item method">isSimple(a)</code> determines if <code class="item input">a</code> is a simple value</li>
<li><code class="item method">isPromise(a)</code> determines if <code class="item input">a</code> is a promise</li>
</ul>

<h2 id="data-utilities">Data Utilities</h2>

Data utilities for binding values, and type conversion. Currently <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/data.ts#L9">DataUtil</a> includes:
<ul> <li><code class="item method">deepAssign(a, b, mode ?)</code> which allows for deep assignment of <code class="item input">b</code> onto <code class="item input">a</code>, the <code class="item input">mode</code> determines how aggressive the assignment is, and how flexible it is.  <code class="item input">mode</code> can have any of the following values:
<ul> <li><code class="item input">loose</code>, which is the default is the most lenient. It will not error out, and overwrites will always happen</li>
<li><code class="item input">coerce</code>, will attempt to force values from <code class="item input">b</code> to fit the types of <code class="item input">a</code>, and if it can't it will error out</li>
<li><code class="item input">strict</code>, will error out if the types do not match</li>
</ul>
</li>
<li><code class="item method">coerceType(input: unknown, type: Class&lt;unknown&gt;, strict = true)</code> which allows for converting an input type into a specified <code class="item input">type</code> instance, or throw an error if the types are incompatible.</li>
<li><code class="item method">shallowClone&lt;T = unknown&gt;(a: T): T</code> will shallowly clone a field</li>
<li><code class="item method">filterByKeys&lt;T&gt;(obj: T, exclude: (string | RegExp)[]): T</code> will filter a given object, and return a plain object (if applicable) with fields excluded using the values in the <code class="item input">exclude</code> input</li>
</ul>

<h2 id="common-utilities">Common Utilities</h2>

Common utilities used throughout the framework. Currently <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/util.ts#L14">Util</a> includes:
<ul> <li><code class="item method">uuid(len: number)</code> generates a simple uuid for use within the application.</li>
<li><code class="item method">allowDenyMatcher(rules[])</code> builds a matching function that leverages the rules as an allow/deny list, where order of the rules matters.  Negative rules are prefixed by '!'.</li>
<li><code class="item method">naiveHash(text: string)</code> produces a fast, and simplistic hash.  No guarantees are made, but performs more than adequately for framework purposes.</li>
<li><code class="item method">makeTemplate&lt;T extends string&gt;(wrap: (key: T, val: TemplatePrim) =&gt; string)</code> produces a template function tied to the distinct string values that <code class="item input">key</code> supports.</li>
<li><code class="item method">resolvablePromise()</code> produces a <code class="item class">Promise</code> instance with the <code class="item method">resolve</code> and <code class="item method">reject</code> methods attached to the instance.  This is extremely useful for integrating promises into async iterations, or any other situation in which the promise creation and the execution flow don't always match up.</li>
</ul>

  <figure class="code">
    <figcaption class="code">Sample makeTemplate Usage

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">const</span> tpl <span class="token operator">=</span> <span class="token function">makeTemplate</span><span class="token punctuation">(</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token string">'age'</span><span class="token operator">|</span><span class="token string">'name'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">**</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${{'{'}}</span>name<span class="token interpolation-punctuation punctuation">{{'}'}}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${{'{'}}</span>val<span class="token interpolation-punctuation punctuation">{{'}'}}</span></span><span class="token string">**</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
tpl`<span class="token punctuation">{{'{'}}</span><span class="token punctuation">{{'{'}}</span>age<span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">{{'}'}}</span><span class="token punctuation">{{'}'}}</span> <span class="token punctuation">{{'{'}}</span><span class="token punctuation">{{'{'}}</span>name<span class="token operator">:</span> <span class="token string">'bob'</span><span class="token punctuation">{{'}'}}</span><span class="token punctuation">{{'}'}}</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token comment">// produces</span>
<span class="token string">'**age: 20** **name: bob**'</span></code></pre>
  </figure>

<h2 id="time-utilities">Time Utilities</h2>

<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/time.ts#L23">TimeUtil</a> contains general helper methods, created to assist with time-based inputs via environment variables, command line interfaces, and other string-heavy based input.

  <figure class="code">
    <figcaption class="code">Time Utilities
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/base/src/time.ts#L23">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TimeUtil</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Test to see if a string is valid for relative time
   * @param val
   */</span>
  <span class="token keyword">static</span> <span class="token function">isTimeSpan</span><span class="token punctuation">(</span>val<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> val <span class="token keyword">is</span> TimeSpan<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Returns time units convert to ms
   * @param amount Number of units to extend
   * @param unit Time unit to extend ('ms', 's', 'm', 'h', 'd', 'w', 'y')
   */</span>
  <span class="token keyword">static</span> <span class="token function">timeToMs</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> TimeSpan<span class="token punctuation">,</span> unit<span class="token operator">?</span><span class="token operator">:</span> TimeUnit<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Returns a new date with `amount` units into the future
   * @param amount Number of units to extend
   * @param unit Time unit to extend ('ms', 's', 'm', 'h', 'd', 'w', 'y')
   */</span>
  <span class="token keyword">static</span> <span class="token function">timeFromNow</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> TimeSpan<span class="token punctuation">,</span> unit<span class="token operator">:</span> TimeUnit <span class="token operator">=</span> <span class="token string">'ms'</span><span class="token punctuation">)</span><span class="token operator">:</span> Date<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Wait for 'amount' units of time
   */</span>
  <span class="token keyword">static</span> <span class="token function">wait</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> TimeSpan<span class="token punctuation">,</span> unit<span class="token operator">:</span> TimeUnit <span class="token operator">=</span> <span class="token string">'ms'</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Get environment variable as time
   * @param key env key
   * @param def backup value if not valid or found
   */</span>
  <span class="token keyword">static</span> <span class="token function">getEnvTime</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> def<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> TimeSpan<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Pretty print a delta between now and `time`, with auto-detection of largest unit
   */</span>
  <span class="token keyword">static</span> <span class="token function">prettyDeltaSinceTime</span><span class="token punctuation">(</span>time<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> unit<span class="token operator">?</span><span class="token operator">:</span> TimeUnit<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Pretty print a delta, with auto-detection of largest unit
   * @param delta The number of milliseconds in the delta
   */</span>
  <span class="token keyword">static</span> <span class="token function">prettyDelta</span><span class="token punctuation">(</span>delta<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> unit<span class="token operator">?</span><span class="token operator">:</span> TimeUnit<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h2 id="process-execution">Process Execution</h2>

Just like <a target="_blank" class="external-link" href="https://nodejs.org/api/child_process.html">child_process</a>, the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/base/src/exec.ts#L108">ExecUtil</a> exposes <code class="item method">spawn</code> and <code class="item method">fork</code>.  These are generally wrappers around the underlying functionality.  In addition to the base functionality, each of those functions is converted to a <code class="item input">Promise</code> structure, that throws an error on an non-zero return status.<br><br>
A simple example would be:

  <figure class="code">
    <figcaption class="code">Running a directory listing via ls
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/base/doc/exec.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> ExecUtil <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/base'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">executeListing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token keyword">const</span> <span class="token punctuation">{{'{'}}</span> result <span class="token punctuation">{{'}'}}</span> <span class="token operator">=</span> ExecUtil<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> final <span class="token operator">=</span> <span class="token keyword">await</span> result<span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Listing'</span><span class="token punctuation">,</span> <span class="token punctuation">{{'{'}}</span> lines<span class="token operator">:</span> final<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

As you can see, the call returns not only the child process information, but the <code class="item input">Promise</code> to wait for.  Additionally, some common patterns are provided for the default construction of the child process. In addition to the standard options for running child processes, the module allows for the following execution options:

  <figure class="code">
    <figcaption class="code">Execution Options
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/base/src/exec.ts#L60">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ExecutionOptions</span> <span class="token keyword">extends</span> <span class="token class-name">SpawnOptions</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Should an error be caught and returned as a result. Determines whether an exit code > 0 throws
   * an Error, or if it merely marks the process as completed, marking the result as invalid.
   */</span>
  catchAsResult<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Should the environment be isolated, or inherit from process.env
   */</span>
  isolatedEnv<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Built in timeout for any execution. The number of milliseconds the process can run before
   * terminating and throwing an error
   */</span>
  timeout<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Determines how to treat the stdout/stderr data.
   *  - 'text' will assume the output streams are textual, and will convert to unicode data.
   *  - 'text-stream' makes the same assumptions as 'text', but will only fire events, and will
   *        not persist any data.  This is really useful for long running programs.
   *  - 'binary' treats all stdout/stderr data as raw buffers, and will not perform any transformations.
   *  - 'raw' avoids touching stdout/stderr altogether, and leaves it up to the caller to decide.
   */</span>
  outputMode<span class="token operator">?</span><span class="token operator">:</span> <span class="token string">'raw'</span> <span class="token operator">|</span> <span class="token string">'binary'</span> <span class="token operator">|</span> <span class="token string">'text'</span> <span class="token operator">|</span> <span class="token string">'text-stream'</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * On stderr line.  Requires 'outputMode' to be either 'text' or 'text-stream'
   */</span>
  onStdErrorLine<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>line<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * On stdout line.  Requires 'outputMode' to be either 'text' or 'text-stream'
   */</span>
  onStdOutLine<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>line<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * The stdin source for the execution
   */</span>
  stdin<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> Buffer <span class="token operator">|</span> Readable<span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h2 id="shutdown-management">Shutdown Management</h2>

Another key lifecycle is the process of shutting down. The framework provides centralized functionality for running operations on shutdown. Primarily used by the framework for cleanup operations, this provides a clean interface for registering shutdown handlers. The code overrides <code class="item method">process.exit</code> to properly handle <code class="item input">SIGKILL</code> and <code class="item input">SIGINT</code>, with a default threshold of 3 seconds. In the advent of a <code class="item input">SIGTERM</code> signal, the code exits immediately without any cleanup.<br><br>
As a registered shutdown handler, you can do.

  <figure class="code">
    <figcaption class="code">Registering a shutdown handler
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/base/doc/shutdown.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> ShutdownManager <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/base'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">registerShutdownHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
  ShutdownManager<span class="token punctuation">.</span><span class="token function">onShutdown</span><span class="token punctuation">(</span><span class="token string">'handler-name'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{{'{'}}</span>
    <span class="token comment">// Do important work, the framework will wait until all async</span>
    <span class="token comment">//   operations are completed before finishing shutdown</span>
  <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>
