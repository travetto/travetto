<!-- This file was generated by @travetto/doc and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/main/module/auth-rest-jwt/DOC.ts and execute "npx trv doc" to rebuild -->
<h1>Rest Auth JWT
          <small>Rest authentication JWT integration support for the Travetto framework</small>

        </h1>

      <figure class="install">
      <figcaption class="install">Install @travetto/auth-rest-jwt
      
      </figcaption>
      <pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> @travetto/auth-rest-jwt

<span class="token comment"># or</span>

<span class="token function">yarn</span> <span class="token function">add</span> @travetto/auth-rest-jwt</code></pre>     
      </figure>

One of <a class="module-link" href="https://github.com/travetto/travetto/tree/main/module/auth-rest" title="Rest authentication integration support for the Travetto framework">Rest Auth</a>'s main responsibilities is being able to send and receive authentication/authorization information from the client.  This data can be encoded in many different forms, and this module provides the ability to encode into and decode from <a target="_blank" class="external-link" href="https://jwt.io/">JWT</a>s. This module fulfills the contract required by <a class="module-link" href="https://github.com/travetto/travetto/tree/main/module/auth-rest" title="Rest authentication integration support for the Travetto framework">Rest Auth</a> of being able to encode and decode a user principal, by leveraging <a class="module-link" href="https://github.com/travetto/travetto/tree/main/module/jwt" title="JSON Web Token implementation">JWT</a>'s token generation features.

The <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth-rest-jwt/src/principal-encoder.ts#L30">JWTPrincipalEncoder</a> is exposed as a tool for allowing for converting an authenticated principal into a JWT, and back again. 

      <figure class="code">
      <figcaption class="code">JWTPrincipalEncoder
      <cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/auth-rest-jwt/src/principal-encoder.ts">Source</a></cite>
      </figcaption>
      <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Principal <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/auth'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> PrincipalEncoder <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/auth-rest'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> AppError<span class="token punctuation">,</span> GlobalEnv<span class="token punctuation">,</span> TimeUtil <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/base'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Config <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/config'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Inject<span class="token punctuation">,</span> Injectable <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/di'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> FilterContext <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/rest'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> JWTUtil<span class="token punctuation">,</span> Payload <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/jwt'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Config</span></span><span class="token punctuation">(</span><span class="token string">'rest.auth.jwt'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">RestJWTConfig</span> <span class="token punctuation">{{'{'}}</span>
  header <span class="token operator">=</span> <span class="token string">'Authorization'</span><span class="token punctuation">;</span>
  signingKey<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  headerPrefix <span class="token operator">=</span> <span class="token string">'Bearer '</span><span class="token punctuation">;</span>
  defaultAge <span class="token operator">=</span> TimeUtil<span class="token punctuation">.</span><span class="token function">timeToMs</span><span class="token punctuation">(</span><span class="token string">'1y'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">postConstruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>signingKey<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalEnv<span class="token punctuation">.</span>prod<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AppError</span><span class="token punctuation">(</span><span class="token string">'The default signing key is not valid for production use, please specify a config value at rest.auth.jwt.signingKey'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">{{'}'}}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>signingKey <span class="token operator">=</span> <span class="token string">'dummy'</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{'}'}}</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span>

<span class="token comment">/**
 * Principal encoder via JWT
 */</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">JWTPrincipalEncoder</span> <span class="token keyword">implements</span> <span class="token class-name">PrincipalEncoder</span> <span class="token punctuation">{{'{'}}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  config<span class="token operator">:</span> RestJWTConfig<span class="token punctuation">;</span>

  <span class="token function">toJwtPayload</span><span class="token punctuation">(</span>p<span class="token operator">:</span> Principal<span class="token punctuation">)</span><span class="token operator">:</span> Payload <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">const</span> exp <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">trunc</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>expiresAt<span class="token operator">?.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>defaultAge<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> iat <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">trunc</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>issuedAt<span class="token operator">?.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">??</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{{'{'}}</span>
      auth<span class="token operator">:</span> p<span class="token punctuation">,</span>
      exp<span class="token punctuation">,</span>
      iat<span class="token punctuation">,</span>
      iss<span class="token operator">:</span> p<span class="token punctuation">.</span>issuer<span class="token punctuation">,</span>
      sub<span class="token operator">:</span> p<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    <span class="token punctuation">{{'}'}}</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token comment">/**
   * Get token for principal
   */</span>
  <span class="token keyword">async</span> <span class="token function">getToken</span><span class="token punctuation">(</span>p<span class="token operator">:</span> Principal<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> JWTUtil<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toJwtPayload</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{{'{'}}</span> key<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>signingKey <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token comment">/**
   * Verify token to principal
   * @param token
   */</span>
  <span class="token keyword">async</span> <span class="token function">verifyToken</span><span class="token punctuation">(</span>token<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Principal<span class="token operator">></span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">await</span> JWTUtil<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">verify</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token punctuation">{{'{'}}</span> auth<span class="token operator">:</span> Principal <span class="token punctuation">{{'}'}}</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token punctuation">{{'{'}}</span> key<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>signingKey <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>auth<span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token comment">/**
   * Write context
   */</span>
  <span class="token keyword">async</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span> res <span class="token punctuation">{{'}'}}</span><span class="token operator">:</span> FilterContext<span class="token punctuation">,</span> p<span class="token operator">:</span> Principal <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>header<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${{'{'}}</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>headerPrefix<span class="token interpolation-punctuation punctuation">{{'}'}}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${{'{'}}</span><span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">{{'}'}}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{'}'}}</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token comment">/**
   * Read JWT from request
   */</span>
  <span class="token keyword">async</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span> req <span class="token punctuation">{{'}'}}</span><span class="token operator">:</span> FilterContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Principal <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">></span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">headerFirst</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>header<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>headerPrefix<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">verifyToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{'}'}}</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>     
      </figure>

As you can see, the encode token just creates a <a target="_blank" class="external-link" href="https://jwt.io/">JWT</a> based on the principal provided, and decoding verifies the token, and returns the principal.
