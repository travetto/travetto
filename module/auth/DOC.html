<!-- This file was generated by @travetto/doc and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/main/module/auth/DOC.tsx and execute "npx trv doc" to rebuild -->
<h1>Authentication
<small>Authentication scaffolding for the Travetto framework</small>
</h1>

  <figure class="install">
    <figcaption class="install">Install @travetto/auth
    
    </figcaption>
    <pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> @travetto/auth

<span class="token comment"># or</span>

<span class="token function">yarn</span> <span class="token function">add</span> @travetto/auth</code></pre>
  </figure>

This module provides the high-level backdrop for managing security principals.  The goal of this module is to be a centralized location for various security frameworks to plug into.  The primary contributions are:
<ul> <li>Standard Types</li>
<li>Authentication Contract</li>
<li>Authorization Contract</li>
<li>Authorization Services</li>
<li>Authorization Context</li>
</ul>

<h2 id="standard-types">Standard Types</h2>

The module's goal is to be as flexible as possible.  To that end, the primary contract that this module defines, is that of the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth/src/types/principal.ts#L7">Principal</a>.

  <figure class="code">
    <figcaption class="code">Principal
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/auth/src/types/principal.ts#L7">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Principal<span class="token operator">&lt;</span><span class="token constant">D</span> <span class="token operator">=</span> AnyMap<span class="token operator">></span></span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Primary identifier for a user
   */</span>
  <span class="token keyword">readonly</span> id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Unique identifier for the principal's lifecycle
   */</span>
  <span class="token keyword">readonly</span> sessionId<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Date of expiration
   */</span>
  expiresAt<span class="token operator">?</span><span class="token operator">:</span> Date<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Date of issuance
   */</span>
  issuedAt<span class="token operator">?</span><span class="token operator">:</span> Date<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The source of the issuance
   */</span>
  <span class="token keyword">readonly</span> issuer<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Supplemental details
   */</span>
  <span class="token keyword">readonly</span> details<span class="token operator">:</span> <span class="token constant">D</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * List of all provided permissions
   */</span>
  <span class="token keyword">readonly</span> permissions<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

As referenced above, a <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth/src/types/principal.ts#L7">Principal</a> is defined as a user with respect to a security context. This can be information the application knows about the user (authorized) or what a separate service may know about a user (3rd-party authentication).

<h2 id="authentication-contract">Authentication Contract</h2>

  <figure class="code">
    <figcaption class="code">Authenticator
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/auth/src/types/authenticator.ts#L16">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Authenticator<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span> <span class="token constant">C</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span> <span class="token constant">P</span> <span class="token keyword">extends</span> Principal <span class="token operator">=</span> Principal<span class="token operator">></span></span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Retrieve the authenticator state for the given request
   */</span>
  getState<span class="token operator">?</span><span class="token punctuation">(</span>context<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>AuthenticatorState <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">></span> <span class="token operator">|</span> AuthenticatorState <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Verify the payload, ensuring the payload is correctly identified.
   *
   * @returns Valid principal if authenticated
   * @returns undefined if authentication is valid, but incomplete (multi-step)
   * @throws Error if authentication fails
   */</span>
  <span class="token function">authenticate</span><span class="token punctuation">(</span>payload<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">P</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token constant">P</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

The <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth/src/types/authenticator.ts#L9">Authenticator</a> only requires one method to be defined, and that is <code class="item method">authenticate</code>. This method receives a generic payload, and a supplemental context as an input. The interface is responsible for converting that to an authenticated principal.

<h2 id="authorization-contract">Authorization Contract</h2>

  <figure class="code">
    <figcaption class="code">Authorizer
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/auth/src/types/authorizer.ts#L8">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Authorizer<span class="token operator">&lt;</span><span class="token constant">P</span> <span class="token keyword">extends</span> Principal <span class="token operator">=</span> Principal<span class="token operator">></span></span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Authorize inbound principal, verifying it's permission to access the system.
   * @returns New principal that conforms to the required principal shape
   */</span>
  <span class="token function">authorize</span><span class="token punctuation">(</span>principal<span class="token operator">:</span> <span class="token constant">P</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">P</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token constant">P</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

Authorizers are generally seen as a secondary step post-authentication. Authentication acts as a very basic form of authorization, assuming the principal store is owned by the application. <br><br>
The <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth/src/types/authorizer.ts#L8">Authorizer</a> only requires one method to be defined, and that is <code class="item method">authorize</code>. This method receives an authenticated principal as an input, and is responsible for converting that to an authorized principal.
<h3 id="example">Example</h3>

The <a class="module-link" href="https://github.com/travetto/travetto/tree/main/module/model" title="Datastore abstraction for core operations.">Data Modeling Support</a> extension is a good example of an authenticator. This is a common use case for simple internal auth. <br><br>
Overall, the structure is simple, but drives home the primary use cases of the framework. The goals are:
<ul> <li>Be able to identify a user uniquely</li>
<li>To have a reference to a user's set of permissions</li>
<li>To have access to the principal</li>
</ul>

<h2 id="authorization-services">Authorization Services</h2>

  <figure class="code">
    <figcaption class="code">Authorization Service
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/auth/src/service.ts#L13">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">/**
   * Get authenticators by keys
   */</span>
  <span class="token keyword">async</span> <span class="token generic-function"><span class="token function">getAuthenticators</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span> <span class="token constant">C</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>keys<span class="token operator">:</span> <span class="token builtin">symbol</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Authenticator<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Authenticate. Supports multi-step login.
   * @param ctx The authenticator context
   * @param authenticators List of valid authentication sources
   */</span>
  <span class="token keyword">async</span> <span class="token generic-function"><span class="token function">authenticate</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>payload<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> context<span class="token operator">:</span> <span class="token constant">C</span><span class="token punctuation">,</span> authenticators<span class="token operator">:</span> <span class="token builtin">symbol</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Principal <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Manage expiry state, renewing if allowed
   */</span>
  <span class="token function">manageExpiry</span><span class="token punctuation">(</span>principal<span class="token operator">?</span><span class="token operator">:</span> Principal<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Enforce expiry, invalidating the principal if expired
   */</span>
  <span class="token function">enforceExpiry</span><span class="token punctuation">(</span>principal<span class="token operator">?</span><span class="token operator">:</span> Principal<span class="token punctuation">)</span><span class="token operator">:</span> Principal <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

The <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth/src/service.ts#L13">AuthService</a> operates as the owner of the current auth state for a given "request". "Request" here implies a set of operations over a period of time, with the http request/response model being an easy point of reference.  This could also tie to a CLI operation, or any other invocation that requires some concept of authentication and authorization. <br><br>
The service allows for storing and retrieving the active <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth/src/types/principal.ts#L7">Principal</a>, and/or the actively persisted auth token.  This is extremely useful for other parts of the framework that may request authenticated information (if available).  <a class="module-link" href="https://github.com/travetto/travetto/tree/main/module/auth-web" title="Web authentication integration support for the Travetto framework">Web Auth</a> makes heavy use of this state for enforcing endpoints when authentication is required. <br><br>

<h3 id="login">Login</h3>

"Logging in" can be thought of going through the action of finding a single source that can authenticate the identity for the request credentials.  Some times there may be more than one valid source of authentication that you want to leverage, and the first one to authenticate wins. The <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth/src/service.ts#L13">AuthService</a> operates in this fashion, in which a set of credentials and potential <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth/src/types/authenticator.ts#L9">Authenticator</a> s are submitted, and the service will attempt to authenticate.  <br><br>
Upon successful authentication, an optional <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth/src/types/authorizer.ts#L8">Authorizer</a> may be invoked to authorize the authenticated user.  The <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth/src/types/authenticator.ts#L9">Authenticator</a> is assumed to be only one within the system, and should be tied to the specific product you are building for.  The <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth/src/types/authorizer.ts#L8">Authorizer</a> should be assumed to have multiple sources, and are generally specific to external third parties.  All of these values are collected via the <a class="module-link" href="https://github.com/travetto/travetto/tree/main/module/di" title="Dependency registration/management and injection support.">Dependency Injection</a> module and will be auto-registered on startup. <br><br>
If this process is too cumbersome or restrictive, manually authenticating and authorizing is still more than permissible, and setting the principal within the service is a logical equivalent to login.

<h2 id="authorization-context">Authorization Context</h2>

When working with framework's authentication, the authenticated information is exposed via the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth/src/context.ts#L14">AuthContext</a>, object. <br><br>

  <figure class="code">
    <figcaption class="code">Auth Context Outline
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/auth/src/context.ts#L14">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthContext</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">/**
   * Set principal
   */</span>
  <span class="token keyword">set</span> <span class="token function">principal</span><span class="token punctuation">(</span>value<span class="token operator">:</span> Principal <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Get the authentication token, if it exists
   */</span>
  <span class="token keyword">get</span> <span class="token function">authToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> AuthToken <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Set/overwrite the user's authentication token
   */</span>
  <span class="token keyword">set</span> <span class="token function">authToken</span><span class="token punctuation">(</span>token<span class="token operator">:</span> AuthToken <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Get the authenticator state, if it exists
   */</span>
  <span class="token keyword">get</span> <span class="token function">authenticatorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> AuthenticatorState <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Set/overwrite the authenticator state
   */</span>
  <span class="token keyword">set</span> <span class="token function">authenticatorState</span><span class="token punctuation">(</span>state<span class="token operator">:</span> AuthenticatorState <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Clear context
   */</span>
  <span class="token keyword">async</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>
