<!-- This file was generated by @travetto/doc and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/master/module/rest/doc.ts and execute "npx trv doc" to rebuild -->
# RESTful API
## Declarative api for RESTful APIs with support for the dependency injection module.

**Install: @travetto/rest**
```bash
npm install @travetto/rest
```

The module provides a declarative API for creating and describing an RESTful application.  Since the framework is declarative, decorators are used to configure almost everything. The module is framework agnostic (but resembles [express](https://expressjs.com) in the [TravettoRequest](https://github.com/travetto/travetto/tree/master/module/rest/src/types.d.ts#L14) and [TravettoResponse](https://github.com/travetto/travetto/tree/master/module/rest/src/types.d.ts#L86) objects). 

## Routes: Controller

To define a route, you must first declare a [@Controller](https://github.com/travetto/travetto/tree/master/module/rest/src/decorator/controller.ts#L9) which is only allowed on classes. Controllers can be configured with:

   
   *  `title` - The definition of the controller
   *  `description` - High level description fo the controller

Additionally, the module is predicated upon [Dependency Injection](https://github.com/travetto/travetto/tree/master/module/di#readme "Dependency registration/management and injection support."), and so all standard injection techniques (constructor, fields) work for registering dependencies.

[JSDoc](http://usejsdoc.org/about-getting-started.html) comments can also be used to define the `title` attribute.

**Code: Basic Controller Registration**
```typescript
import { Controller } from '@travetto/rest';

@Controller('/simple')
class SimpleController {
  // routes
}
```

## Routes: Endpoints

Once the controller is declared, each method of the controller is a candidate for routing.  By design, everything is asynchronous, and so async/await is natively supported.  

The HTTP methods that are supported via:
   
   *  [@Get](https://github.com/travetto/travetto/tree/master/module/rest/src/decorator/endpoint.ts#L30)
   *  [@Post](https://github.com/travetto/travetto/tree/master/module/rest/src/decorator/endpoint.ts#L36)
   *  [@Put](https://github.com/travetto/travetto/tree/master/module/rest/src/decorator/endpoint.ts#L42)
   *  [@Delete](https://github.com/travetto/travetto/tree/master/module/rest/src/decorator/endpoint.ts#L54)
   *  [@Patch](https://github.com/travetto/travetto/tree/master/module/rest/src/decorator/endpoint.ts#L48)
   *  [@Head](https://github.com/travetto/travetto/tree/master/module/rest/src/decorator/endpoint.ts#L60)
   *  [@Options](https://github.com/travetto/travetto/tree/master/module/rest/src/decorator/endpoint.ts#L66)

Each endpoint decorator handles the following config:
   
   *  `title` - The definition of the endpoint
   *  `description` - High level description fo the endpoint
   *  `responseType?` - Class describing the response type
   *  `requestType?` - Class describing the request body

[JSDoc](http://usejsdoc.org/about-getting-started.html) comments can also be used to define the `title` attribute, as well as describing the parameters using `@param` tags in the comment.

Additionally, the return type of the method will also be used to describe the `responseType` if not specified manually.

**Code: Controller with Sample Route**
```typescript
import { Get, Controller } from '@travetto/rest';

class Data { }

@Controller('/simple')
class SimpleController {

  /**
   * Gets the most basic of data
   */
  @Get('/')
  async simpleGet() {
    let data: Data | undefined;
    //
    return data;
  }
}
```

**Note**: In development mode the module supports hot reloading of `class`es.  Routes can be added/modified/removed at runtime.

### Parameters

Endpoints can be configured to describe and enforce parameter behavior.  Request parameters can be defined in five areas:
   
   *  [@Path](https://github.com/travetto/travetto/tree/master/module/rest/src/decorator/param.ts#L52) - Path params
   *  [@Query](https://github.com/travetto/travetto/tree/master/module/rest/src/decorator/param.ts#L58) - Query params
   *  [@Body](https://github.com/travetto/travetto/tree/master/module/rest/src/decorator/param.ts#L70) - Request body (in it's entirety)
   *  [@Header](https://github.com/travetto/travetto/tree/master/module/rest/src/decorator/param.ts#L64) - Header values
   *  [@Context](https://github.com/travetto/travetto/tree/master/module/rest/src/decorator/param.ts#L46) - Special values exposed (e.g. [TravettoRequest](https://github.com/travetto/travetto/tree/master/module/rest/src/types.d.ts#L14), [TravettoResponse](https://github.com/travetto/travetto/tree/master/module/rest/src/types.d.ts#L86), etc.)

Each [@Param](https://github.com/travetto/travetto/tree/master/module/rest/src/decorator/param.ts#L33) can be configured to indicate:
   
   *  `name` - Name of param, field name, defaults to handler parameter name if necessary
   *  `description` - Description of param, pulled from [JSDoc](http://usejsdoc.org/about-getting-started.html), or defaults to name if empty
   *  `required?` - Is the field required?, defaults to whether or not the parameter itself is optional
   *  `type` - The class of the type to be enforced, pulled from parameter type

[JSDoc](http://usejsdoc.org/about-getting-started.html) comments can also be used to describe parameters using `@param` tags in the comment.

**Code: Full-fledged Controller with Routes**
```typescript
import { Get, Controller, Post, Path, Body, Context, Query, Request } from '@travetto/rest';
import { MockService } from './mock';

@Controller('/simple')
export class Simple {

  constructor(private service: MockService) { }

  /**
   * Get a random user by name
   */
  @Get('/name')
  async getName() {
    const user = await this.service.fetch();
    return `/simple/name => ${user.first.toLowerCase()}`;
  }

  /**
   * Get a user by id
   */
  @Get('/:id')
  async getById(@Path() id: number) {
    const user = await this.service.fetch(id);
    return `/simple/id => ${user.first.toLowerCase()}`;
  }

  @Post('/name')
  async createName(@Body() person: { name: string }) {
    await this.service.update({ name: person.name });
    return { success: true };
  }

  @Get(/\/img(.*)[.](jpg|png|gif)/)
  async getImage(@Context() req: Request, @Query('w') width?: number, @Query('h') height?: number) {
    const img = await this.service.fetchImage(req.path, { width, height });
    return img;
  }
}
```

## Input/Output

The module provides standard structure for rendering content on the response.  This includes:
   
   *  JSON
   *  String responses
   *  Files

Per the [Base](https://github.com/travetto/travetto/tree/master/module/base#readme "Application phase management, environment config and common utilities for travetto applications.") module, the following types automatically have rest support as well:
   
   *  `Map` - Serializes as a JSON object
   *  `Set` - Serializes as an array
   *  `Error` - Serializes to a standard object, with status, and the error message.
   *  `AppError` - Serializes like `Error` but translates the error category to an HTTP status

Additionally, the [Schema](https://github.com/travetto/travetto/tree/master/module/schema#readme "Data type registry for runtime validation, reflection and binding. ") module supports typing requests and request bodies for run-time validation of requests. 

## Running an App

By default, the framework provices a default [@Application](https://github.com/travetto/travetto/tree/master/module/app/src/decorator.ts#L25) at [RestApplication](https://github.com/travetto/travetto/tree/master/module/rest/src/application/rest.ts#L23) that will follow default behaviors, and spin up the REST server.  You will need to install the [Application](https://github.com/travetto/travetto/tree/master/module/app#readme "Application registration/management and run support.") module to execute.  

**Install: Installing app support**
```bash
npm install @travetto/app
```

**Terminal: Standard application**
```bash
$ trv run

Usage: trv run [options] [application] [args...]

Options:
  -e, --env <env>            Application environment
  -p, --profile <profile>    Additional application profiles (default: [])
  -r, --resource <resource>  Additional resource locations (default: [])
  -h, --help                 display help for command

Available Applications:

   ● rest Default rest application entrypoint
     ----------------------------------------
     usage: rest 
     file:  src/application/rest.ts
```

### Creating a Custom App
To customize a REST server, you may need to construct an entry point using the [@Application](https://github.com/travetto/travetto/tree/master/module/app/src/decorator.ts#L25) decorator. This could look like:

**Code: Application entry point for Rest Applications**
```typescript
import { Application } from '@travetto/app';
import { RestApplication } from '@travetto/rest';

@Application('custom')
export class SampleApp extends RestApplication {

  run() {
    // Configure server before running
    return super.run();
  }
}
```

And using the pattern established in the [Application](https://github.com/travetto/travetto/tree/master/module/app#readme "Application registration/management and run support.") module, you would run your program using `npx trv run custom`.

**Terminal: Custom application**
```bash
$ trv run

Usage: trv run [options] [application] [args...]

Options:
  -e, --env <env>            Application environment
  -p, --profile <profile>    Additional application profiles (default: [])
  -r, --resource <resource>  Additional resource locations (default: [])
  -h, --help                 display help for command

Available Applications:

   ● custom 
     ------------------------
     usage: custom 
     file:  doc/custom-app.ts

   ● rest Default rest application entrypoint
     ----------------------------------------
     usage: rest 
     file:  src/application/rest.ts
```

## Interceptors

[RestInterceptor](https://github.com/travetto/travetto/tree/master/module/rest/src/interceptor/types.ts#L11)s  are a key part of the rest framework, to allow for conditional functions to be added, sometimes to every route, and other times to a select few. Express/Koa/Fastify are all built around the concept of middleware, and interceptors are a way of representing that.

**Code: A Trivial Intereptor**
```typescript
import { RestInterceptor, SerializeInterceptor, Request, Response } from '@travetto/rest';
import { Injectable } from '@travetto/di';

@Injectable()
export class HelloWorldInterceptor implements RestInterceptor {

  after = [SerializeInterceptor];

  intercept(req: Request, res: Response) {
    console.log('Hello world!');
  }
}
```

**Note**: The example above defines the interceptor to run after another interceptor class. The framework will automatically sort the interceptors by the before/after reuirements to ensure the appropriate order of execution.

Out of the box, the rest framework comes with a few interceptors, and more are contributed by other modules as needed.  The default interceptor set is:
   
   1. [SerializeInterceptor](https://github.com/travetto/travetto/tree/master/module/rest/src/interceptor/serialize.ts#L21) - This is what actually sends the response to the requestor. Given the ability to prioritize interceptors, another interceptor can have higher priority and allow for complete customization of response handling.
   1. [CorsInterceptor](https://github.com/travetto/travetto/tree/master/module/rest/src/interceptor/cors.ts#L39) - This interceptor allows cors functionality to be configured out of the box, by setting properties in your `application.yml`, specifically, `rest.cors.active: true`
     
   **Code: Cors Config**
   ```typescript
   export class RestCorsConfig {
     /**
      * Is cors active
      */
     active: boolean = false;
     /**
      * Allowed origins
      */
     origins?: string[];
     /**
      * Allowed http methods
      */
     methods?: Request['method'][];
     /**
      * Allowed http headers
      */
     headers?: string[];
     /**
      * Support credentials?
      */
     credentials?: boolean;
   }
   ```
   
   1. [CookiesInterceptor](https://github.com/travetto/travetto/tree/master/module/rest/src/interceptor/cookies.ts#L52) - This interceptor is responsible for processing inbound cookie headers and populating the appropriate data on the request, as well as sending the appropriate response data
     
   **Code: Cookies Config**
   ```typescript
   export class RestCookieConfig implements cookies.SetOption {
     /**
      * Are cookies supported
      */
     active = true;
     /**
      * Are they signed
      */
     signed = true;
     /**
      * Supported only via http (not in JS)
      */
     httpOnly = true;
     /**
      * Enforce same site policy
      */
     sameSite: cookies.SetOption['sameSite'] | 'lax' = 'lax';
     /**
      * The signing keys
      */
     keys = ['default-insecure'];
     /**
      * Is the cookie only valid for https
      */
     secure?: boolean;
     /**
      * The domain of the cookie
      */
     domain?: string;
   }
   ```
   
   1. [GetCacheInterceptor](https://github.com/travetto/travetto/tree/master/module/rest/src/interceptor/get-cache.ts#L12) - This interceptor, by default, disables caching for all GET requests if the response does not include caching headers.  This can be disabled by setting `rest.disableGetCache: true` in your config.
   1. [LoggingInterceptor](https://github.com/travetto/travetto/tree/master/module/rest/src/interceptor/logging.ts#L61) - This interceptor allows for logging of all requests, and their response codes.  You can deny/allow specific routes, by setting config like so
   
     
   **Code: Control Logging**
   ```yaml
   rest.logRoutes.{deny|allow}:
   - '/controller1'
   - '/controller1:*'
   - '/controller2:/path'
   - '/controller3:/path/*`
   ```
   

### Custom Interceptors
Additionally it is sometimes necessary to register custom interceptors.  Interceptors can be registered with the [Dependency Injection](https://github.com/travetto/travetto/tree/master/module/di#readme "Dependency registration/management and injection support.") by extending the [RestInterceptor](https://github.com/travetto/travetto/tree/master/module/rest/src/interceptor/types.ts#L11) class.  The interceptors are tied to the defined [TravettoRequest](https://github.com/travetto/travetto/tree/master/module/rest/src/types.d.ts#L14) and [TravettoResponse](https://github.com/travetto/travetto/tree/master/module/rest/src/types.d.ts#L86) objects of the framework, and not the underlying app framework.  This allows for Interceptors to be used across multiple frameworks as needed. A simple logging interceptor:

**Code: Defining a new Interceptor**
```typescript
import { Request, Response, RestInterceptor } from '@travetto/rest';
import { Injectable } from '@travetto/di';

class Appender {
  write(...args: unknown[]): void { }
}

@Injectable()
export class LoggingInterceptor implements RestInterceptor {

  constructor(private appender: Appender) { }

  async intercept(req: Request, res: Response) {
    // Write request to database
    this.appender.write(req.method, req.path, req.query);
  }
}
```

A `next` parameter is also available to allow for controlling the flow of the request, either by stopping the flow of interceptors, or being able to determine when a request starts, and when it is ending.

**Code: Defining a fully controlled Interceptor**
```typescript
import { RestInterceptor, Request, Response } from '@travetto/rest';
import { Injectable } from '@travetto/di';

@Injectable()
export class LoggingInterceptor implements RestInterceptor {
  async intercept(req: Request, res: Response, next: () => Promise<unknown>) {
    const start = Date.now();
    try {
      await next();
    } finally {
      console.log('Request complete', { time: Date.now() - start });
    }
  }
}
```

Currently [Asset Rest Support](https://github.com/travetto/travetto/tree/master/module/asset-rest#readme "Provides integration between the travetto asset and rest module.") is implemented in this fashion, as well as [Rest Auth](https://github.com/travetto/travetto/tree/master/module/auth-rest#readme "Rest authentication integration support for the travetto framework").

## Cookie Support
[express](https://expressjs.com)/[koa](https://koajs.com/)/[fastify](https://www.fastify.io/) all have their own cookie implementations that are common for each framework but are somewhat incompatible.  To that end, cookies are supported for every platform, by using [cookies](https://www.npmjs.com/package/cookies).  This functionality is exposed onto the [TravettoRequest](https://github.com/travetto/travetto/tree/master/module/rest/src/types.d.ts#L14)/[TravettoResponse](https://github.com/travetto/travetto/tree/master/module/rest/src/types.d.ts#L86) object following the pattern set forth by Koa (this is the library Koa uses).  This choice also enables better security support as we are able to rely upon standard behavior when it comes to cookies, and signing.

**Code: Sample Cookie Usage**
```typescript
import { GetOption, SetOption } from 'cookies';

import { Controller, Get, Query, Request, Response } from '@travetto/rest';

@Controller('/simple')
export class SimpleRoutes {

  private getOptions: GetOption;
  private setOptions: SetOption;

  @Get('/cookies')
  cookies(req: Request, res: Response, @Query() value: string) {
    req.cookies.get('name', this.getOptions);
    res.cookies.set('name', value, this.setOptions);
  }
}
```

## SSL Support

Additionally the framework supports SSL out of the box, by allowing you to specify your public and private keys for the cert.  In dev mode, the framework will also automatically generate a self-signed cert if:
   
   *  SSL support is configured
   *  [node-forge](https://www.npmjs.com/package/node-forge) is installed
   *  Not running in prod
   *  No keys provided

This is useful for local development where you implicitly trust the cert.

SSL support can be enabled by setting `rest.ssl.active: true` in your config. The key/cert can be specified as string directly in the config file/environment variables.  The key/cert can also be specified as a path to be picked up by the [ResourceManager](https://github.com/travetto/travetto/tree/master/module/base/src/resource.ts).

## Full Config
The entire [RestConfig](https://github.com/travetto/travetto/tree/master/module/rest/src/application/config.ts#L13) which will show the full set of valid configuration parameters for the rest module.

## Serverless
### AWS Lambda

The module provides support basic support with AWS lambdas. When using one of the specific rest modules (e.g. [Express REST Source](https://github.com/travetto/travetto/tree/master/module/rest-express#readme "Express provider for the travetto rest module.")), you can install the appropriate lambda-related dependencies installed (e.g. [aws-serverless-express](https://github.com/awslabs/aws-serverless-express/blob/master/README.md)) to enable integration with AWS.  Nothing in the code needs to be modified to support the AWS integration, but there are some limitations of using AWS Lambdas as HTTP handlers. 

## Packaging Lambdas

**Terminal: Invoking a Package Build**
```bash
$ trv pack rest/lambda -h

Missing Package
--------------------
To use pack please run:

npm i --save-dev @travetto/pack
```

## Extension - Schema

The module provides high level access for [Schema](https://github.com/travetto/travetto/tree/master/module/schema#readme "Data type registry for runtime validation, reflection and binding. ") support, via decorators, for validating and typing request bodies.

[@SchemaBody](https://github.com/travetto/travetto/tree/master/module/rest/src/extension/schema.ts#L82) provides the ability to convert the inbound request body into a schema bound object, and provide validation before the controller even receives the request.

**Code: Using SchemaBody for POST requests**
```typescript
import { Schema } from '@travetto/schema';
import { Controller, Post, SchemaBody } from '@travetto/rest';

@Schema()
class User {
  name: string;
  age: number;
}

@Controller('/user')
class UserController {

  private service: {
    update(user: User): Promise<User>;
  };

  @Post('/saveUser')
  async save(@SchemaBody() user: User) {
    user = await this.service.update(user);
    return { success: true };
  }
}
```

[@SchemaQuery](https://github.com/travetto/travetto/tree/master/module/rest/src/extension/schema.ts#L94) provides the ability to convert the inbound request query into a schema bound object, and provide validation before the controller even receives the request.

**Code: Using SchemaQuery for GET requests**
```typescript
import { Schema } from '@travetto/schema';
import { Controller, Get, SchemaQuery } from '@travetto/rest';

@Schema()
class SearchParams {
  page: number = 0;
  pageSize: number = 100;
}

@Controller('/user')
class UserController {

  private service: {
    search(query: SearchParams): Promise<number[]>;
  };

  @Get('/search')
  async search(@SchemaQuery() query: SearchParams) {
    return await this.service.search(query);
  }
}
```

Addtionally, [@SchemaQuery](https://github.com/travetto/travetto/tree/master/module/rest/src/extension/schema.ts#L94) and [@SchemaBody](https://github.com/travetto/travetto/tree/master/module/rest/src/extension/schema.ts#L82) can also be used with `interface`s and `type` literals in lieu of classes. This is best suited for simple types:

**Code: Using SchemaQuery with a type literal**
```typescript
import { Controller, Get, SchemaQuery } from '@travetto/rest';

type Paging = {
  page?: number;
  pageSize?: number;
};

@Controller('/user')
class UserController {

  private service: {
    search(query: Paging): Promise<number>;
  };

  @Get('/search')
  async search(@SchemaQuery() query: Paging = { page: 0, pageSize: 100 }) {
    return await this.service.search(query);
  }
}
```

## Extension - Model

To facilitate common RESTful patterns, the module exposes  [Data Modeling Support](https://github.com/travetto/travetto/tree/master/module/model#readme "Datastore abstraction for core operations.") support in the form of [ModelRoutes](https://github.com/travetto/travetto/tree/master/module/rest/src/extension/model.ts#L21).

**Code: ModelRoutes example**
```typescript
import { Inject } from '@travetto/di';
import { ModelCrudSupport } from '@travetto/model';
import { Controller, ModelRoutes } from '@travetto/rest';

import { User } from './user';

@Controller('/user')
@ModelRoutes(User)
class UserController {
  @Inject()
  source: ModelCrudSupport;
}
```

is a shorthand that is equal to:

**Code: Comparable UserController, built manually**
```typescript
import { Inject } from '@travetto/di';
import { ModelCrudSupport } from '@travetto/model';
import { Path, Controller, SchemaBody, Get, Request, Delete, Post, Put } from '@travetto/rest';

import { User } from './user';

@Controller('/user')
class UserController {

  @Inject()
  service: ModelCrudSupport;

  @Get('')
  async getAllUser(req: Request) {
    return await this.service.list(User);
  }

  @Get(':id')
  async getUser(@Path() id: string) {
    return await this.service.get(User, id);
  }

  @Delete(':id')
  async deleteUser(@Path() id: string) {
    return await this.service.delete(User, id);
  }

  @Post('')
  async saveUser(@SchemaBody() user: User) {
    return await this.service.create(User, user);
  }

  @Put('')
  async updateUser(@SchemaBody() user: User) {
    return await this.service.update(User, user);
  }
}
```

## Extension - Model Query

Additionally, [Data Model Querying](https://github.com/travetto/travetto/tree/master/module/model-query#readme "Datastore abstraction for advanced query support.") support can also be added support in the form of [ModelQueryRoutes](https://github.com/travetto/travetto/tree/master/module/rest/src/extension/model-query.ts#L42). This provides listing by query as well as an endpoint to facillitate suggestion behaviors.

**Code: ModelQueryRoutes example**
```typescript
import { Inject } from '@travetto/di';
import { ModelQuerySupport } from '@travetto/model-query';
import { Controller, ModelQueryRoutes } from '@travetto/rest';

import { User } from './user';

@Controller('/user')
@ModelQueryRoutes(User)
class UserQueryController {
  @Inject()
  source: ModelQuerySupport;
}
```

is a shorthand that is equal to:

**Code: Comparable UserController, built manually**
```typescript
import { Inject } from '@travetto/di';
import { ModelQuerySupport, SortClause, ValidStringFields } from '@travetto/model-query';
import { isQuerySuggestSupported } from '@travetto/model-query/src/internal/service/common';
import { Controller, Get, Path, SchemaQuery } from '@travetto/rest';
import { RestModelQuery, RestModelSuggestQuery } from '@travetto/rest/src/extension/model-query';

import { User } from './user';

const convert = <T>(k?: string) => k && typeof k === 'string' && /^[\{\[]/.test(k) ? JSON.parse(k) as T : k;

@Controller('/user')
class UserQueryController {

  @Inject()
  service: ModelQuerySupport;

  @Get('')
  async getAllUser(@SchemaQuery() query: RestModelQuery) {
    return this.service.query(User, {
      limit: query.limit,
      offset: query.offset,
      sort: convert(query.sort) as SortClause<User>[],
      where: convert(query.where)
    });
  }

  @Get('/suggest/:field')
  async suggest(@Path() field: ValidStringFields<User>, @SchemaQuery() suggest: RestModelSuggestQuery) {
    if (isQuerySuggestSupported(this.service)) {
      return this.service.suggest(User, field, suggest.q, suggest);
    }
  }
}
```
