import { existsSync } from 'fs';

import * as path from '@travetto/path';
import { PackageUtil } from '@travetto/boot';
import { Env } from '@travetto/base';

import { AllType, AllTypeMap, node as n } from '../nodes';
import { DocNode, RenderContextShape } from '../types';

export type AllChildren = AllType;

/**
 * Render context
 */
export class RenderContext implements RenderContextShape {

  file: string;

  constructor(file: string) {
    this.file = path.toPosix(file);
  }

  get #repoUrl(): string {
    return (PackageUtil.main.repository?.url ?? '').replace(/[.]git$/, '');
  }

  get gitBaseUrl(): string {
    return `${this.#repoUrl}/tree/${Env.get('TRV_DOC_BRANCH', 'main')}`;
  }

  get travettoGitBaseUrl(): string {
    return this.#repoUrl.includes('travetto/travetto') ? this.gitBaseUrl : 'https://github.com/travetto/travetto/main';
  }

  get gitFolder(): string {
    const cwd = path.cwd();
    let base = cwd;

    while (base && !(existsSync(path.resolve(base, '.git')))) {
      base = path.dirname(base);
    }

    return `${this.gitBaseUrl}${cwd.replace(base, '')}`;
  }

  toc(root: DocNode): AllTypeMap['Ordered'] {
    return n.Ordered(
      // eslint-disable-next-line @typescript-eslint/consistent-type-assertions
      ...(root as AllTypeMap['Group']).nodes
        .filter(x => x._type === 'section')
        .map(x => {
          // eslint-disable-next-line @typescript-eslint/consistent-type-assertions
          const { title } = x as AllTypeMap['Section'];
          return n.Anchor(title, title);
        })
    );
  }

  get preamble(): AllTypeMap['Group'] {
    return n.Group([
      n.Comment('This file was generated by @travetto/doc and should not be modified directly'),
      n.Text('\n'),
      n.Comment(`Please modify ${this.file.replace(path.cwd(), this.gitFolder)} and execute "npx trv doc" to rebuild`),
    ]);
  }

  link(text: string, line?: number | { [key: string]: unknown, line?: number }): string {
    const num = typeof line === 'number' ? line : line?.line;
    return `${text.replace(path.cwd(), this.gitBaseUrl)
      .replace(/.*@travetto\//, `${this.travettoGitBaseUrl}/module/`)}${num ? `#L${num}` : ''}`;
  }

  cleanText(a?: string): string {
    return a ? a.replace(/^[\n ]+|[\n ]+$/gs, '') : '';
  }

  getAnchorId(a: string): string {
    return a.toLowerCase().replace(/<[^>]+>/g, ' ').replace(/[^a-z0-9]+/g, ' ').trim().replace(/ /g, '-');
  }
}