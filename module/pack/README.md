<!-- This file was generated by the framweork and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/master/module/pack/doc.ts and execute "npm run docs" to rebuild -->
# Pack
## Code packing utilities

**Install: @travetto/pack**
```bash
npm install @travetto/pack
```

## CLI - pack 

**Terminal: Pack usage**
```bash
$ trv pack --help

Usage:  pack [options] [mode]

Options:
  -w --workspace [workspace]  Workspace directory (default: "/tmp/pack_travetto_pack")
  -h, --help                  display help for command

Available Pack Modes:
  * default [support/pack.config.ts]
  * rest/aws-lambda [@travetto/rest/support/pack.aws-lambda.ts]
  * rest/docker [@travetto/rest/support/pack.docker.ts]
```

This command line operation will compile your project, and produce a ready to use workspace as a deliverable. The pack operation is actually a wrapper around multiple sub-operations that are run in series to produce the desired final structure for deployment.  The currently support operations are:

   
   *  assemble
   *  zip
   *  docker

### CLI - pack:assemble

Assemble is the operation that stages the project's code for deployment.  The assembly process goes through the following operations:

   
   1. Cleaning Workspace - Cleans workspace to start with an empty workspace
   1. Copying Dependencies - Computes the prod depedencies and copies them into the new workspace
   1. Copying App Content - Copies over application content (src/resources/support/bin)
   1. Excluding Pre-Compile Files - Any files that should be excluded pre-compilation, are removed
   1. Compiling - Compiles the code in the new workspace, isolating it from your local development
   1. Excluding Post-Compile Files - Removes any files that should be excluded, post compilation
   1. Copying Added Content - Adds in any additional content that is not in the standard locations
   1. Removing Empty Folders - Purge all empty folders, recursively
   1. Writng Env.js - Write out the .env.js file with computed any env vars that should be set for the deployed app
   1. Remove Source Maps - If keep source is false, all source maps are purged from your app's code
   1. Emptying .ts Files - If keep source is false, all .ts files are emptied, as compilation will not occur at runtime

**Code: Assemble Default Config**
```typescript
assemble: {
    active: true,
    cacheDir: 'cache',
    keepSource: true,
    readonly: true,
    add: [
      { 'node_modules/@travetto/cli/bin/trv.js': 'node_modules/.bin/trv' },
      { 'node_modules/lodash/lodash.min.js': 'node_modules/lodash/lodash.js' },
    ],
    excludeCompile: [
      'node_modules/@travetto/*/alt/',
      'node_modules/@travetto/*/test/',
    ],
    exclude: [
      'bower.json',
      'LICENSE',
      'LICENCE',
      '*.map',
      '*.md',
      '*.lock',
      '*.html',
      '*.mjs',
      '*.ts',
      '*.d.ts',
```

**Terminal: Assemble Usage**
```bash
$ trv pack:assemble --help

Usage:  pack:assemble [options] [mode]

Options:
  -w --workspace [workspace]  Workspace directory (default: "/tmp/pack_travetto_pack")
  -k --keep-source [boolean]  Should source be preserved (default: true)
  -r --readonly [boolean]     Build a readonly deployable (default: true)
  -h, --help                  display help for command

Available Pack Modes:
  * default [support/pack.config.ts]
  * rest/aws-lambda [@travetto/rest/support/pack.aws-lambda.ts]
  * rest/docker [@travetto/rest/support/pack.docker.ts]
```

### CLI - pack:zip

Zip is an optional step, that can run post assembly.  The only configuration it currently provides is the ability to specify the output location for the zip file.

**Code: Zip Default Config**
```typescript
zip: {
    active: false,
    output: 'output.zip'
  },
```

**Terminal: Zip Usage**
```bash
$ trv pack:zip --help

Usage:  pack:zip [options] [mode]

Options:
  -w --workspace [workspace]  Workspace directory (default: "/tmp/pack_travetto_pack")
  -o --output [output]        Output File (default: "output.zip")
  -h, --help                  display help for command

Available Pack Modes:
  * default [support/pack.config.ts]
  * rest/aws-lambda [@travetto/rest/support/pack.aws-lambda.ts]
  * rest/docker [@travetto/rest/support/pack.docker.ts]
```

### Modes
Various modules may provide customizations to the default `pack.config.ts` to allow for easy integration with the packing process.  A simple example of this is via the [RESTful API](https://github.com/travetto/travetto/tree/master/module/rest#readme "Declarative api for RESTful APIs with support for the dependency injection module.") module, for how to publish lambda packages.

**Code: Rest, pack.lambda.ts**
```typescript
import * as fs from 'fs';
import { AppCache, PathUtil } from '@travetto/boot';

import type { AllConfigPartial } from '@travetto/pack/bin/operation/pack';

export const config: AllConfigPartial = {
  name: 'rest/aws-lambda',
  assemble: {
    active: true,
    keepSource: false,
    exclude: [
      'node_modules/node-forge'
    ],
    env: {
      NO_COLOR: 1
    },
    postProcess: [{
      ['Install Entrypoint']: async (cfg: { cacheDir: string, workspace: string }) => {
        const Entrypoint = AppCache.toEntryName(require.resolve('@travetto/rest/support/entry.aws-lambda.ts'))
          .replace(AppCache.cacheDir, PathUtil.resolveUnix(cfg.workspace, cfg.cacheDir));
        await fs.promises.copyFile(Entrypoint, PathUtil.resolveUnix(cfg.workspace, 'index.js'));
      }
    }],
  },
  zip: {
    active: true,
    output: 'dist/lambda.zip'
  }
};
```

**Terminal: Invoking Pack with Mode**
```bash
npx trv pack <mode>
```

### Configuration

By default, the configuration consists of two components.
* The default config in `support/pack.config.ts` and
* The config selected to execute from the cli

These two configurations will be loaded and layered, with the selected config taking precedence.

**Code: Example pack.config.ts**
```typescript
import type { AllConfigPartial } from '@travetto/pack/bin/operation/pack';

export const config: AllConfigPartial = {
  workspace: 'dist/alt',
  assemble: {
    active: true,
    add: [
      { assets: 'assets' },
      { '/secret/location/key.pem': 'resources/key.pem' }
    ]
  },
  zip: {
    active: true,
    output: 'dist/build.zip'
  }
};
```
