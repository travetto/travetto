<!-- This file was generated by @travetto/doc and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/main/module/pack/DOC.ts and execute "npx trv doc" to rebuild -->
<h1>Pack
          <small>Code packing utilities</small>

        </h1>

      <figure class="install">
      <figcaption class="install">Install @travetto/pack
      
      </figcaption>
      <pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> @travetto/pack

<span class="token comment"># or</span>

<span class="token function">yarn</span> <span class="token function">add</span> @travetto/pack</code></pre>     
      </figure>

This module provides the necessary tools to produce deliverable output for <a target="_blank" class="external-link" href="https://travetto.dev">Travetto</a> based projects.  The main interaction with this module is through the command line interface, and the operations it provides.  Under the covers, the code bundling is performed by <a target="_blank" class="external-link" href="https://rollupjs.org/">Rollup</a>, with specific configuration to support the frameworks runtime expectations.

There are three primary cli commands for packing your code:
<ul> <li>pack</li>
 <li>pack:zip</li>
 <li>pack:docker</li></ul>

<h2 id="cli-pack">CLI - pack</h2> 

      <figure class="terminal">
      <figcaption class="terminal">Pack usage
      
      </figcaption>
      <pre><code class="language-bash">$ trv pack <span class="token parameter variable">--help</span>

Usage:  pack <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>args<span class="token punctuation">..</span>.<span class="token punctuation">]</span>

Options:
  -w, <span class="token parameter variable">--workspace</span> <span class="token operator">&lt;</span>workspace<span class="token operator">></span>         Workspace <span class="token keyword">for</span> building
  -c, --no-clean                      Disables: Clean workspace
  -o, <span class="token parameter variable">--output</span> <span class="token operator">&lt;</span>output<span class="token operator">></span>               Output location
  -es, --main-scripts <span class="token operator">&lt;</span>main-scripts<span class="token operator">></span>  Create entry scripts
  -f, --main-name <span class="token operator">&lt;</span>main-name<span class="token operator">></span>         Main name <span class="token keyword">for</span> build artifact <span class="token punctuation">(</span>default: <span class="token string">"cli"</span><span class="token punctuation">)</span>
  -e, --entry-point <span class="token operator">&lt;</span>entry-point<span class="token operator">></span>     Entry point <span class="token punctuation">(</span>default: <span class="token string">"@travetto/cli/support/entry.cli"</span><span class="token punctuation">)</span>
  -m, --no-minify                     Disables: Minify output
  -sm, <span class="token parameter variable">--sourcemap</span>                    Bundle <span class="token builtin class-name">source</span> maps
  -is, --include-sources              Include <span class="token builtin class-name">source</span> with <span class="token builtin class-name">source</span> maps
  -x, --eject-file <span class="token operator">&lt;</span>eject-file<span class="token operator">></span>       Eject commands to <span class="token function">file</span>
  -h, <span class="token parameter variable">--help</span>                          display <span class="token builtin class-name">help</span> <span class="token keyword">for</span> <span class="token builtin class-name">command</span></code></pre>     
      </figure>

This command line operation will compile your project, and produce a ready to use workspace as a deliverable. Additionally, you can pass in a file to the <code class="item input">eject-file</code> flag that will allow for a script to be produced (base on the host operating system).

Specific to this CLI command, the <code class="item input">output</code> field determines where the final folder is written that contains all the compiled source. 

<h3 id="entry-point-configuration">Entry Point Configuration</h3>
Every application requires an entry point to determine execution flow (and in <a target="_blank" class="external-link" href="https://rollupjs.org/">Rollup</a>'s case, tree-shaking as well.).  By default the <a class="module-link" href="https://github.com/travetto/travetto/tree/main/module/cli" title="CLI infrastructure for Travetto framework">Command Line Interface</a> acts as the entry point.  This bypasses the <a class="module-link" href="https://github.com/travetto/travetto/tree/main/module/compiler" title="The compiler infrastructure for the Travetto framework">Compiler</a> intentionally, as the compiler is not available at runtime.

Within the command line, the <code class="item input">args</code> are positional arguments that will be passed to the entry point on application run. 

      <figure class="code">
      <figcaption class="code">Packing an application run
      
      </figcaption>
      <pre><code class="language-typescript">$ npx trv pack run myapp</code></pre>     
      </figure>

Would then produce an executable script, in the output folder, that would look like:

      <figure class="code">
      <figcaption class="code">Entry script for Packed application
      
      </figcaption>
      <pre><code class="language-typescript"><span class="token hashbang comment">#!/bin/sh</span>
cd <span class="token function">$</span><span class="token punctuation">(</span>dirname <span class="token string">"$0"</span><span class="token punctuation">)</span>
node cli run myapp</code></pre>     
      </figure>

And this entry point would be what is executed by <a target="_blank" class="external-link" href="https://www.docker.com/community-edition">docker</a>, or whatever deployment mechanism is being used.

<h3 id="general-packing-operations">General Packing Operations</h3>
Every <a class="module-link" href="https://github.com/travetto/travetto/tree/main/module/pack" title="Code packing utilities">Pack</a> operation extends from the base command, and that provides some consistent operations that run on every packing command.

<ul> <li><code class="item method">clean</code> - Empties workspace before beginning, controlled by the <code class="item input">--clean</code> flag, defaults to on</li>
 <li><code class="item method">writeEnv</code> - Writes the .env.js files that includes the necessary details to start the application.  This is primarily to identify the location of the manifest file needed to run.</li>
 <li><code class="item method">writePackageJson</code> - Generates the <a target="_blank" class="external-link" href="https://docs.npmjs.com/cli/v9/configuring-npm/package-json">Package JSON</a> with the appropriate module type (<a target="_blank" class="external-link" href="https://nodejs.org/api/modules.html">CommonJS</a> or <a target="_blank" class="external-link" href="https://nodejs.org/api/esm.html">Ecmascript Module</a>) for interpreting plain <code class="item path">.js</code> files</li>
 <li><code class="item method">writeEntryScript</code> - Create the entry script based on the <code class="item input">--entry-command</code>, <code class="item input">args</code></li>
 <li><code class="item method">copyResources</code> - Will pull in local <code class="item path">resources/**</code> files into the final output</li>
 <li><code class="item method">primeAppCache</code> - Runs <code class="item input">trv run</code> to ensure the appropriate files are generated to allow for running the application.  This only applies if the entry point is equivalent to <code class="item input">trv run</code></li>
 <li><code class="item method">writeManifest</code> - Produces the <code class="item input">prod</code>-ready manifest that is used at runtime.  Removes all devDependencies from the manifest.json</li>
 <li><code class="item method">bundle</code> - Invokes <a target="_blank" class="external-link" href="https://rollupjs.org/">Rollup</a> with the appropriate file set to produce a single output .js file.  Depending on the module type (<a target="_blank" class="external-link" href="https://nodejs.org/api/modules.html">CommonJS</a> or <a target="_blank" class="external-link" href="https://nodejs.org/api/esm.html">Ecmascript Module</a>) the build process differs to handle the dynamic loading that application does at runtime.</li></ul>

<h2 id="cli-pack-zip">CLI - pack:zip</h2>

This command is nearly identical to the standard <code class="item input">pack</code> operation, except for the <code class="item input">output</code> flag.  In this scenario, the <code class="item input">output</code> flag determines the location and name of the final zip file. 

      <figure class="terminal">
      <figcaption class="terminal">Pack:zip usage
      
      </figcaption>
      <pre><code class="language-bash">$ trv pack:zip <span class="token parameter variable">--help</span>

Usage:  pack:zip <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>args<span class="token punctuation">..</span>.<span class="token punctuation">]</span>

Options:
  -w, <span class="token parameter variable">--workspace</span> <span class="token operator">&lt;</span>workspace<span class="token operator">></span>         Workspace <span class="token keyword">for</span> building
  -c, --no-clean                      Disables: Clean workspace
  -o, <span class="token parameter variable">--output</span> <span class="token operator">&lt;</span>output<span class="token operator">></span>               Output location <span class="token punctuation">(</span>default: <span class="token string">"travetto_pack.zip"</span><span class="token punctuation">)</span>
  -es, --main-scripts <span class="token operator">&lt;</span>main-scripts<span class="token operator">></span>  Create entry scripts
  -f, --main-name <span class="token operator">&lt;</span>main-name<span class="token operator">></span>         Main name <span class="token keyword">for</span> build artifact <span class="token punctuation">(</span>default: <span class="token string">"cli"</span><span class="token punctuation">)</span>
  -e, --entry-point <span class="token operator">&lt;</span>entry-point<span class="token operator">></span>     Entry point <span class="token punctuation">(</span>default: <span class="token string">"@travetto/cli/support/entry.cli"</span><span class="token punctuation">)</span>
  -m, --no-minify                     Disables: Minify output
  -sm, <span class="token parameter variable">--sourcemap</span>                    Bundle <span class="token builtin class-name">source</span> maps
  -is, --include-sources              Include <span class="token builtin class-name">source</span> with <span class="token builtin class-name">source</span> maps
  -x, --eject-file <span class="token operator">&lt;</span>eject-file<span class="token operator">></span>       Eject commands to <span class="token function">file</span>
  -h, <span class="token parameter variable">--help</span>                          display <span class="token builtin class-name">help</span> <span class="token keyword">for</span> <span class="token builtin class-name">command</span></code></pre>     
      </figure>

<h2 id="cli-pack-docker">CLI - pack:docker</h2>

This command starts off identical to the standard <code class="item input">pack</code> operation, but it contains a few additional flags, and ultimately a few additional operations to support creating of the final <a target="_blank" class="external-link" href="https://www.docker.com/community-edition">docker</a> image.

      <figure class="terminal">
      <figcaption class="terminal">Pack:docker usage
      
      </figcaption>
      <pre><code class="language-bash">$ trv pack:docker <span class="token parameter variable">--help</span>

Usage:  pack:docker <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>args<span class="token punctuation">..</span>.<span class="token punctuation">]</span>

Options:
  -w, <span class="token parameter variable">--workspace</span> <span class="token operator">&lt;</span>workspace<span class="token operator">></span>               Workspace <span class="token keyword">for</span> building
  -c, --no-clean                            Disables: Clean workspace
  -o, <span class="token parameter variable">--output</span> <span class="token operator">&lt;</span>output<span class="token operator">></span>                     Output location
  -es, --main-scripts <span class="token operator">&lt;</span>main-scripts<span class="token operator">></span>        Create entry scripts
  -f, --main-name <span class="token operator">&lt;</span>main-name<span class="token operator">></span>               Main name <span class="token keyword">for</span> build artifact <span class="token punctuation">(</span>default: <span class="token string">"cli"</span><span class="token punctuation">)</span>
  -e, --entry-point <span class="token operator">&lt;</span>entry-point<span class="token operator">></span>           Entry point <span class="token punctuation">(</span>default: <span class="token string">"@travetto/cli/support/entry.cli"</span><span class="token punctuation">)</span>
  -m, --no-minify                           Disables: Minify output
  -sm, <span class="token parameter variable">--sourcemap</span>                          Bundle <span class="token builtin class-name">source</span> maps
  -is, --include-sources                    Include <span class="token builtin class-name">source</span> with <span class="token builtin class-name">source</span> maps
  -x, --eject-file <span class="token operator">&lt;</span>eject-file<span class="token operator">></span>             Eject commands to <span class="token function">file</span>
  -df, --docker-factory <span class="token operator">&lt;</span>docker-factory<span class="token operator">></span>    Docker Factory <span class="token builtin class-name">source</span> <span class="token punctuation">(</span>default: <span class="token string">"@travetto/pack/support/pack.dockerfile"</span><span class="token punctuation">)</span>
  -di, --docker-image <span class="token operator">&lt;</span>docker-image<span class="token operator">></span>        Docker Image to extend <span class="token punctuation">(</span>default: <span class="token string">"node:18-alpine3.16"</span><span class="token punctuation">)</span>
  -dn, --docker-name <span class="token operator">&lt;</span>docker-name<span class="token operator">></span>          Docker Image Name <span class="token punctuation">(</span>default: <span class="token string">"travetto_pack"</span><span class="token punctuation">)</span>
  -dt, --docker-tag <span class="token operator">&lt;</span>docker-tag<span class="token operator">></span>            Docker Image Tag <span class="token punctuation">(</span>default: <span class="token punctuation">[</span><span class="token string">"latest"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  -dp, --docker-port <span class="token operator">&lt;</span>docker-port<span class="token operator">></span>          Docker Image Port <span class="token punctuation">(</span>default: <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  -dx, --docker-push                        Docker Push Tags
  -dr, --docker-registry <span class="token operator">&lt;</span>docker-registry<span class="token operator">></span>  Docker Registry
  -h, <span class="token parameter variable">--help</span>                                display <span class="token builtin class-name">help</span> <span class="token keyword">for</span> <span class="token builtin class-name">command</span></code></pre>     
      </figure>

The additional flags provided are allow for specifying the base image, the final docker image name (and tags), and which registry to push to (if  any).  Additionally, there are flags for exposing which ports the image should expect to open as well.   When using the <code class="item input">--eject-file</code>  flag, the output script will produce the entire Dockerfile output inline, so that it can be easily modified as needed.

In addition to the standard operations, this command adds the following steps:
<ul> <li><code class="item method">writeDockerFile</code> - Generate the docker file contents</li>
 <li><code class="item method">pullDockerBaseImage</code> - Pull base image, to ensure its available and primed</li>
 <li><code class="item method">buildDockerContainer</code> - Build final container</li>
 <li><code class="item method">pushDockerContainer</code> - Push container with appropriate tags.  Only applies if <code class="item input">--docker-push</code> is specified</li></ul>

<h2 id="ejected-file">Ejected File</h2>

As indicated, any of the pack operations can be ejected, and produce an output that can be run independent of the pack command.  This is helpful when integrating with more complicated build processes.

      <figure class="terminal">
      <figcaption class="terminal">Sample Ejected File
      
      </figcaption>
      <pre><code class="language-bash">$ trv pack:docker <span class="token parameter variable">-x</span> /dev/stdout run rest

<span class="token comment">#!/bin/sh</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">DIST</span><span class="token operator">=</span>/tmp/_home_tim_Code_travetto_related_todo-app
<span class="token builtin class-name">export</span> <span class="token assign-left variable">TRV_OUT</span><span class="token operator">=</span><span class="token operator">&lt;</span>workspace-root<span class="token operator">></span>/.trv_output
<span class="token builtin class-name">export</span> <span class="token assign-left variable">ROOT</span><span class="token operator">=</span><span class="token operator">&lt;</span>workspace-root<span class="token operator">></span>/related/todo-app
<span class="token builtin class-name">export</span> <span class="token assign-left variable">MOD</span><span class="token operator">=</span>@travetto/todo-app

<span class="token comment"># Cleaning Output $DIST</span>

<span class="token builtin class-name">echo</span> <span class="token string">"Cleaning Output <span class="token variable">$DIST</span>
"</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> <span class="token variable">$DIST</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">$DIST</span>

<span class="token comment"># Writing .env.js</span>

<span class="token builtin class-name">echo</span> <span class="token string">"Writing .env.js
"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"process.env.TRV_MANIFEST = 'node_modules/<span class="token variable">$MOD</span>';"</span> <span class="token operator">></span> <span class="token variable">$DIST</span>/.env.js
<span class="token builtin class-name">echo</span> <span class="token string">"process.env.TRV_CLI_IPC = '';"</span> <span class="token operator">>></span> <span class="token variable">$DIST</span>/.env.js

<span class="token comment"># Writing package.json</span>

<span class="token builtin class-name">echo</span> <span class="token string">"Writing package.json
"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"{{'{'}}<span class="token entity" title="\&quot;">\"</span>type<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>commonjs<span class="token entity" title="\&quot;">\"</span>{{'}'}}"</span> <span class="token operator">></span> <span class="token variable">$DIST</span>/package.json

<span class="token comment"># Writing entry scripts cli.sh args=(run rest)</span>

<span class="token builtin class-name">echo</span> <span class="token string">"Writing entry scripts cli.sh args=(run rest)
"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"#!/bin/sh"</span> <span class="token operator">></span> <span class="token variable">$DIST</span>/cli.sh
<span class="token builtin class-name">echo</span> <span class="token string">"cd \<span class="token variable"><span class="token variable">$(</span><span class="token function">dirname</span> <span class="token punctuation">\</span>"<span class="token punctuation">\</span>$0<span class="token punctuation">\</span>"<span class="token variable">)</span></span>"</span> <span class="token operator">>></span> <span class="token variable">$DIST</span>/cli.sh
<span class="token builtin class-name">echo</span> <span class="token string">"node cli.js run rest \<span class="token variable">$@</span>"</span> <span class="token operator">>></span> <span class="token variable">$DIST</span>/cli.sh
<span class="token function">chmod</span> <span class="token number">755</span> <span class="token variable">$DIST</span>/cli.sh

<span class="token comment"># Writing entry scripts cli.cmd args=(run rest)</span>

<span class="token builtin class-name">echo</span> <span class="token string">"Writing entry scripts cli.cmd args=(run rest)
"</span>
<span class="token builtin class-name">echo</span> <span class="token string">""</span> <span class="token operator">></span> <span class="token variable">$DIST</span>/cli.cmd
<span class="token builtin class-name">echo</span> <span class="token string">"cd %~p0"</span> <span class="token operator">>></span> <span class="token variable">$DIST</span>/cli.cmd
<span class="token builtin class-name">echo</span> <span class="token string">"node cli.js run rest %*"</span> <span class="token operator">>></span> <span class="token variable">$DIST</span>/cli.cmd
<span class="token function">chmod</span> <span class="token number">755</span> <span class="token variable">$DIST</span>/cli.cmd

<span class="token comment"># Copying over resources</span>

<span class="token builtin class-name">echo</span> <span class="token string">"Copying over resources
"</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">$DIST</span>/node_modules/<span class="token variable">$MOD</span>
<span class="token function">cp</span> <span class="token variable">$TRV_OUT</span>/node_modules/<span class="token variable">$MOD</span>/package.json <span class="token variable">$DIST</span>/node_modules/<span class="token variable">$MOD</span>/package.json
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">$DIST</span>/node_modules/@travetto/manifest
<span class="token function">cp</span> <span class="token variable">$TRV_OUT</span>/node_modules/@travetto/manifest/package.json <span class="token variable">$DIST</span>/node_modules/@travetto/manifest/package.json
<span class="token function">cp</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-p</span> <span class="token variable">$ROOT</span>/resources <span class="token variable">$DIST</span>/resources

<span class="token comment"># Generating App Cache node_modules/$MOD/trv-app-cache.json</span>

<span class="token builtin class-name">echo</span> <span class="token string">"Generating App Cache node_modules/<span class="token variable">$MOD</span>/trv-app-cache.json
"</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">$DIST</span>/node_modules/<span class="token variable">$MOD</span>
<span class="token assign-left variable">DEBUG</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">TRV_MODULE</span><span class="token operator">=</span><span class="token variable">$MOD</span> npx trv main @travetto/app/support/bin/list <span class="token operator">></span> <span class="token variable">$DIST</span>/node_modules/<span class="token variable">$MOD</span>/trv-app-cache.json

<span class="token comment"># Writing Manifest node_modules/$MOD</span>

<span class="token builtin class-name">echo</span> <span class="token string">"Writing Manifest node_modules/<span class="token variable">$MOD</span>
"</span>
<span class="token assign-left variable">TRV_MODULE</span><span class="token operator">=</span><span class="token variable">$MOD</span> npx trv manifest <span class="token variable">$DIST</span>/node_modules/<span class="token variable">$MOD</span> prod

<span class="token comment"># Bundling Output minify=true sourcemap= entryPoint=@travetto/cli/support/entry.cli</span>

<span class="token builtin class-name">echo</span> <span class="token string">"Bundling Output minify=true sourcemap= entryPoint=@travetto/cli/support/entry.cli
"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">BUNDLE_ENTRY</span><span class="token operator">=</span>node_modules/@travetto/cli/support/entry.cli.js
<span class="token builtin class-name">export</span> <span class="token assign-left variable">BUNDLE_MAIN_FILE</span><span class="token operator">=</span>cli.js
<span class="token builtin class-name">export</span> <span class="token assign-left variable">BUNDLE_COMPRESS</span><span class="token operator">=</span>true
<span class="token builtin class-name">export</span> <span class="token assign-left variable">BUNDLE_OUTPUT</span><span class="token operator">=</span><span class="token variable">$DIST</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">BUNDLE_FORMAT</span><span class="token operator">=</span>commonjs
<span class="token builtin class-name">export</span> <span class="token assign-left variable">TRV_MANIFEST</span><span class="token operator">=</span><span class="token variable">$TRV_OUT</span>/node_modules/<span class="token variable">$MOD</span>
<span class="token builtin class-name">cd</span> <span class="token variable">$TRV_OUT</span>
npx rollup <span class="token parameter variable">-c</span> node_modules/@travetto/pack/support/bin/rollup.js
<span class="token builtin class-name">cd</span> <span class="token variable">$ROOT</span>

<span class="token comment"># Generating Docker File $DIST/Dockerfile @travetto/pack/support/pack.dockerfile</span>

<span class="token builtin class-name">echo</span> <span class="token string">"Generating Docker File <span class="token variable">$DIST</span>/Dockerfile @travetto/pack/support/pack.dockerfile
"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"FROM node:18-alpine3.16"</span> <span class="token operator">></span> <span class="token variable">$DIST</span>/Dockerfile
<span class="token builtin class-name">echo</span> <span class="token string">"WORKDIR /app"</span> <span class="token operator">>></span> <span class="token variable">$DIST</span>/Dockerfile
<span class="token builtin class-name">echo</span> <span class="token string">"COPY . ."</span> <span class="token operator">>></span> <span class="token variable">$DIST</span>/Dockerfile
<span class="token builtin class-name">echo</span> <span class="token string">""</span> <span class="token operator">>></span> <span class="token variable">$DIST</span>/Dockerfile
<span class="token builtin class-name">echo</span> <span class="token string">"ENTRYPOINT [<span class="token entity" title="\&quot;">\"</span>/app/cli.sh<span class="token entity" title="\&quot;">\"</span>]"</span> <span class="token operator">>></span> <span class="token variable">$DIST</span>/Dockerfile

<span class="token comment"># Pulling Docker Base Image node:18-alpine3.16</span>

<span class="token builtin class-name">echo</span> <span class="token string">"Pulling Docker Base Image node:18-alpine3.16
"</span>
<span class="token function">docker</span> pull node:18-alpine3.16

<span class="token comment"># Building Docker Container latest</span>

<span class="token builtin class-name">echo</span> <span class="token string">"Building Docker Container latest
"</span>
<span class="token builtin class-name">cd</span> <span class="token variable">$DIST</span>
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> travetto_todo-app:latest <span class="token builtin class-name">.</span>
<span class="token builtin class-name">cd</span> <span class="token variable">$ROOT</span></code></pre>     
      </figure>
