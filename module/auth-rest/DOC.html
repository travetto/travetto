<!-- This file was generated by @travetto/doc and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/main/module/auth-rest/DOC.tsx and execute "npx trv doc" to rebuild -->
<h1>Rest Auth
<small>Rest authentication integration support for the Travetto framework</small>
</h1>

  <figure class="install">
    <figcaption class="install">Install @travetto/auth-rest
    
    </figcaption>
    <pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> @travetto/auth-rest

<span class="token comment"># or</span>

<span class="token function">yarn</span> <span class="token function">add</span> @travetto/auth-rest</code></pre>
  </figure>

This is a primary integration for the <a class="module-link" href="https://github.com/travetto/travetto/tree/main/module/auth" title="Authentication scaffolding for the Travetto framework">Authentication</a> module.  This is another level of scaffolding allowing for compatible authentication frameworks to integrate. <br><br>
The integration with the <a class="module-link" href="https://github.com/travetto/travetto/tree/main/module/rest" title="Declarative api for RESTful APIs with support for the dependency injection module.">RESTful API</a> module touches multiple levels. Primarily:
<ul> <li>Security information management</li>
<li>Patterns for auth framework integrations</li>
<li>Route declaration</li>
</ul>

<h2 id="security-information-management">Security information management</h2>

When working with framework's authentication, the user information is exposed via the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/rest/src/typings.d.ts#L12">TravettoRequest</a> object.  The auth functionality is exposed on the request as the property <code class="item input">auth</code>.

  <figure class="code">
    <figcaption class="code">Structure of auth property on the request
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/auth-rest/src/typings.d.ts#L7">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">TravettoRequest</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * The authenticated principal
   */</span>
  auth<span class="token operator">?</span><span class="token operator">:</span> Principal<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Any additional context for login
   */</span>
  <span class="token punctuation">[</span>LoginContext‚≤ê<span class="token punctuation">]</span><span class="token operator">?</span><span class="token operator">:</span> LoginContext<span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

This allows for any filters/middleware to access this information without deeper knowledge of the framework itself.  Also, for performance benefits, the auth context can be stored in the user session as a means to minimize future lookups. If storing the entire principal in the session, it is best to keep the principal as small as possible. <br><br>
When authenticating, with a multi-step process, it is useful to share information between steps.  The <code class="item method">loginContext</code> property is intended to be a location in which that information is persisted. Currently only <a target="_blank" class="external-link" href="http://passportjs.org">passport</a> support is included, when dealing with multi-step logins.

<h2 id="patterns-for-integration">Patterns for Integration</h2>

Every external framework integration relies upon the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth/src/types/authenticator.ts#L8">Authenticator</a> contract.  This contract defines the boundaries between both frameworks and what is needed to pass between. As stated elsewhere, the goal is to be as flexible as possible, and so the contract is as minimal as possible:

  <figure class="code">
    <figcaption class="code">Structure for the Identity Source
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/auth/src/types/authenticator.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Principal <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'./principal'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Supports validation payload of type T into an authenticated principal
 *
 * @concrete ../internal/types:AuthenticatorTarget
 */</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Authenticator<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span> <span class="token constant">P</span> <span class="token keyword">extends</span> Principal <span class="token operator">=</span> Principal<span class="token punctuation">,</span> <span class="token constant">C</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token operator">></span></span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Allows for the authenticator to be initialized if needed
   * @param ctx
   */</span>
  initialize<span class="token operator">?</span><span class="token punctuation">(</span>ctx<span class="token operator">:</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Verify the payload, ensuring the payload is correctly identified.
   *
   * @returns Valid principal if authenticated
   * @returns undefined if authentication is valid, but incomplete (multi-step)
   * @throws AppError if authentication fails
   */</span>
  <span class="token function">authenticate</span><span class="token punctuation">(</span>payload<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> ctx<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">P</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token constant">P</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

The only required method to be defined is the <code class="item method">authenticate</code> method.  This takes in a pre-principal payload and a filter context with a <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/rest/src/typings.d.ts#L12">TravettoRequest</a> and <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/rest/src/typings.d.ts#L115">TravettoResponse</a>, and is responsible for:
<ul> <li>Returning an <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth/src/types/principal.ts#L8">Principal</a> if authentication was successful</li>
<li>Throwing an error if it failed</li>
<li>Returning undefined if the authentication is multi-staged and has not completed yet</li>
</ul>
A sample auth provider would look like:

  <figure class="code">
    <figcaption class="code">Sample Identity Source
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/auth-rest/doc/source.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> AppError <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/base'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Authenticator <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/auth'</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">User</span> <span class="token operator">=</span> <span class="token punctuation">{{'{'}}</span> username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> password<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SimpleAuthenticator</span> <span class="token keyword">implements</span> <span class="token class-name">Authenticator<span class="token operator">&lt;</span>User<span class="token operator">></span></span><span class="token punctuation">{{'{'}}</span>
  <span class="token keyword">async</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span> username<span class="token punctuation">,</span> password <span class="token punctuation">{{'}'}}</span><span class="token operator">:</span> User<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">===</span> <span class="token string">'test'</span> <span class="token operator">&amp;&amp;</span> password <span class="token operator">===</span> <span class="token string">'test'</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
      <span class="token keyword">return</span> <span class="token punctuation">{{'{'}}</span>
        id<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
        source<span class="token operator">:</span> <span class="token string">'simple'</span><span class="token punctuation">,</span>
        permissions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        details<span class="token operator">:</span> <span class="token punctuation">{{'{'}}</span>
          username<span class="token operator">:</span> <span class="token string">'test'</span>
        <span class="token punctuation">{{'}'}}</span>
      <span class="token punctuation">{{'}'}}</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{'}'}}</span> <span class="token keyword">else</span> <span class="token punctuation">{{'{'}}</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AppError</span><span class="token punctuation">(</span><span class="token string">'Invalid credentials'</span><span class="token punctuation">,</span> <span class="token string">'authentication'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{'}'}}</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

The provider must be registered with a custom symbol to be used within the framework.  At startup, all registered <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth/src/types/authenticator.ts#L8">Authenticator</a>'s are collected and stored for reference at runtime, via symbol. For example:

  <figure class="code">
    <figcaption class="code">Potential Facebook provider
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/auth-rest/doc/facebook.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> InjectableFactory <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/di'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> SimpleAuthenticator <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'./source'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">FB_AUTH</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">'auth-facebook'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppConfig</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">InjectableFactory</span></span><span class="token punctuation">(</span><span class="token constant">FB_AUTH</span><span class="token punctuation">)</span>
  <span class="token keyword">static</span> <span class="token function">facebookIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SimpleAuthenticator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

The symbol <code class="item input">FB_AUTH</code> is what will be used to reference providers at runtime.  This was chosen, over <code class="item input">class</code> references due to the fact that most providers will not be defined via a new class, but via an <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/di/src/decorator.ts#L74">@InjectableFactory</a> method.

<h2 id="route-declaration">Route Declaration</h2>

Like the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth-rest/src/service.ts#L14">AuthService</a>, there are common auth patterns that most users will implement. The framework has codified these into decorators that a developer can pick up and use. <br><br>
<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth-rest/src/decorator.ts#L12">@Authenticate</a> integrates with middleware that will authenticate the user as defined by the specified providers, or throw an error if authentication is unsuccessful.

  <figure class="code">
    <figcaption class="code">Using provider with routes
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/auth-rest/doc/route.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Controller<span class="token punctuation">,</span> Get<span class="token punctuation">,</span> Redirect<span class="token punctuation">,</span> Request <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/rest'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Authenticate<span class="token punctuation">,</span> Authenticated<span class="token punctuation">,</span> AuthService <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/auth-rest'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> <span class="token constant">FB_AUTH</span> <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'./facebook'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">'/auth'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SampleAuth</span> <span class="token punctuation">{{'{'}}</span>

  svc<span class="token operator">:</span> AuthService<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">'/simple'</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Authenticate</span></span><span class="token punctuation">(</span><span class="token constant">FB_AUTH</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">simpleLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/self'</span><span class="token punctuation">,</span> <span class="token number">301</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">'/self'</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Authenticated</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">getSelf</span><span class="token punctuation">(</span>req<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">return</span> req<span class="token punctuation">.</span>auth<span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Authenticated</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">logout</span><span class="token punctuation">(</span>req<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>svc<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/self'</span><span class="token punctuation">,</span> <span class="token number">301</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth-rest/src/decorator.ts#L23">@Authenticated</a> and <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth-rest/src/decorator.ts#L34">@Unauthenticated</a> will simply enforce whether or not a user is logged in and throw the appropriate error messages as needed. Additionally, the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/auth/src/types/principal.ts#L8">Principal</a> is accessible via <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/rest/src/decorator/param.ts#L39">@Context</a> directly, without wiring in a request object, but is also accessible on the request object as <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/rest/src/typings.d.ts#L12">TravettoRequest</a>.auth.
