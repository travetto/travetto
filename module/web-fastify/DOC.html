<!-- This file was generated by @travetto/doc and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/main/module/web-fastify/DOC.tsx and execute "npx trv doc" to rebuild -->
<h1>Fastify Web Server
<small>Fastify provider for the travetto web module.</small>
</h1>

  <figure class="install">
    <figcaption class="install">Install @travetto/web-fastify
    
    </figcaption>
    <pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> @travetto/web-fastify

<span class="token comment"># or</span>

<span class="token function">yarn</span> <span class="token function">add</span> @travetto/web-fastify</code></pre>
  </figure>

The module is an <a target="_blank" class="external-link" href="https://www.fastify.io/">fastify</a> provider for the <a class="module-link" href="https://github.com/travetto/travetto/tree/main/module/web" title="Declarative api for Web Applications with support for the dependency injection.">Web API</a> module.  This module provides an implementation of <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/application/app.ts#L18">WebApplication</a> for automatic injection in the default Web server.
<h2 id="customizing-web-app">Customizing Web App</h2>

  <figure class="code">
    <figcaption class="code">Customizing the Fastify App
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web-fastify/doc/customize.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> FastifyPluginAsync <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'fastify'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Injectable <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/di'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> FastifyWebServer <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/web-fastify'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> TimeUtil <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/runtime'</span><span class="token punctuation">;</span>

<span class="token keyword">declare</span> <span class="token keyword">let</span> <span class="token function-variable function">rateLimit</span><span class="token operator">:</span> <span class="token punctuation">(</span>config<span class="token operator">:</span> <span class="token punctuation">{{'{'}}</span> windowMs<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> max<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span> <span class="token operator">=></span> FastifyPluginAsync<span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span> primary<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">CustomWebServer</span> <span class="token keyword">extends</span> <span class="token class-name">FastifyWebServer</span> <span class="token punctuation">{{'{'}}</span>
  override <span class="token keyword">async</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> limiter <span class="token operator">=</span> <span class="token function">rateLimit</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span>
      windowMs<span class="token operator">:</span> TimeUtil<span class="token punctuation">.</span><span class="token function">asMillis</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'m'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 15 minutes</span>
      max<span class="token operator">:</span> <span class="token number">100</span> <span class="token comment">// limit each IP to 100 requests per windowMs</span>
    <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//  apply to all requests</span>
    app<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>limiter<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> app<span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h2 id="default-middleware">Default Middleware</h2>

When working with an <a target="_blank" class="external-link" href="https://www.fastify.io/">fastify</a> applications, the module provides what is assumed to be a sufficient set of basic filters. Specifically:

  <figure class="code">
    <figcaption class="code">Configured Middleware
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web-fastify/src/server.ts#L33">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">fastify</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span>
  trustProxy<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>trustProxy<span class="token punctuation">,</span>
  <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>ssl<span class="token operator">?.</span>active <span class="token operator">?</span> <span class="token punctuation">{{'{'}}</span>
    https<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>ssl<span class="token operator">?.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">{{'}'}}</span> <span class="token operator">:</span> <span class="token punctuation">{{'{'}}</span><span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Defer to fastify if disabled</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>compress<span class="token punctuation">.</span>disabled<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token keyword">const</span> preferred <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>compress<span class="token punctuation">.</span>preferredEncodings <span class="token operator">??</span> <span class="token keyword">this</span><span class="token punctuation">.</span>compress<span class="token punctuation">.</span>supportedEncodings<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x <span class="token operator">!==</span> <span class="token string">'deflate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>fastifyCompress<span class="token punctuation">,</span> <span class="token punctuation">{{'{'}}</span> encodings<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>compress<span class="token punctuation">.</span>supportedEncodings<span class="token punctuation">,</span> requestEncodings<span class="token operator">:</span> preferred <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span>

<span class="token comment">// Defer to fastify if disabled</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>etag<span class="token punctuation">.</span>disabled<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
  app<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>fastifyEtag<span class="token punctuation">,</span> <span class="token punctuation">{{'{'}}</span> weak<span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>etag<span class="token punctuation">.</span>weak<span class="token punctuation">,</span> replyWith304<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span>

app<span class="token punctuation">.</span><span class="token function">removeAllContentTypeParsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">addContentTypeParser</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> body<span class="token punctuation">,</span> done<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
  </figure>
