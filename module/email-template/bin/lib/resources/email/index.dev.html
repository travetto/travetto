<html>

  <head>
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

    <!-- Compiled and minified JavaScript -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.15.6/min/vs/loader.js"></script>


    <style>
      html,
      body {
        height: 100%;
        width: 100%;
        padding: 0;
        margin: 0;
        overflow: hidden;
      }

      .container {
        width: 100%;
        max-width: 100%;
      }


      iframe {
        width: 100%;
        height: 100%;
        border: 0;
      }

      #context {
        width: 100%;
        height: 20em;
      }

      ul {
        cursor: pointer;
      }

    </style>
  </head>

  <body class="container">
    <nav class="row">
      <div class="nav-wrapper">
        <a href="#" class="brand-logo">Email Builder</a>
      </div>
    </nav>

    <div class="row">
      <div class="col s3">
        <h4>Templates</h4>
        <div class="collection" id="template">
          {{#templates}}
          <a href="{{path}}" class="collection-item" onclick="selectTemplate(this); return false">
            {{key}}
          </a>
          {{/templates}}
        </div>
        <h4>Context</h4>
        <div id="context"></div>
      </div>
      <div class="col s9">
        <h4>Preview
          <!-- Switch -->
          <div class="switch" style="display:inline-block;">
            <label>
              Text
              <input id="format" type="checkbox" onchange="setFormat(this)">
              <span class="lever"></span>
              Html
            </label>
          </div>
        </h4>
        <iframe src="">
        </iframe>
      </div>
    </div>
  </body>

  <script defer="true">
    // @ts-check
    const iframe = document.getElementsByTagName('iframe')[0];
    const templates = document.getElementById('template');
    const context = document.getElementById('context');

    /** 
     * @param {HTMLInputElement} checkbox
     */
    function setFormat(checkbox) {
      sessionStorage.setItem('format', checkbox.checked ? 'html' : 'txt');
      updateIframe();
    }

    /**
     * @param {HTMLAnchorElement} node
     */
    function selectTemplate(node) {
      const active = templates.querySelector('.active');
      if (active) {
        active.classList.remove('active');
      }
      node.classList.add('active');
      sessionStorage.setItem('template', node.href);
      updateIframe();
    }

    /**
     * Render iframe
     */
    function updateIframe() {
      const values = {
        template: sessionStorage.getItem('template'),
        format: sessionStorage.getItem('format'),
        context: sessionStorage.getItem('context')
      };
      if (values.template) {
        const url = `${values.template}?format=${values.format}&jsonContext=${encodeURIComponent(values.context || '{}')}`;
        iframe.src = url;
      }
    }

    // Set template
    const activeNode = templates.querySelector(`a[path="${sessionStorage.getItem('template')}"]`);
    selectTemplate(activeNode || templates.querySelector('a'));

    // Set format
    document.querySelector('#format').checked = (sessionStorage.getItem('format') || 'html') === 'html';

    // @ts-ignore
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.15.6/min/vs' } });

    // Before loading vs/editor/editor.main, define a global MonacoEnvironment that overwrites
    // the default worker url location (used when creating WebWorkers). The problem here is that
    // HTML5 does not allow cross-domain web workers, so we need to proxy the instantion of
    // a web worker through a same-domain script
    // @ts-ignore
    window.MonacoEnvironment = {
      getWorkerUrl: function (workerId, label) {
        return 'monaco-editor-worker-loader-proxy.js';
      }
    };

    // @ts-ignore
    require(['vs/editor/editor.main'], function () {
      // @ts-ignore
      const editor = monaco.editor.create(context, {
        value: sessionStorage.getItem('context') || '{\n}',
        language: 'json'
      });
      editor.onDidChangeModelContent((event) => {
        try {
          sessionStorage.setItem('context', JSON.stringify(JSON.parse(editor.getValue()), null, 2));
          updateIframe();
        } catch (e) { }
      });
    });

    updateIframe();
  </script>

</html>
