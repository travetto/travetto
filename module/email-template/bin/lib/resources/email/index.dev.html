<html>

  <head>
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Compiled and minified JavaScript -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.15.6/min/vs/loader.js"></script>


    <style>
      html,
      body,
      .container {
        height: 100%;
        width: 100%;
        max-width: 100%;
        padding: 0;
        margin: 0;
      }

      .nav-wrapper {
        padding: 0 1em;
      }

      .layout {
        display: grid;
        width: 100%;
        height: 100%;
        grid-template-columns: 350px 1fr;
        grid-gap: 1em;
        grid-template-rows: 80px 1fr;
      }

      nav {
        grid-row: 1;
        grid-column: 1/3;
      }

      .templates {
        margin-top: 0;
        grid-row: 2;
        grid-column: 1;
      }

      .preview {
        border: 0;
        width: 100%;
        height: 100%;
        grid-row: 2;
        grid-column: 2;
      }

      .sidenav {
        margin-top: calc(80px + 1em);
        height: calc(100vh - 80px - 2em);
        width: 350px;
        overflow-y: hidden;
      }

      #context {
        height: calc(100vh - 80px - 8em);
      }

      .sidenav-overlay {
        display: none !important;
      }

      .sidenav .sidenav-close {
        position: absolute;
        top: .5em;
        right: .5em;
        line-height: 1em;
        font-size: 30px;
        color: black;
      }

      .sidenav h4 {
        padding-left: 1em;
      }

      .templates .sidenav-trigger {
        font-size: 1rem;
        display: inline-block !important;
      }

      .sidenav .templates .card-content {
        padding-left: 0;
        padding-right: 0;
      }

      .sidenav .templates .card-title {
        padding-left: 1em;
      }

    </style>
  </head>

  <body>

    <div id="slide-out" class="sidenav">
      <div class="templates card z-depth-3  grey lighten-2">
        <div class="card-content">
          <span class="card-title">Context</span>
          <div id="context"></div>
          <a class="sidenav-close" href="#!">&times;</a>
        </div>
      </div>
    </div>

    <div class="layout">
      <nav>
        <div class="nav-wrapper green darken-3">
          <span class="brand-logo">@travetto: Email Builder</span>
          <div class="right">
            <div class="switch" style="display:inline-block;">
              <label class="white-text">
                Text
                <input id="format" type="checkbox" onchange="setFormat(this)">
                <span class="lever"></span>
                Html
              </label>
            </div>
          </div>
        </div>
      </nav>

      <div class="templates card z-depth-3">
        <div class="card-content">
          <span class="card-title">Templates
            <a href="#" data-target="slide-out" class="sidenav-trigger show-on-large">
              Edit Context
            </a>
          </span>
          <div class="collection" id="template">
            {{#templates}}
            <a href="{{path}}" class="collection-item" onclick="selectTemplate(this); return false">
              {{key}}
            </a>
            {{/templates}}
          </div>
        </div>
      </div>
      <iframe class="preview" src="">
      </iframe>
    </div>
  </body>

  <script defer="true">
    document.addEventListener('DOMContentLoaded', function () {
      var elems = document.querySelectorAll('.sidenav');
      var instances = M.Sidenav.init(elems, {
        edge: 'left'
      });
    });

    // @ts-check
    const iframe = document.getElementsByTagName('iframe')[0];
    const templates = document.getElementById('template');
    const context = document.getElementById('context');

    /** 
     * @param {HTMLInputElement} checkbox
     */
    function setFormat(checkbox) {
      sessionStorage.setItem('format', checkbox.checked ? 'html' : 'txt');
      updateIframe();
    }

    /**
     * @param {HTMLAnchorElement} node
     */
    function selectTemplate(node) {
      const active = templates.querySelector('.active');
      if (active) {
        active.classList.remove('active');
      }
      node.classList.add('active');
      sessionStorage.setItem('template', node.href);
      updateIframe();
    }

    /**
     * Render iframe
     */
    function updateIframe() {
      const values = {
        template: sessionStorage.getItem('template'),
        format: sessionStorage.getItem('format'),
        context: sessionStorage.getItem('context')
      };
      if (values.template) {
        const url = `${values.template}?format=${values.format}&jsonContext=${encodeURIComponent(values.context || '{}')}`;
        iframe.src = url;
      }
    }

    // Set template
    const activeNode = templates.querySelector(`a[path="${sessionStorage.getItem('template')}"]`);
    selectTemplate(activeNode || templates.querySelector('a'));

    // Set format
    document.querySelector('#format').checked = (sessionStorage.getItem('format') || 'html') === 'html';

    // @ts-ignore
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.15.6/min/vs' } });

    // Before loading vs/editor/editor.main, define a global MonacoEnvironment that overwrites
    // the default worker url location (used when creating WebWorkers). The problem here is that
    // HTML5 does not allow cross-domain web workers, so we need to proxy the instantion of
    // a web worker through a same-domain script
    // @ts-ignore
    window.MonacoEnvironment = {
      getWorkerUrl: function (workerId, label) {
        return 'monaco-editor-worker-loader-proxy.js';
      }
    };

    // @ts-ignore
    require(['vs/editor/editor.main'], function () {
      // @ts-ignore
      const editor = monaco.editor.create(context, {
        value: sessionStorage.getItem('context') || '{\n}',
        language: 'json'
      });
      editor.onDidChangeModelContent((event) => {
        try {
          sessionStorage.setItem('context', JSON.stringify(JSON.parse(editor.getValue()), null, 2));
          updateIframe();
        } catch (e) { }
      });
    });

    updateIframe();
  </script>

</html>
