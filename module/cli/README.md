<!-- This file was generated by @travetto/doc and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/main/module/cli/DOC.tsx and execute "npx trv doc" to rebuild -->
# Command Line Interface

## CLI infrastructure for Travetto framework

**Install: @travetto/cli**
```bash
npm install @travetto/cli

# or

yarn add @travetto/cli
```

The cli module represents the primary entry point for execution within the framework. One of the main goals for this module is extensibility, as adding new entry points is meant to be trivial. The framework leverages this module for exposing all executable tools and entry points.  To see a high level listing of all supported commands, invoke `trv --help`

**Terminal: General Usage**
```bash
$ trv --help

Usage:  [options] [command]

Commands:
  doc               Command line support for generating module docs.
  doc:angular       Generate documentation into the angular webapp under related/travetto.github.io
  doc:mapping       Generate module mapping for
  email:compile     CLI Entry point for running the email server
  email:editor      The email editor compilation service and output serving
  email:test        CLI Entry point for running the email server
  eslint            Command line support for eslint
  eslint:register   Writes the eslint configuration file
  model:export      Exports model schemas
  model:install     Installing models
  openapi:client    CLI for generating the cli client
  openapi:spec      CLI for outputting the open api spec to a local file
  pack              Standard pack support
  pack:docker       Standard docker support for pack
  pack:lambda       Standard lambda support for pack
  pack:zip          Standard zip support for pack
  repo:exec         Repo execution
  repo:list         Allows for listing of modules
  repo:publish      Publish all pending modules
  repo:version      Version all changed dependencies
  repo:version-sync Enforces all packages to write out their versions and dependencies
  run:double        Doubles a number
  scaffold          Command to run scaffolding
  service           Allows for running services
  test              Launch test framework and execute tests
  test:watch        Invoke the test watcher
  web:http          Run a web server
  web:rpc-client    Generate the web-rpc client
```

This listing is from the [Travetto](https://travetto.dev) monorepo, and represents the majority of tools that can be invoked from the command line. 

This module also has a tight integration with the [VSCode plugin](https://marketplace.visualstudio.com/items?itemName=arcsine.travetto-plugin), allowing the editing experience to benefit from the commands defined. The most commonly used commands will be the ones packaged with the framework, but its also very easy to create new commands.  With the correct configuration, these commands will also be exposed within VSCode.

At it's heart, a cli command is the contract defined by what flags, and what arguments the command supports. Within the framework this requires three criteria to be met:
   *  The file must be located in the `support/` folder, and have a name that matches `cli.*.ts`
   *  The file must be a class that has a main method
   *  The class must use the [@CliCommand](https://github.com/travetto/travetto/tree/main/module/cli/src/registry/decorator.ts#L98) decorator

**Code: Basic Command**
```typescript
import { CliCommand } from '@travetto/cli';

@CliCommand()
export class BasicCommand {
  main() {
    console.log('Hello');
  }
}
```

**Terminal: Basic Command Help**
```bash
$ trv basic -h

Usage: basic [options]

Options:
  -h, --help  display help for command
```

## Command Naming
The file name `support/cli.<name>.ts` has a direct mapping to the cli command name.   This hard mapping allows for the framework to be able to know which file to invoke without needing to load all command-related files. 

Examples of mappings:
   *  `cli.test.ts` maps to `test`
   *  `cli.pack_docker.ts` maps to `pack:docker`
   *  `cli.email_template.ts` maps to `email:template`

The pattern is that underscores(_) translate to colons (:), and the `cli.` prefix, and `.ts` suffix are dropped.

## Binding Flags
[@CliCommand](https://github.com/travetto/travetto/tree/main/module/cli/src/registry/decorator.ts#L98) is a wrapper for [@Schema](https://github.com/travetto/travetto/tree/main/module/schema/src/decorator/schema.ts#L19), and so every class that uses the [@CliCommand](https://github.com/travetto/travetto/tree/main/module/cli/src/registry/decorator.ts#L98) decorator is now a full [@Schema](https://github.com/travetto/travetto/tree/main/module/schema/src/decorator/schema.ts#L19) class. The fields of the class represent the flags that are available to the command.

**Code: Basic Command with Flag**
```typescript
import { CliCommand } from '@travetto/cli';

@CliCommand()
export class BasicCommand {

  loud?: boolean;

  main() {
    console.log(this.loud ? 'HELLO' : 'Hello');
  }
}
```

**Terminal: Basic Command with Flag Help**
```bash
$ trv basic:flag -h

Usage: basic:flag [options]

Options:
  -l, --loud
  -h, --help  display help for command
```

As you can see the command now has the support of a basic boolean flag to determine if the response should be loud or not.  The default value here is undefined/false, and so is an opt-in experience.

**Terminal: Basic Command with Loud Flag**
```bash
$ trv basic:flag --loud

HELLO
```

The [@CliCommand](https://github.com/travetto/travetto/tree/main/module/cli/src/registry/decorator.ts#L98) supports the following data types for flags:
   *  Boolean values
   *  Number values. The [@Integer](https://github.com/travetto/travetto/tree/main/module/schema/src/decorator/input.ts#L172), [@Float](https://github.com/travetto/travetto/tree/main/module/schema/src/decorator/input.ts#L179), [@Precision](https://github.com/travetto/travetto/tree/main/module/schema/src/decorator/input.ts#L165), [@Min](https://github.com/travetto/travetto/tree/main/module/schema/src/decorator/input.ts#L99) and [@Max](https://github.com/travetto/travetto/tree/main/module/schema/src/decorator/input.ts#L110) decorators help provide additional validation.
   *  String values. [@MinLength](https://github.com/travetto/travetto/tree/main/module/schema/src/decorator/input.ts#L99), [@MaxLength](https://github.com/travetto/travetto/tree/main/module/schema/src/decorator/input.ts#L110), [@Match](https://github.com/travetto/travetto/tree/main/module/schema/src/decorator/input.ts#L90) and [@Enum](https://github.com/travetto/travetto/tree/main/module/schema/src/decorator/input.ts#L64) provide additional constraints
   *  Date values. The [@Min](https://github.com/travetto/travetto/tree/main/module/schema/src/decorator/input.ts#L99) and [@Max](https://github.com/travetto/travetto/tree/main/module/schema/src/decorator/input.ts#L110) decorators help provide additional validation.
   *  String lists. Same as String, but allowing multiple values.
   *  Numeric lists. Same as Number, but allowing multiple values.

## Binding Arguments
The `main()` method is the entrypoint for the command, represents a series of parameters. Some will be required, some may be optional.  The arguments support all types supported by the flags, and decorators can be provided using the decorators inline on parameters.     Optional arguments in the method, will be optional at run time, and filled with the provided default values.

**Code: Basic Command with Arg**
```typescript
import { CliCommand } from '@travetto/cli';
import { Max, Min } from '@travetto/schema';

@CliCommand()
export class BasicCommand {

  main(@Min(1) @Max(10) volume: number = 1) {
    console.log(volume > 7 ? 'HELLO' : 'Hello');
  }
}
```

**Terminal: Basic Command**
```bash
$ trv basic:arg -h

Usage: basic:arg [options] [volume:number]

Options:
  -h, --help  display help for command
```

**Terminal: Basic Command with Invalid Loud Arg**
```bash
$ trv basic:arg 20

Execution failed:
 * Argument volume is greater than (10)

Usage: basic:arg [options] [volume:number]

Options:
  -h, --help  display help for command
```

**Terminal: Basic Command with Loud Arg > 7**
```bash
$ trv basic:arg 8

HELLO
```

**Terminal: Basic Command without Arg**
```bash
$ trv basic:arg

Hello
```

Additionally, if you provide a field as an array, it will collect all valid values (excludes flags, and any arguments past a `--`).

**Code: Basic Command with Arg List**
```typescript
import { CliCommand } from '@travetto/cli';
import { Max, Min } from '@travetto/schema';

@CliCommand()
export class BasicCommand {

  reverse?: boolean;

  main(@Min(1) @Max(10) volumes: number[]) {
    console.log(volumes.toSorted((a, b) => (a - b) * (this.reverse ? -1 : 1)).join(' '));
  }
}
```

**Terminal: Basic Command**
```bash
$ trv basic:arg-list -h

Usage: basic:arg-list [options] <volumes...:number>

Options:
  -r, --reverse
  -h, --help     display help for command
```

**Terminal: Basic Arg List**
```bash
$ trv basic:arg-list 10 5 3 9 8 1

1 3 5 8 9 10
```

**Terminal: Basic Arg List with Invalid Number**
```bash
$ trv basic:arg-list 10 5 3 9 20 1

Execution failed:
 * Argument volumes[4] is greater than (10)

Usage: basic:arg-list [options] <volumes...:number>

Options:
  -r, --reverse
  -h, --help     display help for command
```

**Terminal: Basic Arg List with Reverse**
```bash
$ trv basic:arg-list -r 10 5 3 9 8 1

10 9 8 5 3 1
```

## Customization
By default, all fields are treated as flags and all parameters of `main()` are treated as arguments within the validation process.  Like the standard [@Schema](https://github.com/travetto/travetto/tree/main/module/schema/src/decorator/schema.ts#L19) behavior, we can leverage the metadata of the fields/parameters to help provide additional customization/context for the users of the commands.

**Code: Custom Command with Metadata**
```typescript
import { CliCommand } from '@travetto/cli';
import { Max, Min } from '@travetto/schema';

/**
 * Custom Argument Command
 */
@CliCommand()
export class CustomCommand {

  /**
   * The message to send back to the user
   * @alias -m
   * @alias --message
   */
  text: string = 'hello';

  main(@Min(1) @Max(10) volume: number = 1) {
    console.log(volume > 7 ? this.text.toUpperCase() : this.text);
  }
}
```

**Terminal: Custom Command Help**
```bash
$ trv custom:arg -h

Usage: custom:arg [options] [volume:number]

Options:
  -m, --message <string>  The message to send back to the user (default: "hello")
  -h, --help              display help for command
```

**Terminal: Custom Command Help with overridden Text**
```bash
$ trv custom:arg 10 -m cUsToM

CUSTOM
```

**Terminal: Custom Command Help with default Text**
```bash
$ trv custom:arg 6

hello
```

## Environment Variable Support
In addition to standard flag overriding (e.g. `/** @alias -m */`), the command execution also supports allowing environment variables to provide values (secondary to whatever is passed in on the command line).

**Code: Custom Command with Env Var**
```typescript
import { CliCommand } from '@travetto/cli';
import { Max, Min } from '@travetto/schema';

/**
 * Custom Argument Command
 */
@CliCommand()
export class CustomCommand {

  /**
   * The message to send back to the user
   * @alias env.MESSAGE
   */
  text: string = 'hello';

  main(@Min(1) @Max(10) volume: number = 1) {
    console.log(volume > 7 ? this.text.toUpperCase() : this.text);
  }
}
```

**Terminal: Custom Command Help**
```bash
$ trv custom:env-arg -h

Usage: custom:env-arg [options] [volume:number]

Options:
  -t, --text <string>  The message to send back to the user (default: "hello")
  -h, --help           display help for command
```

**Terminal: Custom Command Help with default Text**
```bash
$ trv custom:env-arg 6

hello
```

**Terminal: Custom Command Help with overridden Text**
```bash
$ MESSAGE=CuStOm trv custom:env-arg 10

CUSTOM
```

**Terminal: Custom Command Help with overridden Text**
```bash
$ MESSAGE=CuStOm trv custom:env-arg 7

CuStOm
```

## Flag File Support
Sometimes its also convenient, especially with commands that support a variety of flags, to provide easy access to pre-defined sets of flags.  Flag files represent a snapshot of command line arguments and flags, as defined in a file.  When referenced, these inputs are essentially injected into the command line as if the user had typed them manually.

**Code: Example Flag File**
```bash
--host localhost
--port 3306
--username app
```

As you can see in this file, it provides easy access to predefine the host, port, and user flags.

**Code: Using a Flag File**
```bash
npx trv call:db +=base --password <custom>
```

The flag files can be included in one of a few ways:
   *  `+=<name>` - This translates into `<module>/support/<name>.flags`, which is a convenient shorthand.
   *  `+=<module>/path/file.flags` - This is a path-related file that will be resolved from the module's location.
   *  `+=/path/file.flags` - This is an absolute path that will be read from the root of the file system.

Ultimately, after resolution, the content of these files will be injected inline within the location.

**Code: Final arguments after Flag File resolution**
```bash
npx trv call:db --host localhost --port 3306 --username app --password <custom>
```

## VSCode Integration
By default, cli commands do not expose themselves to the VSCode extension, as the majority of them are not intended for that sort of operation.  [Web API](https://github.com/travetto/travetto/tree/main/module/web#readme "Declarative support for creating Web Applications") does expose a cli target `web:http` that will show up, to help run/debug a web application.  Any command can mark itself as being a run target, and will be eligible for running from within the [VSCode plugin](https://marketplace.visualstudio.com/items?itemName=arcsine.travetto-plugin). This is achieved by setting the `runTarget` field on the [@CliCommand](https://github.com/travetto/travetto/tree/main/module/cli/src/registry/decorator.ts#L98) decorator.  This means the target will be visible within the editor tooling.

**Code: Simple Run Target**
```typescript
import { CliCommand } from '@travetto/cli';

/**
 * Simple Run Target
 */
@CliCommand({ runTarget: true })
export class RunCommand {

  main(name: string) {
    console.log(name);
  }
}
```

## Advanced Usage

**Code: Anatomy of a Command**
```typescript
export interface CliCommandShape<T extends unknown[] = unknown[]> {
  /**
   * Parsed state
   */
  _parsed?: ParsedState;
  /**
   * Config
   */
  _cfg?: CliCommandConfig;
  /**
   * Action target of the command
   */
  main(...args: T): OrProm<undefined | void>;
  /**
   * Run before main runs
   */
  preMain?(): OrProm<void>;
  /**
   * Extra help
   */
  help?(): OrProm<string[]>;
  /**
   * Run before help is displayed
   */
  preHelp?(): OrProm<void>;
  /**
   * Is the command active/eligible for usage
   */
  isActive?(): boolean;
  /**
   * Run before binding occurs
   */
  preBind?(): OrProm<void>;
  /**
   * Run before validation occurs
   */
  preValidate?(): OrProm<void>;
  /**
   * Validation method
   */
  validate?(...args: T): OrProm<CliValidationError | CliValidationError[] | undefined>;
}
```

### Dependency Injection
If the goal is to run a more complex application, which may include depending on [Dependency Injection](https://github.com/travetto/travetto/tree/main/module/di#readme "Dependency registration/management and injection support."), we can take a look at [Web API](https://github.com/travetto/travetto/tree/main/module/web#readme "Declarative support for creating Web Applications")'s target:

**Code: Simple Run Target**
```typescript
import { Runtime, toConcrete } from '@travetto/runtime';
import { DependencyRegistryIndex } from '@travetto/di';
import { CliCommand, type CliCommandShape } from '@travetto/cli';
import { NetUtil } from '@travetto/web';
import { Registry } from '@travetto/registry';

import type { WebHttpServer } from '../src/types.ts';

/**
 * Run a web server
 */
@CliCommand({ runTarget: true, with: { debugIpc: 'optional', restartOnChange: true, module: true, profiles: true } })
export class WebHttpCommand implements CliCommandShape {

  /** Port to run on */
  port?: number;

  /** Kill conflicting port owner */
  killConflict?: boolean = Runtime.localDevelopment;

  preMain(): void {
    if (this.port) {
      process.env.WEB_HTTP_PORT = `${this.port}`;
    }
  }

  async main(): Promise<void> {
    await Registry.init();
    const instance = await DependencyRegistryIndex.getInstance(toConcrete<WebHttpServer>());

    try {
      const handle = await instance.serve();
      return handle.complete;
    } catch (err) {
      const result = this.killConflict ? await NetUtil.freePortOnConflict(err) : undefined;
      if (result?.processId) {
        console.warn('Killed process owning port', result);
        process.exitCode = 1; // Indicate error, restart will use if in that mode
        return;
      }
      throw err;
    }
  }
}
```

As noted in the example above, `fields` is specified in this execution, with support for `module`, and `env`. These env flag is directly tied to the [Runtime](https://github.com/travetto/travetto/tree/main/module/runtime/src/context.ts#L13) `name` defined in the [Runtime](https://github.com/travetto/travetto/tree/main/module/runtime#readme "Runtime for travetto applications.") module. 

The `module` field is slightly more complex, but is geared towards supporting commands within a monorepo context.  This flag ensures that a module is specified if running from the root of the monorepo, and that the module provided is real, and can run the desired command.  When running from an explicit module folder in the monorepo, the module flag is ignored.

### Custom Validation
In addition to dependency injection, the command contract also allows for a custom validation function, which will have access to bound command (flags, and args) as well as the unknown arguments. When a command implements this method, any [CliValidationError](https://github.com/travetto/travetto/tree/main/module/cli/src/types.ts#L20) errors that are returned will be shared with the user, and fail to invoke the `main` method.

**Code: CliValidationError**
```typescript
export interface CliValidationError {
  /**
   * The error message
   */
  message: string;
  /**
   * Source of validation
   */
  source?: 'flag' | 'arg' | 'custom';
};
```

A simple example of the validation can be found in the `doc` command:

**Code: Simple Validation Example**
```typescript
async validate(): Promise<CliValidationError | undefined> {
    const docFile = path.resolve(this.input);
    if (!(await fs.stat(docFile).catch(() => false))) {
      return { message: `input: ${this.input} does not exist`, source: 'flag' };
    }
  }
```

## CLI - service
The module provides the ability to start/stop/restart services as [docker](https://www.docker.com/community-edition) containers.  This is meant to be used for development purposes, to minimize the effort of getting an application up and running.  Services can be targeted individually or handled as a group.

**Terminal: Command Service**
```bash
$ trv service --help

Usage: service [options] <action:restart|start|status|stop> [services...:string]

Options:
  -h, --help  display help for command

Available Services
--------------------
 * dynamodb@3.3.0
 * elasticsearch@9.2.4
 * firestore@latest
 * mongodb@8.2
 * mysql@9.6
 * postgresql@18.1
 * redis@8.4
 * s3@4.11.0
```

A sample of all services available to the entire framework:

**Terminal: All Services**
```bash
$ trv service status

Service          Version    Status
-------------------------------------------------
dynamodb           3.3.0    Running 93af422e793a
elasticsearch      9.2.4    Running ed76ee063d13
firestore         latest    Running feec2e5e95b4
mongodb              8.2    Running 5513eba6734e
mysql                9.6    Running 307bc66d442a
postgresql          18.1    Running e78291e71040
redis                8.4    Running 77ba279b4e30
s3                4.11.0    Running fdacfc55b9e3
```

### Defining new Services
The services are defined as plain typescript files within the framework and can easily be extended:

**Code: Sample Service Definition**
```typescript
import type { ServiceDescriptor } from '@travetto/cli';

const version = process.env.MONGO_VERSION || '8.2';

export const service: ServiceDescriptor = {
  name: 'mongodb',
  version,
  port: 27017,
  image: `mongo:${version}`
};
```
