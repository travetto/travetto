<!-- This file was generated by @travetto/doc and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/main/module/web/DOC.tsx and execute "npx trv doc" to rebuild -->
<h1>Web API
<small>Declarative api for Web Applications with support for the dependency injection.</small>
</h1>

  <figure class="install">
    <figcaption class="install">Install @travetto/web
    
    </figcaption>
    <pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> @travetto/web

<span class="token comment"># or</span>

<span class="token function">yarn</span> <span class="token function">add</span> @travetto/web</code></pre>
  </figure>

The module provides a declarative API for creating and describing a Web application.  Since the framework is declarative, decorators are used to configure almost everything. The general layout of an application is a collection of <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/controller.ts#L9">@Controller</a> s that employ some combination of <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/types/interceptor.ts#L15">WebInterceptor</a> s to help manage which functionality is executed before the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/endpoint.ts#L14">Endpoint</a> code, within the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/controller.ts#L9">@Controller</a>. This module will look at:
<ul> <li>Running a <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/types/application.ts#L8">WebApplication</a></li>
<li>Request/Response Pattern</li>
<li>Defining a <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/controller.ts#L9">@Controller</a></li>
<li>Defining an <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/endpoint.ts#L14">Endpoint</a> s</li>
<li>Using <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/types/interceptor.ts#L15">WebInterceptor</a> s</li>
<li>Creating a Custom <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/types/interceptor.ts#L15">WebInterceptor</a></li>
<li>Cookies</li>
<li>SSL Support</li>
<li>Error Handling</li>
</ul>

<h2 id="running-an-app">Running an App</h2>

By default, the framework provides a default <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/cli/src/decorators.ts#L84">@CliCommand</a> for <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/types/application.ts#L8">WebApplication</a> that will follow default behaviors, and spin up the server. Currently, <a class="module-link" href="https://github.com/travetto/travetto/tree/main/module/web-node" title="Node provider for the travetto web module.">Node Web Server</a> is the only module that provides a compatible <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/types/application.ts#L8">WebApplication</a>.

  <figure class="terminal">
    <figcaption class="terminal">Standard application

</figcaption>
    <pre><code class="language-bash">$ trv run:web

Initialized <span class="token punctuation">{{'{'}}</span>
  manifest: <span class="token punctuation">{{'{'}}</span>
    main: <span class="token punctuation">{{'{'}}</span>
      name: <span class="token string">'@travetto-doc/web'</span>,
      folder: <span class="token string">'./doc-exec'</span>
    <span class="token punctuation">{{'}'}}</span>,
    workspace: <span class="token punctuation">{{'{'}}</span>
      name: <span class="token string">'@travetto-doc/web'</span>,
      path: <span class="token string">'./doc-exec'</span>,
      mono: false,
      manager: <span class="token string">'npm'</span>,
      type: <span class="token string">'commonjs'</span>,
      defaultEnv: <span class="token string">'local'</span>
    <span class="token punctuation">{{'}'}}</span>
  <span class="token punctuation">{{'}'}}</span>,
  runtime: <span class="token punctuation">{{'{'}}</span>
    env: <span class="token string">'local'</span>,
    debug: false,
    production: false,
    dynamic: false,
    resourcePaths: <span class="token punctuation">[</span> <span class="token string">'./doc-exec/resources'</span> <span class="token punctuation">]</span>,
    profiles: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">{{'}'}}</span>,
  config: <span class="token punctuation">{{'{'}}</span>
    sources: <span class="token punctuation">[</span> <span class="token punctuation">{{'{'}}</span> priority: <span class="token number">999</span>, source: <span class="token string">'memory://override'</span> <span class="token punctuation">{{'}'}}</span> <span class="token punctuation">]</span>,
    active: <span class="token punctuation">{{'{'}}</span>
      AcceptsConfig: <span class="token punctuation">{{'{'}}</span> applies: false, types: <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{{'}'}}</span>,
      BodyParseConfig: <span class="token punctuation">{{'{'}}</span>
        applies: true,
        limit: <span class="token string">'1mb'</span>,
        parsingTypes: <span class="token punctuation">{{'{'}}</span>
          text: <span class="token string">'text'</span>,
          <span class="token string">'application/json'</span><span class="token builtin class-name">:</span> <span class="token string">'json'</span>,
          <span class="token string">'application/x-www-form-urlencoded'</span><span class="token builtin class-name">:</span> <span class="token string">'form'</span>
        <span class="token punctuation">{{'}'}}</span>
      <span class="token punctuation">{{'}'}}</span>,
      CompressConfig: <span class="token punctuation">{{'{'}}</span>
        applies: true,
        preferredEncodings: <span class="token punctuation">[</span> <span class="token string">'br'</span>, <span class="token string">'gzip'</span>, <span class="token string">'identity'</span> <span class="token punctuation">]</span>,
        supportedEncodings: <span class="token punctuation">[</span> <span class="token string">'br'</span>, <span class="token string">'gzip'</span>, <span class="token string">'identity'</span>, <span class="token string">'deflate'</span> <span class="token punctuation">]</span>
      <span class="token punctuation">{{'}'}}</span>,
      CookieConfig: <span class="token punctuation">{{'{'}}</span>
        applies: true,
        signed: true,
        httpOnly: true,
        sameSite: <span class="token string">'lax'</span>,
        secure: <span class="token boolean">false</span>
      <span class="token punctuation">{{'}'}}</span>,
      CorsConfig: <span class="token punctuation">{{'{'}}</span> applies: <span class="token boolean">true</span> <span class="token punctuation">{{'}'}}</span>,
      DecompressConfig: <span class="token punctuation">{{'{'}}</span>
        applies: true,
        supportedEncodings: <span class="token punctuation">[</span> <span class="token string">'br'</span>, <span class="token string">'gzip'</span>, <span class="token string">'deflate'</span>, <span class="token string">'identity'</span> <span class="token punctuation">]</span>
      <span class="token punctuation">{{'}'}}</span>,
      EtagConfig: <span class="token punctuation">{{'{'}}</span> applies: <span class="token boolean">true</span> <span class="token punctuation">{{'}'}}</span>,
      ResponseCacheConfig: <span class="token punctuation">{{'{'}}</span> applies: true, mode: <span class="token string">'deny'</span> <span class="token punctuation">{{'}'}}</span>,
      TrustProxyConfig: <span class="token punctuation">{{'{'}}</span> applies: true, ips: <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{{'}'}}</span>,
      WebConfig: <span class="token punctuation">{{'{'}}</span> defaultMessage: <span class="token boolean">true</span> <span class="token punctuation">{{'}'}}</span>,
      WebLogConfig: <span class="token punctuation">{{'{'}}</span> applies: true, showStackTrace: <span class="token boolean">true</span> <span class="token punctuation">{{'}'}}</span>
    <span class="token punctuation">{{'}'}}</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span>
Listening</code></pre>
  </figure>

<h3 id="creating-a-custom-cli-entry-point">Creating a Custom CLI Entry Point</h3>

To customize a Web server, you may need to construct an entry point using the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/cli/src/decorators.ts#L84">@CliCommand</a> decorator. This could look like:

  <figure class="code">
    <figcaption class="code">Application entry point for Web Applications
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/doc/cli.run_web_custom.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Env<span class="token punctuation">,</span> toConcrete <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/runtime'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> CliCommand <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/cli'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> DependencyRegistry <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/di'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> RootRegistry <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/registry'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> WebApplication<span class="token punctuation">,</span> WebSslConfig <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/web'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">'./config-override'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">CliCommand</span></span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span> runTarget<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SampleApp</span> <span class="token punctuation">{{'{'}}</span>

  <span class="token function">preMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{{'{'}}</span>
    Env<span class="token punctuation">.</span><span class="token constant">TRV_ENV</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'prod'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'production'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token keyword">async</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'CUSTOM STARTUP'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> RootRegistry<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ssl <span class="token operator">=</span> <span class="token keyword">await</span> DependencyRegistry<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>WebSslConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ssl<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// Configure server before running</span>
    <span class="token keyword">return</span> DependencyRegistry<span class="token punctuation">.</span><span class="token function">runInstance</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">toConcrete</span><span class="token generic class-name"><span class="token operator">&lt;</span>WebApplication<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

And using the pattern established in the <a class="module-link" href="https://github.com/travetto/travetto/tree/main/module/cli" title="CLI infrastructure for Travetto framework">Command Line Interface</a> module, you would run your program using <code class="item command">npx trv run:web:custom</code>.

  <figure class="terminal">
    <figcaption class="terminal">Custom application

</figcaption>
    <pre><code class="language-bash">$ trv run:web:custom

AppError: Unable to get instance when target is undefined
    at <span class="token variable">$DependencyRegistry</span>.getInstance <span class="token punctuation">(</span><span class="token operator">&lt;</span>workspace-root<span class="token operator">></span>/module/di/src/registry.ts:283:13<span class="token punctuation">)</span>
    at SampleApp.main <span class="token punctuation">(</span>./doc/cli.run_web_custom.ts:20:42<span class="token punctuation">)</span>
    at async Function.<span class="token comment">#runCommand (&lt;workspace-root>/module/cli/src/execute.ts:58:20)</span>
    at async Function.run <span class="token punctuation">(</span><span class="token operator">&lt;</span>workspace-root<span class="token operator">></span>/module/cli/src/execute.ts:75:9<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
  type: <span class="token string">'AppError'</span>,
  category: <span class="token string">'general'</span>,
  at: <span class="token string">'2029-03-14T04:00:00.618Z'</span>,
  details: undefined
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h2 id="request-response-pattern">Request/Response Pattern</h2>

Unlike other frameworks (e.g. <a target="_blank" class="external-link" href="https://expressjs.com">express</a>, <a target="_blank" class="external-link" href="https://www.fastify.io/">fastify</a>), this module takes an approach that is similar to <a target="_blank" class="external-link" href="https://aws.amazon.com/lambda/">AWS Lambda</a>'s model for requests and responses. What you can see here is that <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/types/request.ts#L11">WebRequest</a> and <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/types/response.ts#L3">WebResponse</a> are very simple objects, with the focus being on the <code class="item field">payload</code> and <code class="item field">body</code>.  This is intended to provide maximal compatibility with non-HTTP sources.  The driving goal is to support more than just standard HTTP servers but also allow for seamless integration with tools like event queues, web sockets, etc.

  <figure class="code">
    <figcaption class="code">Base Shape
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/src/types/message.ts#L23">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseWebMessage<span class="token operator">&lt;</span><span class="token constant">B</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span> <span class="token constant">C</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token operator">></span></span> <span class="token keyword">implements</span> <span class="token class-name">WebMessage<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token operator">></span></span> <span class="token punctuation">{{'{'}}</span>
  <span class="token keyword">readonly</span> context<span class="token operator">:</span> <span class="token constant">C</span><span class="token punctuation">;</span>
  <span class="token keyword">readonly</span> headers<span class="token operator">:</span> WebHeaders<span class="token punctuation">;</span>
  body<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">B</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>o<span class="token operator">:</span> WebMessageInit<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{{'{'}}</span><span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

  <figure class="code">
    <figcaption class="code">Request Shape
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/src/types/request.ts#L22">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"></code></pre>
  </figure>

  <figure class="code">
    <figcaption class="code">Response Shape
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/src/types/response.ts#L10">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">WebResponse<span class="token operator">&lt;</span><span class="token constant">B</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token operator">></span></span> <span class="token keyword">extends</span> <span class="token class-name">BaseWebMessage<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token punctuation">,</span> WebResponseContext<span class="token operator">></span></span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
    * Build the redirect
    * @param location Location to redirect to
    * @param statusCode Status code
    */</span>
  <span class="token keyword">static</span> <span class="token function">redirect</span><span class="token punctuation">(</span>location<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> statusCode <span class="token operator">=</span> <span class="token number">302</span><span class="token punctuation">)</span><span class="token operator">:</span> WebResponse<span class="token operator">&lt;</span><span class="token keyword">undefined</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

These objects do not represent the underlying sockets provided by various http servers, but in fact are simple wrappers that track the flow through the call stack of the various <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/types/interceptor.ts#L15">WebInterceptor</a> s and the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/endpoint.ts#L14">Endpoint</a> handler.  One of the biggest departures here, is that the response is not an entity that is passed around from call-site to call-site, but is is solely a return-value.  This doesn't mean the return value has to be static and pre-allocated, on the contrary streams are still supported.  The difference here is that the streams/asynchronous values will be consumed until the response is sent back to the user. The <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/compress.ts#L49">CompressInterceptor</a> is a good reference for transforming a <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/types/response.ts#L3">WebResponse</a> that can either be a stream or a fixed value.

<h2 id="defining-a-controller">Defining a Controller</h2>

To start, we must define a <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/controller.ts#L9">@Controller</a>, which is only allowed on classes. Controllers can be configured with:
<ul> <li><code class="item input">path</code> - The required context path the controller will operate atop</li>
<li><code class="item input">title</code> - The definition of the controller</li>
<li><code class="item input">description</code> - High level description fo the controller</li>
</ul>
Additionally, the module is predicated upon <a class="module-link" href="https://github.com/travetto/travetto/tree/main/module/di" title="Dependency registration/management and injection support.">Dependency Injection</a>, and so all standard injection techniques (constructor, fields) work for registering dependencies. <br><br>
<a target="_blank" class="external-link" href="http://usejsdoc.org/about-getting-started.html">JSDoc</a> comments can also be used to define the <code class="item input">title</code> attribute.

  <figure class="code">
    <figcaption class="code">Basic Controller Registration
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/doc/simple-controller.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Controller <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/web'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">'/simple'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">SimpleController</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">// endpoints</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h2 id="defining-an-endpoint">Defining an Endpoint</h2>

Once the controller is declared, each method of the controller is a candidate for being an endpoint.  By design, everything is asynchronous, and so async/await is natively supported. <br><br>
The most common pattern is to register HTTP-driven endpoints.  The HTTP methods that are currently supported:
<ul> <li><a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/endpoint.ts#L43">@Get</a></li>
<li><a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/endpoint.ts#L50">@Post</a></li>
<li><a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/endpoint.ts#L57">@Put</a></li>
<li><a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/endpoint.ts#L70">@Delete</a></li>
<li><a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/endpoint.ts#L64">@Patch</a></li>
<li><a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/endpoint.ts#L76">@Head</a></li>
<li><a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/endpoint.ts#L82">@Options</a></li>
</ul>
Similar to the Controller, each endpoint decorator handles the following config:
<ul> <li><code class="item input">title</code> - The definition of the endpoint</li>
<li><code class="item input">description</code> - High level description fo the endpoint</li>
</ul>
<a target="_blank" class="external-link" href="http://usejsdoc.org/about-getting-started.html">JSDoc</a> comments can also be used to define the <code class="item input">title</code> attribute, as well as describing the parameters using <code class="item input">@param</code> tags in the comment. <br><br>
The return type of the method will also be used to describe the <code class="item input">responseType</code> if not specified manually.

  <figure class="code">
    <figcaption class="code">Controller with Sample Endpoint
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/doc/simple-endpoint.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Get<span class="token punctuation">,</span> Controller <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/web'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Data</span> <span class="token punctuation">{{'{'}}</span> <span class="token punctuation">{{'}'}}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">'/simple'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">SimpleController</span> <span class="token punctuation">{{'{'}}</span>

  <span class="token comment">/**
   * Gets the most basic of data
   */</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">simpleGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">let</span> data<span class="token operator">:</span> Data <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token comment">//</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<p class="note"><strong>Note</strong> In development mode the module supports hot reloading of <code class="item input">class</code>es.  Endpoints can be added/modified/removed at runtime.</p>

<h3 id="parameters">Parameters</h3>

Endpoints can be configured to describe and enforce parameter behavior.  Request parameters can be defined in five areas:
<ul> <li><a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/param.ts#L37">@PathParam</a> - Path params</li>
<li><a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/param.ts#L43">@QueryParam</a> - Query params - can be either a single value or bind to a whole object</li>
<li><a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/param.ts#L55">@Body</a> - Request body</li>
<li><a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/param.ts#L49">@HeaderParam</a> - Header values</li>
</ul>
Each <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/param.ts#L24">@Param</a> can be configured to indicate:
<ul> <li><code class="item input">name</code> - Name of param, field name, defaults to handler parameter name if necessary</li>
<li><code class="item input">description</code> - Description of param, pulled from <a target="_blank" class="external-link" href="http://usejsdoc.org/about-getting-started.html">JSDoc</a>, or defaults to name if empty</li>
<li><code class="item input">required?</code> - Is the field required?, defaults to whether or not the parameter itself is optional</li>
<li><code class="item input">type</code> - The class of the type to be enforced, pulled from parameter type</li>
</ul>
<a target="_blank" class="external-link" href="http://usejsdoc.org/about-getting-started.html">JSDoc</a> comments can also be used to describe parameters using <code class="item input">@param</code> tags in the comment.

  <figure class="code">
    <figcaption class="code">Full-fledged Controller with Endpoints
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/doc/simple-full.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Get<span class="token punctuation">,</span> Controller<span class="token punctuation">,</span> Post<span class="token punctuation">,</span> QueryParam<span class="token punctuation">,</span> WebRequest<span class="token punctuation">,</span> ContextParam <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/web'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Integer<span class="token punctuation">,</span> Min <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/schema'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> MockService <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'./mock.ts'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">'/simple'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Simple</span> <span class="token punctuation">{{'{'}}</span>

  service<span class="token operator">:</span> MockService<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ContextParam</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  request<span class="token operator">:</span> WebRequest<span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>service<span class="token operator">:</span> MockService<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>service <span class="token operator">=</span> service<span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token comment">/**
   * Get a random user by name
   */</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">'/name'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/simple/name => </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${{'{'}}</span>user<span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">{{'}'}}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token comment">/**
   * Get a user by id
   */</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/simple/id => </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${{'{'}}</span>user<span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">{{'}'}}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">'/name'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">createName</span><span class="token punctuation">(</span>person<span class="token operator">:</span> <span class="token punctuation">{{'{'}}</span> name<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span> name<span class="token operator">:</span> person<span class="token punctuation">.</span>name <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{{'{'}}</span> success<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">'img/*'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">getImage</span><span class="token punctuation">(</span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">QueryParam</span></span><span class="token punctuation">(</span><span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Integer</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Min</span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> width<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">QueryParam</span></span><span class="token punctuation">(</span><span class="token string">'h'</span><span class="token punctuation">)</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Integer</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Min</span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> height<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">const</span> img <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">fetchImage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span>context<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token punctuation">{{'{'}}</span> width<span class="token punctuation">,</span> height <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> img<span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h3 id="contextparam">ContextParam</h3>

In addition to endpoint parameters (i.e. user-provided inputs), there may also be a desire to access indirect contextual information.  Specifically you may need access to the entire <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/types/request.ts#L11">WebRequest</a>.  These are able to be injected using the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/param.ts#L61">@ContextParam</a> on a class-level field from the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/context.ts#L9">WebAsyncContext</a>.  These are not exposed as endpoint parameters as they cannot be provided when making RPC invocations.

  <figure class="code">
    <figcaption class="code">Example ContextParam usage
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/doc/context-param.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> CacheControl<span class="token punctuation">,</span> ContextParam<span class="token punctuation">,</span> Controller<span class="token punctuation">,</span> Get<span class="token punctuation">,</span> WebRequest<span class="token punctuation">,</span> WebResponse <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/web'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">'/context'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">ContextController</span> <span class="token punctuation">{{'{'}}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ContextParam</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  request<span class="token operator">:</span> WebRequest<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Gets the ip of the user, ensure no caching
   */</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">CacheControl</span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">'/ip'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WebResponse</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span>
      body<span class="token operator">:</span> <span class="token punctuation">{{'{'}}</span> ip<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span>context<span class="token punctuation">.</span>connection<span class="token operator">?.</span>ip <span class="token punctuation">{{'}'}}</span><span class="token punctuation">,</span>
      headers<span class="token operator">:</span> <span class="token punctuation">{{'{'}}</span>
        <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json+ip'</span>
      <span class="token punctuation">{{'}'}}</span>
    <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<p class="note"><strong>Note</strong> When referencing the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/param.ts#L61">@ContextParam</a> values, the contract for idempotency needs to be carefully inspected, if expected. You can see in the example above that the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/common.ts#L55">CacheControl</a> decorator is used to ensure that the response is not cached.</p>

<h3 id="validating-inputs">Validating Inputs</h3>

The module provides high level access for <a class="module-link" href="https://github.com/travetto/travetto/tree/main/module/schema" title="Data type registry for runtime validation, reflection and binding.">Schema</a> support, via decorators, for validating and typing request inputs. <br><br>
By default, all endpoint parameters are validated for type, and any additional constraints added (required, vs optional, minlength, etc).  Each parameter location (<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/param.ts#L37">@PathParam</a>, <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/param.ts#L55">@Body</a>, <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/param.ts#L43">@QueryParam</a>, <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/param.ts#L49">@HeaderParam</a>) primarily provides a source to bind the endpoint arguments from.  Once bound, the module will validate that the provided arguments are in fact valid. All validation will occur before the endpoint is ever executed, ensuring a strong contract.

  <figure class="code">
    <figcaption class="code">Using Body for POST requests
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/doc/schema-body.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Schema <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/schema'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Controller<span class="token punctuation">,</span> Post<span class="token punctuation">,</span> Body <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/web'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Schema</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{{'{'}}</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  age<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{{'{'}}</span>

  <span class="token keyword">private</span> service<span class="token operator">:</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token function">update</span><span class="token punctuation">(</span>user<span class="token operator">:</span> User<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>User<span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">'/saveUser'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token operator">:</span> User<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">const</span> saved <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{{'{'}}</span> success<span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>saved <span class="token punctuation">{{'}'}}</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

  <figure class="code">
    <figcaption class="code">Using Query + Schema for GET requests
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/doc/schema-query.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Schema <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/schema'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Controller<span class="token punctuation">,</span> Get <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/web'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Schema</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">SearchParams</span> <span class="token punctuation">{{'{'}}</span>
  page<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  pageSize<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{{'{'}}</span>

  <span class="token keyword">private</span> service<span class="token operator">:</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token function">search</span><span class="token punctuation">(</span>query<span class="token operator">:</span> SearchParams<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">'/search'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">search</span><span class="token punctuation">(</span>query<span class="token operator">:</span> SearchParams<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

Additionally, schema related inputs can also be used with <code class="item input">interface</code>s and <code class="item input">type</code> literals in lieu of classes. This is best suited for simple types:

  <figure class="code">
    <figcaption class="code">Using QuerySchema with a type literal
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/doc/schema-query-type.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Controller<span class="token punctuation">,</span> Get <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/web'</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">Paging</span> <span class="token operator">=</span> <span class="token punctuation">{{'{'}}</span>
  page<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  pageSize<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{{'{'}}</span>

  <span class="token keyword">private</span> service<span class="token operator">:</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token function">search</span><span class="token punctuation">(</span>query<span class="token operator">:</span> Paging<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">'/search'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">search</span><span class="token punctuation">(</span>query<span class="token operator">:</span> Paging <span class="token operator">=</span> <span class="token punctuation">{{'{'}}</span> page<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> pageSize<span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h2 id="using-interceptors">Using Interceptors</h2>

<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/types/interceptor.ts#L15">WebInterceptor</a> s are a key part of the web framework, to allow for conditional functionality to be added, across all endpoints.
<h3 id="anatomy-of-an-interceptor">Anatomy of an Interceptor</h3>

  <figure class="code">
    <figcaption class="code">A Simple Interceptor
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/doc/interceptor-hello-world.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> WebChainedContext<span class="token punctuation">,</span> WebInterceptor<span class="token punctuation">,</span> WebInterceptorCategory<span class="token punctuation">,</span> WebInterceptorContext <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/web'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Injectable <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/di'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HelloWorldInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">WebInterceptor</span> <span class="token punctuation">{{'{'}}</span>

  category<span class="token operator">:</span> WebInterceptorCategory <span class="token operator">=</span> <span class="token string">'application'</span><span class="token punctuation">;</span>

  <span class="token function">applies</span><span class="token punctuation">(</span>context<span class="token operator">:</span> WebInterceptorContext<span class="token operator">&lt;</span><span class="token builtin">unknown</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">return</span> context<span class="token punctuation">.</span>endpoint<span class="token punctuation">.</span>httpMethod <span class="token operator">===</span> <span class="token string">'HEAD'</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token function">filter</span><span class="token punctuation">(</span>ctx<span class="token operator">:</span> WebChainedContext<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello world!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ctx<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

In this example you can see the markers of a simple interceptor:
<h4 id="category">category</h4>

<code class="item field">category</code> - This represents the generally request lifecycle phase an interceptor will run in.  It can be customized further with <code class="item field">dependsOn</code> and <code class="item field">runsBefore</code> to control exact ordering within a category.  In this example <code class="item input">application</code> represents the lowest priority, and will run right before the endpoint is executed.

<h4 id="applies">applies</h4>

<code class="item method">applies</code> - This represents ability for the per-endpoint configuration to determine if an interceptor is applicable.  By default, all interceptors will auto-register on every endpoint. Some interceptors are opt-in, and control that by setting applies to constantly return <code class="item input">false</code>.

<h4 id="filter">filter</h4>

<code class="item method">filter</code> - This is the actual logic that will be invoked around the endpoint call, represented by <code class="item input">ctx.next()</code>.  The next call passes control to the next interceptor all the way down to the endpoint, and then will pop back up the stack.  Code executed before <code class="item input">next()</code> is generally used for request filtering, and code afterwards is generally used for response control.

Out of the box, the web framework comes with a few interceptors, and more are contributed by other modules as needed.  The default interceptor set is (in order of execution):
<h3 id="order-of-execution">Order of Execution</h3>

<ol> <li>global - Intended to run outside of the request flow - <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/context.ts#L13">AsyncContextInterceptor</a></li>
<li>terminal - Handles once request and response are finished building - <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/logging.ts#L28">LoggingInterceptor</a>, <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/respond.ts#L12">RespondInterceptor</a></li>
<li>pre-request - Prepares the request for running - <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/trust-proxy.ts#L23">TrustProxyInterceptor</a></li>
<li>request - Handles inbound request, validation, and body preparation - <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/decompress.ts#L52">DecompressInterceptor</a>, <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/accepts.ts#L32">AcceptsInterceptor</a>, <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/body-parse.ts#L53">BodyParseInterceptor</a>, <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/cookies.ts#L55">CookiesInterceptor</a> </li>
<li>response - Prepares outbound response - <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/compress.ts#L49">CompressInterceptor</a>, <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/cors.ts#L51">CorsInterceptor</a>, <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/etag.ts#L34">EtagInterceptor</a>, <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/response-cache.ts#L30">ResponseCacheInterceptor</a> </li>
<li>application - Lives outside of the general request/response behavior, <a class="module-link" href="https://github.com/travetto/travetto/tree/main/module/auth-web" title="Web authentication integration support for the Travetto framework">Web Auth</a> uses this for login and logout flows.</li>
</ol>

<h3 id="packaged-interceptors">Packaged Interceptors</h3>

<h4 id="asynccontextinterceptor">AsyncContextInterceptor</h4>

<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/context.ts#L13">AsyncContextInterceptor</a> is responsible for sharing context across the various layers that may be touched by a request.  This

<h4 id="logginginterceptor">LoggingInterceptor</h4>

<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/logging.ts#L28">LoggingInterceptor</a> is used for logging the request/response, handling any error logging as needed. This interceptor can be noisy, and so can easily be disabled as needed by setting <code class="item input">web.log.applies: false</code> in your config.

  <figure class="code">
    <figcaption class="code">Web Log Config
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/logging.ts#L13">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">WebLogConfig</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Enable logging of all requests
   */</span>
  applies <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Should errors be dumped as full stack traces
   */</span>
  showStackTrace <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h4 id="respondinterceptor">RespondInterceptor</h4>

<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/respond.ts#L12">RespondInterceptor</a> is a basic catch-all that forces errors and data alike into a consistent format for sending back to the user.

<h4 id="trustproxyinterceptor">TrustProxyInterceptor</h4>

<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/trust-proxy.ts#L23">TrustProxyInterceptor</a> allows for overriding connection information (host, ip, protocol) using <code class="item input">X-Forwarded-*</code> headers.  This allows for proxied requests to retain access to the "source" request information as necessary.

  <figure class="code">
    <figcaption class="code">TrustProxy Config
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/trust-proxy.ts#L11">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TrustProxyConfig</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Enforces trust rules for X-Forwarded-* headers
   */</span>
  applies <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * The accepted ips
   */</span>
  ips<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h4 id="acceptsinterceptor">AcceptsInterceptor</h4>

<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/accepts.ts#L32">AcceptsInterceptor</a> handles verifying the inbound request matches the allowed content-types. This acts as a standard gate-keeper for spurious input.

  <figure class="code">
    <figcaption class="code">Accepts Config
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/accepts.ts#L14">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AcceptsConfig</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Accepts certain request content types
   */</span>
  applies <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * The accepted types
   */</span>
  types<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Ignore</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function-variable function">matcher</span><span class="token operator">:</span> <span class="token punctuation">(</span>type<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h4 id="decompressinterceptor">DecompressInterceptor</h4>

<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/decompress.ts#L52">DecompressInterceptor</a> handles decompressing the inbound request, if supported.  This relies upon HTTP standards for content encoding, and negotiating the appropriate decompression scheme.

  <figure class="code">
    <figcaption class="code">Decompress Config
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/decompress.ts#L37">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">DecompressConfig</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Parse request body
   */</span>
  applies<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Supported encodings
   */</span>
  supportedEncodings<span class="token operator">:</span> WebDecompressEncoding<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'br'</span><span class="token punctuation">,</span> <span class="token string">'gzip'</span><span class="token punctuation">,</span> <span class="token string">'deflate'</span><span class="token punctuation">,</span> <span class="token string">'identity'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h4 id="cookiesinterceptor">CookiesInterceptor</h4>

<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/cookies.ts#L55">CookiesInterceptor</a> is responsible for processing inbound cookie headers and populating the appropriate data on the request, as well as sending the appropriate response data

  <figure class="code">
    <figcaption class="code">Cookies Config
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/cookies.ts#L19">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CookieConfig</span> <span class="token keyword">implements</span> <span class="token class-name">CookieSetOptions</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Support reading/sending cookies
   */</span>
  applies <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Are they signed
   */</span>
  signed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Supported only via http (not in JS)
   */</span>
  httpOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Enforce same site policy
   */</span>
  sameSite<span class="token operator">:</span> Cookie<span class="token punctuation">[</span><span class="token string">'sameSite'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'lax'</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * The signing keys
   */</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Secret</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  keys<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Is the cookie only valid for https
   */</span>
  secure<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * The domain of the cookie
   */</span>
  domain<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h4 id="bodyparseinterceptor">BodyParseInterceptor</h4>

<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/body-parse.ts#L53">BodyParseInterceptor</a> handles the inbound request, and converting the body payload into an appropriate format.

  <figure class="code">
    <figcaption class="code">Body Parse Config
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/body-parse.ts#L30">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BodyParseConfig</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Parse request body
   */</span>
  applies<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Max body size limit
   */</span>
  limit<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">'1mb'</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * How to interpret different content types
   */</span>
  parsingTypes<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{{'{'}}</span>
    text<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'application/json'</span><span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'application/x-www-form-urlencoded'</span><span class="token operator">:</span> <span class="token string">'form'</span>
  <span class="token punctuation">{{'}'}}</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h4 id="compressinterceptor">CompressInterceptor</h4>

<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/compress.ts#L49">CompressInterceptor</a> by default, will compress all valid outbound responses over a certain size, or for streams will cache every response. This relies on Node's <a target="_blank" class="external-link" href="https://nodejs.org/api/zlib.html">Buffer</a> support for compression.

  <figure class="code">
    <figcaption class="code">Compress Config
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/compress.ts#L26">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CompressConfig</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Attempting to compressing responses
   */</span>
  applies<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Raw encoding options
   */</span>
  raw<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>ZlibOptions <span class="token operator">&amp;</span> BrotliOptions<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Preferred encodings
   */</span>
  preferredEncodings<span class="token operator">?</span><span class="token operator">:</span> WebCompressEncoding<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'br'</span><span class="token punctuation">,</span> <span class="token string">'gzip'</span><span class="token punctuation">,</span> <span class="token string">'identity'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Supported encodings
   */</span>
  supportedEncodings<span class="token operator">:</span> WebCompressEncoding<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'br'</span><span class="token punctuation">,</span> <span class="token string">'gzip'</span><span class="token punctuation">,</span> <span class="token string">'identity'</span><span class="token punctuation">,</span> <span class="token string">'deflate'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h4 id="etaginterceptor">EtagInterceptor</h4>

<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/etag.ts#L34">EtagInterceptor</a> by default, will tag all cacheable HTTP responses, when the response value/length is known.  Streams, and other async data sources do not have a pre-defined length, and so are ineligible for etagging.

  <figure class="code">
    <figcaption class="code">ETag Config
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/etag.ts#L16">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EtagConfig</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Attempt ETag generation
   */</span>
  applies <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Should we generate a weak etag
   */</span>
  weak<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Ignore</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  cacheable<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h4 id="corsinterceptor">CorsInterceptor</h4>

<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/cors.ts#L51">CorsInterceptor</a> allows cors functionality to be configured out of the box, by setting properties in your <code class="item path">application.yml</code>, specifically, the <code class="item input">web.cors</code> config space.

  <figure class="code">
    <figcaption class="code">Cors Config
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/cors.ts#L16">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CorsConfig</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Send CORS headers on responses
   */</span>
  applies <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Allowed origins
   */</span>
  origins<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Allowed http methods
   */</span>
  methods<span class="token operator">?</span><span class="token operator">:</span> HttpMethod<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Allowed http headers
   */</span>
  headers<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Support credentials?
   */</span>
  credentials<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Ignore</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  resolved<span class="token operator">:</span> <span class="token punctuation">{{'{'}}</span>
    origins<span class="token operator">:</span> Set<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">;</span>
    methods<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    headers<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    credentials<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h4 id="responsecacheinterceptor">ResponseCacheInterceptor</h4>

<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/response-cache.ts#L30">ResponseCacheInterceptor</a> by default, disables caching for all GET requests if the response does not include caching headers.  This can be managed by setting <code class="item input">web.getCache.applies: &lt;boolean&gt;</code> in your config.  This interceptor applies by default.

<h3 id="configuring-interceptors">Configuring Interceptors</h3>

All framework-provided interceptors, follow the same patterns for general configuration.  This falls into three areas:
<h4 id="enable-disable-of-individual-interceptors-via-configuration">Enable/disable of individual interceptors via configuration</h4>

This applies only to interceptors that have opted in, to exposing a config, and tying that configuration to the applies logic.

  <figure class="code">
    <figcaption class="code">Sample interceptor disabling configuration
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/doc/disable.yml">Source</a></cite>

</figcaption>
    <pre><code class="language-yaml"><span class="token key atrule">web</span><span class="token punctuation">:</span>
  <span class="token key atrule">trustProxy</span><span class="token punctuation">:</span>
    <span class="token key atrule">applies</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></code></pre>
  </figure>

  <figure class="code">
    <figcaption class="code">Configurable Interceptor
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/src/interceptor/trust-proxy.ts#L11">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TrustProxyConfig</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token comment">/**
   * Enforces trust rules for X-Forwarded-* headers
   */</span>
  applies <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * The accepted ips
   */</span>
  ips<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h4 id="endpoint-enabled-control-via-decorators">Endpoint-enabled control via decorators</h4>

  <figure class="code">
    <figcaption class="code">Sample controller with endpoint-level allow/deny
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/doc/controller-endpoint-deny.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Controller<span class="token punctuation">,</span> Get<span class="token punctuation">,</span> QueryParam<span class="token punctuation">,</span> ConfigureInterceptor<span class="token punctuation">,</span> CorsInterceptor<span class="token punctuation">,</span> ExcludeInterceptors <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/web'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">'/allowDeny'</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">ConfigureInterceptor</span></span><span class="token punctuation">(</span>CorsInterceptor<span class="token punctuation">,</span> <span class="token punctuation">{{'{'}}</span> applies<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AlowDenyController</span> <span class="token punctuation">{{'{'}}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">'/override'</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ConfigureInterceptor</span></span><span class="token punctuation">(</span>CorsInterceptor<span class="token punctuation">,</span> <span class="token punctuation">{{'{'}}</span> applies<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span>
  <span class="token function">withoutCors</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">QueryParam</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> value<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>

  <span class="token punctuation">{{'}'}}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">'/raw'</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ExcludeInterceptors</span></span><span class="token punctuation">(</span>v <span class="token operator">=></span> v<span class="token punctuation">.</span>category <span class="token operator">===</span> <span class="token string">'response'</span><span class="token punctuation">)</span>
  <span class="token function">withoutResponse</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">QueryParam</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> value<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>

  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

The resolution logic is as follows:
<ul> <li>Check the resolved <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/endpoint.ts#L14">Endpoint</a>/<a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/decorator/controller.ts#L9">@Controller</a> overrides to see if an interceptor is explicitly allowed or disallowed</li>
<li>Default to <code class="item method">applies()</code> logic for all available interceptors</li>
</ul>

<h2 id="creating-a-custom-webinterceptor">Creating a Custom WebInterceptor</h2>

Additionally it may be desirable to create a custom interceptor.  Interceptors can be registered with the <a class="module-link" href="https://github.com/travetto/travetto/tree/main/module/di" title="Dependency registration/management and injection support.">Dependency Injection</a> by implementing the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/types/interceptor.ts#L15">WebInterceptor</a> interface and adding an <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/di/src/decorator.ts#L29">@Injectable</a> decorator. A simple logging interceptor:

  <figure class="code">
    <figcaption class="code">Defining a new Interceptor
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/doc/interceptor-logging.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> WebChainedContext<span class="token punctuation">,</span> WebInterceptor<span class="token punctuation">,</span> WebInterceptorCategory <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/web'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Injectable <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/di'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Appender</span> <span class="token punctuation">{{'{'}}</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{{'{'}}</span> <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CustomLoggingInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">WebInterceptor</span> <span class="token punctuation">{{'{'}}</span>

  category<span class="token operator">:</span> WebInterceptorCategory <span class="token operator">=</span> <span class="token string">'terminal'</span><span class="token punctuation">;</span>

  appender<span class="token operator">:</span> Appender<span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>appender<span class="token operator">:</span> Appender<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>appender <span class="token operator">=</span> appender<span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>

  <span class="token keyword">async</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span> request<span class="token punctuation">,</span> next <span class="token punctuation">{{'}'}}</span><span class="token operator">:</span> WebChainedContext<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{{'{'}}</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{'}'}}</span> <span class="token keyword">finally</span> <span class="token punctuation">{{'{'}}</span>
      <span class="token comment">// Write request to database</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>appender<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>context<span class="token punctuation">.</span>httpMethod<span class="token punctuation">,</span> request<span class="token punctuation">.</span>context<span class="token punctuation">.</span>path<span class="token punctuation">,</span> request<span class="token punctuation">.</span>context<span class="token punctuation">.</span>httpQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{'}'}}</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

When running an interceptor, if you chose to skip calling <code class="item method">ctx.next()</code>, you will bypass all the downstream interceptors and return a response directly.

  <figure class="code">
    <figcaption class="code">Defining a fully controlled Interceptor
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/doc/interceptor-controlled.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> WebInterceptor<span class="token punctuation">,</span> WebInterceptorCategory<span class="token punctuation">,</span> WebChainedContext<span class="token punctuation">,</span> WebResponse <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/web'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> Injectable <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/di'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span> AppError <span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/runtime'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SimpleAuthInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">WebInterceptor</span> <span class="token punctuation">{{'{'}}</span>

  category<span class="token operator">:</span> WebInterceptorCategory <span class="token operator">=</span> <span class="token string">'terminal'</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">filter</span><span class="token punctuation">(</span>ctx<span class="token operator">:</span> WebChainedContext<span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'X-Auth'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{'}'}}</span> <span class="token keyword">else</span> <span class="token punctuation">{{'{'}}</span>
      <span class="token comment">// Or just -- throw new AppError('Missing auth', {{'{'}} category: 'authentication' {{'}'}});</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WebResponse</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span>
        body<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AppError</span><span class="token punctuation">(</span><span class="token string">'Missing auth'</span><span class="token punctuation">,</span> <span class="token punctuation">{{'{'}}</span> category<span class="token operator">:</span> <span class="token string">'authentication'</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        context<span class="token operator">:</span> <span class="token punctuation">{{'{'}}</span>
          httpStatusCode<span class="token operator">:</span> <span class="token number">401</span>
        <span class="token punctuation">{{'}'}}</span>
      <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{'}'}}</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h2 id="cookie-support">Cookie Support</h2>

<a target="_blank" class="external-link" href="https://expressjs.com">express</a>/<a target="_blank" class="external-link" href="https://koajs.com/">koa</a>/<a target="_blank" class="external-link" href="https://www.fastify.io/">fastify</a> all have their own cookie implementations that are common for each framework but are somewhat incompatible.  To that end, cookies are supported for every platform, by using <a target="_blank" class="external-link" href="https://www.npmjs.com/package/cookies">cookies</a>.  This functionality is exposed onto the <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/types/request.ts#L11">WebRequest</a> object following the pattern set forth by Koa (this is the library Koa uses).  This choice also enables better security support as we are able to rely upon standard behavior when it comes to cookies, and signing.

  <figure class="code">
    <figcaption class="code">Sample Cookie Usage
<cite><a target="_blank" href="https://github.com/travetto/travetto/tree/main/module/web/doc/cookie-endpoints.ts">Source</a></cite>

</figcaption>
    <pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{{'{'}}</span>
  Controller<span class="token punctuation">,</span> Get<span class="token punctuation">,</span> QueryParam<span class="token punctuation">,</span> WebRequest<span class="token punctuation">,</span> ContextParam<span class="token punctuation">,</span>
  WebResponse<span class="token punctuation">,</span> CookieJar<span class="token punctuation">,</span> CookieGetOptions<span class="token punctuation">,</span> CookieSetOptions
<span class="token punctuation">{{'}'}}</span> <span class="token keyword">from</span> <span class="token string">'@travetto/web'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">'/simple'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SimpleEndpoints</span> <span class="token punctuation">{{'{'}}</span>

  <span class="token keyword">private</span> getOptions<span class="token operator">:</span> CookieGetOptions<span class="token punctuation">;</span>
  <span class="token keyword">private</span> setOptions<span class="token operator">:</span> CookieSetOptions<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ContextParam</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  request<span class="token operator">:</span> WebRequest<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ContextParam</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  cookies<span class="token operator">:</span> CookieJar<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">'/cookies'</span><span class="token punctuation">)</span>
  <span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">QueryParam</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> value<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{{'{'}}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Set a cookie on response</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span> name<span class="token operator">:</span> <span class="token string">'name'</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>setOptions <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WebResponse</span><span class="token punctuation">(</span><span class="token punctuation">{{'{'}}</span> body<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token punctuation">{{'}'}}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{'}'}}</span>
<span class="token punctuation">{{'}'}}</span></code></pre>
  </figure>

<h2 id="ssl-support">SSL Support</h2>

Additionally the framework supports SSL out of the box, by allowing you to specify your public and private keys for the cert.  In dev mode, the framework will also automatically generate a self-signed cert if:
<ul> <li>SSL support is configured</li>
<li><a target="_blank" class="external-link" href="https://www.npmjs.com/package/node-forge">node-forge</a> is installed</li>
<li>Not running in prod</li>
<li>No keys provided</li>
</ul>
This is useful for local development where you implicitly trust the cert. <br><br>
SSL support can be enabled by setting <code class="item input">web.ssl.active: true</code> in your config. The key/cert can be specified as string directly in the config file/environment variables.  The key/cert can also be specified as a path to be picked up by <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/runtime/src/resources.ts#L8">RuntimeResources</a>.

<h2 id="full-config">Full Config</h2>

The entire <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/web/src/config.ts#L7">WebConfig</a> which will show the full set of valid configuration parameters for the web module.
