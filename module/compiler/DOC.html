<!-- This file was generated by @travetto/doc and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/main/module/compiler/DOC.tsx and execute "npx trv doc" to rebuild -->
<h1>Compiler
<small>The compiler infrastructure for the Travetto framework</small>
</h1>

  <figure class="install">
    <figcaption class="install">Install @travetto/compiler
    
    </figcaption>
    <pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> @travetto/compiler

<span class="token comment"># or</span>

<span class="token function">yarn</span> <span class="token function">add</span> @travetto/compiler</code></pre>
  </figure>

This module expands upon the <a target="_blank" class="external-link" href="https://typescriptlang.org">Typescript</a> compiler, with the additional features:
<ul> <li>Integration with the <a class="module-link" href="https://github.com/travetto/travetto/tree/main/module/transformer" title="Functionality for AST transformations, with transformer registration, and general utils">Transformation</a> module, allowing for rich, type-aware transformations</li>
<li>Automatic conversion to either <a target="_blank" class="external-link" href="https://nodejs.org/api/esm.html">Ecmascript Module</a> or <a target="_blank" class="external-link" href="https://nodejs.org/api/modules.html">CommonJS</a> based on the <a target="_blank" class="external-link" href="https://docs.npmjs.com/cli/v9/configuring-npm/package-json">Package JSON</a> <code class="item field">type</code> value</li>
<li>Removal of type only imports which can break <a target="_blank" class="external-link" href="https://nodejs.org/api/esm.html">Ecmascript Module</a>-style output</li>
<li>Automatic addition of <code class="item path">.js</code> extension to imports to also support  <a target="_blank" class="external-link" href="https://nodejs.org/api/esm.html">Ecmascript Module</a>-style output</li>
</ul>
Beyond the <a target="_blank" class="external-link" href="https://typescriptlang.org">Typescript</a> compiler functionality, the module provides the primary entry point into the development process.
<h2 id="cli">CLI</h2>

The compiler cli, <a target="_blank" class="source-link" href="https://github.com/travetto/travetto/tree/main/module/compiler/bin/trvc.js">trvc</a> is the entry point for compilation-related operations. It has the ability to check for active builds, and ongoing watch operations to ensure only one process is building at a time.  Within the framework, regardless of mono-repo or not, the compilation always targets the entire project.  With the efficient caching behavior, this leads to generally a minimal overhead but allows for centralization of all operations. <br><br>
The compiler cli supports the following operations:
<ul> <li><code class="item method">start|watch</code> - Run the compiler in watch mode</li>
<li><code class="item method">stop</code> - Stop the compiler if running</li>
<li><code class="item method">restart</code> - Restart the compiler in watch mode</li>
<li><code class="item method">build</code> - Ensure the project is built and upto date</li>
<li><code class="item method">clean</code> - Clean out the output and compiler caches</li>
<li><code class="item method">info</code> - Retrieve the compiler information, if running</li>
<li><code class="item method">event &lt;log|progress|state&gt;</code> - Watch events in realtime as newline delimited JSON</li>
<li><code class="item method">exec &lt;file&gt; [...args]</code> - Allow for compiling and executing an entrypoint file</li>
<li><code class="item method">manifest --prod [output]</code> - Generate the project manifest</li>
</ul>
In addition to the normal output, the compiler supports an environment variable <code class="item input">TRV_BUILD</code> that supports the following values: <code class="item input">debug</code>, <code class="item input">info</code>, <code class="item input">warn</code> or <code class="item input">none</code>.  This provides different level of logging during the build process which is helpful to diagnose any odd behaviors.  When invoking an unknown command (e.g. <code class="item method">&lt;other&gt;</code> from above), the default level is <code class="item input">warn</code>.  Otherwise the default logging level is <code class="item input">info</code>.

  <figure class="terminal">
    <figcaption class="terminal">Sample trv output with debug logging

</figcaption>
    <pre><code class="language-bash">$ <span class="token assign-left variable">TRV_BUILD</span><span class="token operator">=</span>debug trvc build

<span class="token number">2029</span>-03-14T04:00:00.618Z info  <span class="token punctuation">[</span>server         <span class="token punctuation">]</span> Starting server http://127.0.0.1:25539
<span class="token number">2029</span>-03-14T04:00:00.837Z debug <span class="token punctuation">[</span>compiler-exec  <span class="token punctuation">]</span> Start Server
<span class="token number">2029</span>-03-14T04:00:01.510Z debug <span class="token punctuation">[</span>event-stream   <span class="token punctuation">]</span> Started event stream
<span class="token number">2029</span>-03-14T04:00:02.450Z info  <span class="token punctuation">[</span>compiler-exec  <span class="token punctuation">]</span> Launching compiler
<span class="token number">2029</span>-03-14T04:00:02.762Z debug <span class="token punctuation">[</span>server         <span class="token punctuation">]</span> Compilation started
<span class="token number">2029</span>-03-14T04:00:02.947Z info  <span class="token punctuation">[</span>server         <span class="token punctuation">]</span> State changed: init
<span class="token number">2029</span>-03-14T04:00:03.093Z debug <span class="token punctuation">[</span>server         <span class="token punctuation">]</span> Compiler loaded
<span class="token number">2029</span>-03-14T04:00:04.003Z info  <span class="token punctuation">[</span>server         <span class="token punctuation">]</span> State changed: compile-start
<span class="token number">2029</span>-03-14T04:00:04.495Z info  <span class="token punctuation">[</span>server         <span class="token punctuation">]</span> State changed: compile-end
<span class="token number">2029</span>-03-14T04:00:05.066Z debug <span class="token punctuation">[</span>server         <span class="token punctuation">]</span> Compiler process <span class="token function">shutdown</span>
<span class="token number">2029</span>-03-14T04:00:05.307Z debug <span class="token punctuation">[</span>compiler-exec  <span class="token punctuation">]</span> Finished
<span class="token number">2029</span>-03-14T04:00:05.952Z debug <span class="token punctuation">[</span>event-stream   <span class="token punctuation">]</span> Finished event stream
<span class="token number">2029</span>-03-14T04:00:06.859Z debug <span class="token punctuation">[</span>compiler-exec  <span class="token punctuation">]</span> Shutting down process
<span class="token number">2029</span>-03-14T04:00:07.720Z info  <span class="token punctuation">[</span>server         <span class="token punctuation">]</span> Closing down server
<span class="token number">2029</span>-03-14T04:00:08.179Z debug <span class="token punctuation">[</span>server         <span class="token punctuation">]</span> Server close event
<span class="token number">2029</span>-03-14T04:00:08.588Z info  <span class="token punctuation">[</span>server         <span class="token punctuation">]</span> Closed down server
<span class="token number">2029</span>-03-14T04:00:09.493Z debug <span class="token punctuation">[</span>server         <span class="token punctuation">]</span> Finished processing events
<span class="token number">2029</span>-03-14T04:00:10.395Z debug <span class="token punctuation">[</span>compiler-exec  <span class="token punctuation">]</span> End Server</code></pre>
  </figure>

  <figure class="terminal">
    <figcaption class="terminal">Sample trv output with default log level

</figcaption>
    <pre><code class="language-bash">$ trvc build</code></pre>
  </figure>

<h2 id="compilation-architecture">Compilation Architecture</h2>

The compiler will move through the following phases on a given compilation execution:
<ul> <li><code class="item method">Compiler Server</code> - Provides a simple HTTP interface to watching compiler file and state changes, and synchronizing multiple processes</li>
<li><code class="item method">Build Compiler</code> - Leverages <a target="_blank" class="external-link" href="https://typescriptlang.org">Typescript</a> to build files needed to execute compiler</li>
<li><code class="item method">Build Manifest</code> - Produces the manifest for the given execution</li>
<li><code class="item method">Build Transformers</code> - Leverages <a target="_blank" class="external-link" href="https://typescriptlang.org">Typescript</a> to compile all transformers defined in the manifest</li>
<li><code class="item method">Produce Manifest Delta</code> - Compare the output file system with the manifest to determine what needs to be compiled</li>
<li><code class="item method">Clear all output if needed</code> - When the compiler source or transformers change, invalidate the entire output</li>
<li><code class="item method">Persist Manifest(s)</code> - Ensure the manifest is available for the compiler to leverage. Multiple will be written if in a monorepo</li>
<li><code class="item method">Invoke Compiler</code> - Run <a target="_blank" class="external-link" href="https://typescriptlang.org">Typescript</a> compiler with the aforementioned enhancements</li>
</ul>
