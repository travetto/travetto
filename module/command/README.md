<!-- This file was generated by @travetto/doc and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/main/module/command/DOC.tsx and execute "npx trv doc" to rebuild -->
# Command

## Support for executing complex commands at runtime.

**Install: @travetto/command**
```bash
npm install @travetto/command

# or

yarn add @travetto/command
```

The command module provides the necessary foundation for calling complex commands at runtime. Additionally special attention is provided to running [docker](https://www.docker.com/community-edition) containers.

## Docker Support
Docker provides a unified way of executing external programs with a high level of consistency and simplicity.  For that reason, the framework leverages this functionality to provide a clean cross-platform experience.  The docker functionality allows you to interact with containers in two ways:
   *  Invoke a single operation against a container
   *  Spin up a container and run multiple executions against it.  In this format, the container, once started, will be scheduled to terminate on `Shutdown` of the application.

**Code: Launching nginx and wait for connect**
```typescript
import { DockerContainer, CommandUtil } from '@travetto/command';

export class NginxServer {
  #port: number;
  container: DockerContainer;

  constructor(
    port = Math.trunc(Math.random() * 40000) + 10000
  ) {
    this.#port = port;
    this.container = new DockerContainer('nginx:latest')
      .exposePort(this.#port, 80)
      .forceDestroyOnShutdown();
  }
  start() {
    this.container.run();
    CommandUtil.waitForPort(this.#port);
    console.log('Ready!');
  }

  async stop() {
    await this.container.stop();
    console.log('Stopped');
  }
}
```

## Command Service
While docker containers provide a high level of flexibility, performance can be an issue.  [CommandOperation](https://github.com/travetto/travetto/tree/main/module/command/src/command.ts#L11) is a construct that wraps execution of a specific child program.  It allows for the application to decide between using docker to invoke the child program or calling the binary against the host operating system.  This is especially useful in environments where installation of programs (and specific versions) is challenging.

**Code: Command Service example, using pngquant**
```typescript
import { createWriteStream, createReadStream } from 'fs';
import { CommandOperation } from '@travetto/command';

export class ImageCompressor {
  converter = new CommandOperation({
    containerImage: 'agregad/pngquant',
    localCheck: ['pngquant', ['-h']]
  });

  async compress(img: string) {
    const state = await this.converter.exec('pngquant', '--quality', '40-80', '--speed 1', '--force', '-');
    const out = `${img}.compressed`;

    // Feed into process
    createReadStream(img).pipe(state.process.stdin!);
    // Feed from process to file system
    state.process.stdout!.pipe(createWriteStream(out));

    await state.result;
  }
}
```

## CLI - service
The module provides the ability to start/stop/restart services as [docker](https://www.docker.com/community-edition) containers.  This is meant to be used for development purposes, to minimize the effort of getting an application up and running.  Services can be targeted individually or handled as a group.

**Terminal: Command Service**
```bash
$ trv service --help

Usage: service [options] <action:start|status|stop|restart> [services...:string]

Options:
  -h, --help  display help for command

Available Services
--------------------
 * dynamodb@1.20.0
 * elasticsearch@8.6.2
 * firestore@latest
 * mongodb@6.0
 * mysql@8.0
 * postgresql@14.6
 * redis@7
 * s3@2.0.1
```

A sample of all services available to the entire framework:

**Terminal: All Services**
```bash
$ trv service status

Service          Version    Status
-------------------------------------------------
mongodb              6.0    Running 93af422e793a
s3                 2.0.1    Running ed76ee063d13
```

### Defining new Services
The services are defined as plain typescript files within the framework and can easily be extended:

**Code: Sample Service Definition**
```typescript
import { Env } from '@travetto/base';
import type { CommandService } from '@travetto/command';

const version = Env.get('MONGO_VERSION', '4.4');

export const service: CommandService = {
  name: 'mongodb',
  version,
  port: 27017,
  image: `mongo:${version}`
};
```
