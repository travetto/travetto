<!-- This file was generated by @travetto/doc and should not be modified directly -->
<!-- Please modify https://github.com/travetto/travetto/tree/main/module/auth-model/DOC.tsx and execute "npx trv doc" to rebuild -->
# Authentication Model

## Authentication model support for the Travetto framework

**Install: @travetto/auth-model**
```bash
npm install @travetto/auth-model

# or

yarn add @travetto/auth-model
```

This module supports the integration between the [Authentication](https://github.com/travetto/travetto/tree/main/module/auth#readme "Authentication scaffolding for the Travetto framework") module and the [Data Modeling Support](https://github.com/travetto/travetto/tree/main/module/model#readme "Datastore abstraction for core operations."). 

The asset module requires a [CRUD](https://github.com/travetto/travetto/tree/main/module/model/src/types/crud.ts#L11)-model to provide functionality for reading and storing user information. You can use any existing providers to serve as your [CRUD](https://github.com/travetto/travetto/tree/main/module/model/src/types/crud.ts#L11), or you can roll your own.

**Install: provider**
```bash
npm install @travetto/model-{provider}

# or

yarn add @travetto/model-{provider}
```
Currently, the following are packages that provide [CRUD](https://github.com/travetto/travetto/tree/main/module/model/src/types/crud.ts#L11):
   *  [DynamoDB Model Support](https://github.com/travetto/travetto/tree/main/module/model-dynamodb#readme "DynamoDB backing for the travetto model module.") - @travetto/model-dynamodb
   *  [Elasticsearch Model Source](https://github.com/travetto/travetto/tree/main/module/model-elasticsearch#readme "Elasticsearch backing for the travetto model module, with real-time modeling support for Elasticsearch mappings.") - @travetto/model-elasticsearch
   *  [Firestore Model Support](https://github.com/travetto/travetto/tree/main/module/model-firestore#readme "Firestore backing for the travetto model module.") - @travetto/model-firestore
   *  [MongoDB Model Support](https://github.com/travetto/travetto/tree/main/module/model-mongo#readme "Mongo backing for the travetto model module.") - @travetto/model-mongo
   *  [Redis Model Support](https://github.com/travetto/travetto/tree/main/module/model-redis#readme "Redis backing for the travetto model module.") - @travetto/model-redis
   *  [S3 Model Support](https://github.com/travetto/travetto/tree/main/module/model-s3#readme "S3 backing for the travetto model module.") - @travetto/model-s3
   *  [MySQL Model Service](https://github.com/travetto/travetto/tree/main/module/model-mysql#readme "MySQL backing for the travetto model module, with real-time modeling support for SQL schemas.") - @travetto/model-mysql
   *  [PostgreSQL Model Service](https://github.com/travetto/travetto/tree/main/module/model-postgres#readme "PostgreSQL backing for the travetto model module, with real-time modeling support for SQL schemas.") - @travetto/model-postgres
   *  [SQLite Model Service](https://github.com/travetto/travetto/tree/main/module/model-sqlite#readme "SQLite backing for the travetto model module, with real-time modeling support for SQL schemas.") - @travetto/model-sqlite
   *  [Memory Model Support](https://github.com/travetto/travetto/tree/main/module/model-memory#readme "Memory backing for the travetto model module.") - @travetto/model-memory
   *  [File Model Support](https://github.com/travetto/travetto/tree/main/module/model-file#readme "File system backing for the travetto model module.") - @travetto/model-file

The module itself is fairly straightforward, and truly the only integration point for this module to work is defined at the model level.  The contract for authentication is established in code as providing translation to and from a [RegisteredPrincipal](https://github.com/travetto/travetto/tree/main/module/auth-model/src/model.ts#L11). 

A registered principal extends the base concept of an principal, by adding in additional fields needed for local registration, specifically password management information.

**Code: RegisteredPrincipal**
```typescript
export interface RegisteredPrincipal extends Principal {
  /**
   * Password hash
   */
  hash?: string;
  /**
   * Password salt
   */
  salt?: string;
  /**
   * Temporary Reset Token
   */
  resetToken?: string;
  /**
   * End date for the reset token
   */
  resetExpires?: Date;
  /**
   * The actual password, only used on password set/update
   */
  password?: string;
}
```

**Code: A valid user model**
```typescript
import { Model } from '@travetto/model';
import type { RegisteredPrincipal } from '@travetto/auth-model';

@Model()
export class User implements RegisteredPrincipal {
  id: string;
  source: string;
  details: Record<string, unknown>;
  password?: string;
  salt: string;
  hash: string;
  resetToken?: string;
  resetExpires?: Date;
  permissions: string[];
}
```

## Configuration
Additionally, there exists a common practice of mapping various external security principals into a local contract. These external identities, as provided from countless authentication schemes, need to be homogenized for use.  This has been handled in other frameworks by using external configuration, and creating a mapping between the two set of fields.  Within this module, the mappings are defined as functions in which you can translate to the model from an identity or to an identity from a model.

**Code: Principal Source configuration**
```typescript
import { InjectableFactory } from '@travetto/di';
import { ModelAuthService } from '@travetto/auth-model';
import type { ModelCrudSupport } from '@travetto/model';

import { User } from './model.ts';

class AuthConfig {
  @InjectableFactory()
  static getModelAuthService(service: ModelCrudSupport) {
    return new ModelAuthService(
      service,
      User,
      user => ({    // This converts User to a RegisteredPrincipal
        source: 'model',
        provider: 'model',
        id: user.id!,
        permissions: user.permissions,
        hash: user.hash,
        salt: user.salt,
        resetToken: user.resetToken,
        resetExpires: user.resetExpires,
        password: user.password,
        details: user,
      }),
      user => User.from(({   // This converts a RegisteredPrincipal to a User
        id: user.id,
        permissions: [...(user.permissions || [])],
        hash: user.hash,
        salt: user.salt,
        resetToken: user.resetToken,
        resetExpires: user.resetExpires,
      })
      )
    );
  }
}
```

**Code: Sample usage**
```typescript
import { RuntimeError } from '@travetto/runtime';
import { Injectable, Inject } from '@travetto/di';
import type { ModelAuthService } from '@travetto/auth-model';

import type { User } from './model.ts';

@Injectable()
class UserService {

  @Inject()
  private auth: ModelAuthService<User>;

  async authenticate(identity: User) {
    try {
      return await this.auth.authenticate(identity);
    } catch (error) {
      if (error instanceof RuntimeError && error.category === 'notfound') {
        return await this.auth.register(identity);
      } else {
        throw error;
      }
    }
  }
}
```

## Common Utilities
The [AuthModelUtil](https://github.com/travetto/travetto/tree/main/module/auth-model/src/util.ts#L6) provides the following functionality:

**Code: Auth util structure**
```typescript
export class AuthModelUtil {
  /**
   * Generate a hash for a given value
   *
   * @param value Value to hash
   * @param salt The salt value
   * @param iterations Number of iterations on hashing
   * @param keylen Length of hash
   * @param digest Digest method
   */
  static async generateHash(value: string, salt: string, iterations = 25000, keylen = 256, digest = 'SHA-256'): Promise<string>;
  /**
   * Generate a salted password, with the ability to validate the password
   *
   * @param password
   * @param salt Salt value, or if a number, length of salt
   * @param validator Optional function to validate your password
   */
  static async generatePassword(password: string, salt: number | string = 32): Promise<{ salt: string, hash: string }>;
}
```
