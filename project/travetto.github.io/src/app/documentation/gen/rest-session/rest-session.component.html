<div class="documentation"><h2 id="rest-session" id="rest-session">Rest-Session</h2>
<app-section-header headerType="install">Session support</app-section-header>
<pre><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> @travetto/rest-session</code></pre><p>This is a module that adds session support to the <a class="module-link" routerLink="/docs/rest"  null><code class="inline">Rest</code></a> framework.  Sessions are represented as:</p>
<app-section-header headerType="code">Session Structure</app-section-header>
<pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Session</span><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">></span> <span class="token punctuation">{{ '{' }}</span>
  expiresAt<span class="token punctuation">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> undefined<span class="token punctuation">;</span>
  action<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">'create'</span> <span class="token operator">|</span> <span class="token string">'destroy'</span> <span class="token operator">|</span> <span class="token string">'modify'</span><span class="token punctuation">;</span>
  maxAge<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  signature<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  issuedAt<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  data<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><p>A session allows for defining the expiration time, what state the session should be in, as well as the payload (session data).  The session and session data are accessible via the <code class="decorator inline">@Context</code> parameter as <code class="inline">Session</code> and <code class="inline">SessionData</code> respectively.  Iit can also be accessed via the <code class="inline">request</code> as a session property. </p>
<app-section-header headerType="code">Sample Session Usage</app-section-header>
<pre><code class="language-typescript">@<span class="token meta">Put</span><span class="token punctuation">(</span><span class="token string">'/info'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">storeInfo</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token meta">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span> data<span class="token punctuation">:</span> SessionData</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
  data<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
  data<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'<span class="token type">Roger</span>'</span><span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token comment">// <span class="token type">Setting</span> data</span>
<span class="token punctuation">{{ '}' }}</span>
<span class="token operator">...</span>
@<span class="token meta">Get</span><span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token meta">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span> session<span class="token punctuation">:</span> Session</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
  <span class="token keyword">await</span> session<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{{ '}' }}</span>
<span class="token operator">...</span>
@<span class="token meta">Get</span><span class="token punctuation">(</span><span class="token string">'/info/age'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token meta">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span> data<span class="token punctuation">:</span> SessionData</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
  <span class="token keyword">return</span> data<span class="token punctuation">.</span>age<span class="token punctuation">;</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><p>This usage should be comparable to express, koa and mostly every other framework.</p>
<h3 id="configuration">Configuration</h3>
<p>Session mechanics are defined by two main components within the module.  The primary pieces are:</p>
<ul>
<li><a class="source-link" href="https://github.com/travetto/travetto/tree/master/module/rest-session/src/encoder" target="_blank" null><code class="inline">Encoders</code></a></li>
<li><a class="source-link" href="https://github.com/travetto/travetto/tree/master/module/rest-session/src/store" target="_blank" null><code class="inline">Stores</code></a></li>
</ul>
<p>By default, the module supplies the <a class="source-link" href="https://github.com/travetto/travetto/tree/master/module/rest-session/src/encoder/cookie.ts" target="_blank" null><code class="inline">CookieEncoder</code></a> and the <a class="source-link" href="https://github.com/travetto/travetto/tree/master/module/rest-session/src/store/memory.ts" target="_blank" null><code class="inline">MemoryStore</code></a> for default usage. The memory store is not intended for production, so an alternate store should be configured.  Currently the only other store provided is one that leverages the <a class="module-link" routerLink="/docs/model"  null><code class="inline">Model</code></a> module.  This allows you to leverage your model service to provide an easy mechanism for storage and retrieval. To use it, just register it as a SessionStore and you are good to go:</p>
<app-section-header headerType="code">Model Store</app-section-header>
<pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppConfig</span> <span class="token punctuation">{{ '{' }}</span>
  @<span class="token meta">InjectableFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">getStore</span><span class="token punctuation">(</span>model<span class="token punctuation">:</span> <span class="token type">ModelStore</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token type">SessionStore</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token comment">// <span class="token type">This</span> method notifies the framework that <span class="token type">ModelStore</span> is the desired backing for the SessionStore</span>
    <span class="token keyword">return</span> model<span class="token punctuation">;</span>
  <span class="token punctuation">{{ '}' }}</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><h4 id="building-an-encoder">Building an Encoder</h4>
<p>Encoders are pieces that enable you read/write the session state from the request/response.  This allows for sessions to be read/written to cookies, headers, url parameters, etc. The structure for the encoder is fairly straightforward:</p>
<app-section-header headerType="code">Encoder structure</app-section-header>
<pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SessionEncoder</span> <span class="token punctuation">{{ '{' }}</span>
  <span class="token keyword">abstract</span> <span class="token function">encode</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> <span class="token type">Request</span><span class="token punctuation">,</span> res<span class="token punctuation">:</span> <span class="token type">Response</span><span class="token punctuation">,</span> session<span class="token punctuation">:</span> <span class="token type">Session</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">abstract</span> <span class="token function">decode</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> <span class="token type">Request</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span> <span class="token operator">|</span> <span class="token type">Session</span> <span class="token operator">|</span> undefined<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><p>The encoder will <code class="inline">encode</code> the session into the response, as a string.  The <code class="inline">decode</code> operation will then read that string and either produce a session identifier (a string) or a fully defined <code class="inline">Session</code> object.  This allows for storing the session data externally or internal to the app, and referencing it by a session identifier.</p>
<app-section-header headerType="code">Header Encoder</app-section-header>
<pre><code class="language-typescript">@<span class="token meta">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{{ '{' }}</span> target<span class="token punctuation">:</span> <span class="token type">HeaderEncoder</span> <span class="token punctuation">{{ '}' }}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HeaderEncoder</span> <span class="token keyword">extends</span> <span class="token class-name">SessionEncoder</span> <span class="token punctuation">{{ '{' }}</span>
  <span class="token keyword">async</span> <span class="token function">encode</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> <span class="token type">Request</span><span class="token punctuation">,</span> res<span class="token punctuation">:</span> <span class="token type">Response</span><span class="token punctuation">,</span> session<span class="token punctuation">:</span> <span class="token type">Session</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>session<span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'sessionId'</span><span class="token punctuation">,</span> session<span class="token punctuation">.</span>id<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{ '}' }}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{ '}' }}</span>

<span class="token keyword">async</span> <span class="token function">decode</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> <span class="token type">Request</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span> <span class="token operator">|</span> <span class="token type">Session</span> <span class="token operator">|</span> undefined<span class="token operator">></span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">return</span> req<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'sessionId'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{ '}' }}</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><h4 id="building-a-custom-store">Building a Custom Store</h4>
<p>Session stores represent the ability to store session information internal to the app (i.e. not exposed to the client). The module comes with a <a class="source-link" href="https://github.com/travetto/travetto/tree/master/module/rest-session/src/store/memory.ts" target="_blank" null><code class="inline">MemoryStore</code></a> by default, but is not intended for production.  The store will store and maintain session data in a hashmap, without proper eviction (hence memory leaks). A store is defined by it’s ability to retrieve and store session data:</p>
<app-section-header headerType="code">Store structure</app-section-header>
<pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SessionStore</span> <span class="token punctuation">{{ '{' }}</span>
  <span class="token keyword">async</span> <span class="token function">validate</span><span class="token punctuation">(</span>session<span class="token punctuation">:</span> <span class="token type">Session</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> maxAge<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token type">Session</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">abstract</span> <span class="token function">load</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token type">Session</span> <span class="token operator">|</span> undefined<span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">abstract</span> <span class="token function">store</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token type">Session</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">abstract</span> <span class="token function">destroy</span><span class="token punctuation">(</span>session<span class="token punctuation">:</span> <span class="token type">Session</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><p>The primary functionality that needs to be provided is that of <code class="inline">load</code>, <code class="inline">store</code> and  <code class="inline">destroy</code>.  This is as simple as:</p>
<app-section-header headerType="code">MemoryStore</app-section-header>
<pre><code class="language-typescript">@<span class="token meta">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{{ '{' }}</span> target<span class="token punctuation">:</span> <span class="token type">MemoryStore</span> <span class="token punctuation">{{ '}' }}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MemoryStore</span> <span class="token keyword">extends</span> <span class="token class-name">SessionStore</span> <span class="token punctuation">{{ '{' }}</span>
  storage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
      <span class="token keyword">try</span> <span class="token punctuation">{{ '{' }}</span>
        <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token type">Session</span><span class="token punctuation">;</span>
      <span class="token punctuation">{{ '}' }}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'<span class="token type">Unable</span> to restore malformed session'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">{{ '}' }}</span>
    <span class="token punctuation">{{ '}' }}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{ '}' }}</span>

  <span class="token keyword">async</span> <span class="token function">store</span><span class="token punctuation">(</span><span class="token parameter">session<span class="token punctuation">:</span> <span class="token type">Session</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">></span></span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>id<span class="token operator">!</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <span class="token type">Break</span> references, allow for GC</span>
  <span class="token punctuation">{{ '}' }}</span>

  <span class="token keyword">async</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token parameter">session<span class="token punctuation">:</span> Session</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>id<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{ '}' }}</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><p>The memory store is simple but illustrates the structure well.</p>
</div>