<div class="documentation"><h2 id="rest-session" id="rest-session">Rest-Session</h2>
<app-section-header headerType="install">Session support</app-section-header>
<pre><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> @travetto/rest-session</code></pre><p>This is a module that adds session support to the <a class="module-link" routerLink="/docs/rest"  null><code class="inline">Rest</code></a> framework.  Sessions are represented as:</p>
<app-section-header headerType="code">Session Structure</app-section-header>
<pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Session</span><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">></span> <span class="token punctuation">{{ '{' }}</span>
  expiresAt<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  action<span class="token operator">?</span><span class="token operator">:</span> <span class="token string">'create'</span> <span class="token operator">|</span> <span class="token string">'destroy'</span> <span class="token operator">|</span> <span class="token string">'modify'</span><span class="token punctuation">;</span>
  maxAge<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  signature<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  issuedAt<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  data<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><p>A session allows for defining the expiration time, what state the session should be in, as well as the payload (session data).  The session and session data are accessible via the <code class="decorator inline">@Context</code> parameter as <code class="inline">Session</code> and <code class="inline">SessionData</code> respectively.  Iit can also be accessed via the <code class="inline">request</code> as a session property. </p>
<app-section-header headerType="code">Sample Session Usage</app-section-header>
<pre><code class="language-typescript">@<span class="token meta">Put</span><span class="token punctuation">(</span><span class="token string">'/info'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">storeInfo</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token meta">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span> data<span class="token operator">:</span> SessionData</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
  data<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
  data<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'<span class="token type">Roger</span>'</span><span class="token punctuation">;</span> <span class="token comment">// <span class="token type">Setting</span> data</span>
<span class="token punctuation">{{ '}' }}</span>
<span class="token operator">...</span>
@<span class="token meta">Get</span><span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token meta">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span> session<span class="token operator">:</span> Session</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
  <span class="token keyword">await</span> session<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{{ '}' }}</span>
<span class="token operator">...</span>
@<span class="token meta">Get</span><span class="token punctuation">(</span><span class="token string">'/info/age'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token meta">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span> data<span class="token operator">:</span> SessionData</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
  <span class="token keyword">return</span> data<span class="token punctuation">.</span>age<span class="token punctuation">;</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><p>This usage should be comparable to express, koa and mostly every other framework.</p>
<h3 id="configuration">Configuration</h3>
<p>Session mechanics are defined by two main components, encoders and a cache source.  The encoders are provided within the module, but the stores are provided via the <a class="module-link" routerLink="/docs/utils" fragment="cache" null><code class="inline">Cache</code></a> module.  </p>
<p>By default, the module supplies the <a class="source-link" href="https://github.com/travetto/travetto/tree/master/module/rest-session/src/encoder/cookie.ts" target="_blank" null><code class="inline">CookieEncoder</code></a> and the [<code class="inline">MemoryCacheSource</code>] as default usage. </p>
<h4 id="building-an-encoder">Building an Encoder</h4>
<p>Encoders are pieces that enable you read/write the session state from the request/response.  This allows for sessions to be read/written to cookies, headers, url parameters, etc. The structure for the encoder is fairly straightforward:</p>
<app-section-header headerType="code">Encoder structure</app-section-header>
<pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SessionEncoder</span> <span class="token punctuation">{{ '{' }}</span>
  <span class="token keyword">abstract</span> <span class="token function">encode</span><span class="token punctuation">(</span>req<span class="token operator">:</span> <span class="token type">Request</span><span class="token punctuation">,</span> res<span class="token operator">:</span> <span class="token type">Response</span><span class="token punctuation">,</span> session<span class="token operator">:</span> <span class="token type">Session</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">abstract</span> <span class="token function">decode</span><span class="token punctuation">(</span>req<span class="token operator">:</span> <span class="token type">Request</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span> <span class="token operator">|</span> <span class="token type">Session</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><p>The encoder will <code class="inline">encode</code> the session into the response, as a string.  The <code class="inline">decode</code> operation will then read that string and either produce a session identifier (a string) or a fully defined <code class="inline">Session</code> object.  This allows for storing the session data externally or internal to the app, and referencing it by a session identifier.</p>
<app-section-header headerType="code">Header Encoder</app-section-header>
<pre><code class="language-typescript">@<span class="token meta">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{{ '{' }}</span> target<span class="token operator">:</span> <span class="token type">HeaderEncoder</span> <span class="token punctuation">{{ '}' }}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HeaderEncoder</span> <span class="token keyword">extends</span> <span class="token class-name">SessionEncoder</span> <span class="token punctuation">{{ '{' }}</span>
  <span class="token keyword">async</span> <span class="token function">encode</span><span class="token punctuation">(</span>req<span class="token operator">:</span> <span class="token type">Request</span><span class="token punctuation">,</span> res<span class="token operator">:</span> <span class="token type">Response</span><span class="token punctuation">,</span> session<span class="token operator">:</span> <span class="token type">Session</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>session<span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'sessionId'</span><span class="token punctuation">,</span> session<span class="token punctuation">.</span>id<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{ '}' }}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{ '}' }}</span>

<span class="token keyword">async</span> <span class="token function">decode</span><span class="token punctuation">(</span>req<span class="token operator">:</span> <span class="token type">Request</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span> <span class="token operator">|</span> <span class="token type">Session</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">></span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">return</span> req<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'sessionId'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{ '}' }}</span>
<span class="token punctuation">{{ '}' }}</span></code></pre></div>