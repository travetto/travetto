<div class="documentation"><h2 id="exec" id="exec">Exec</h2>
<app-section-header headerType="install">Primary</app-section-header>
<pre><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> @travetto/exec</code></pre><p>The exec module provides the necessary foundation for calling executables at runtime. Additionally special attention is provided to running <a class="external-link" href="https://www.docker.com/community-edition" target="_blank" null><code class="inline">docker</code></a> containers.</p>
<h3 id="simple-execution">Simple Execution</h3>
<p>Just like <a class="external-link" href="https://www.docker.com/community-edition" target="_blank" null><code class="inline">child_process</code></a>, the module exposes <code class="inline language-typescript">spawn</code>, <code class="inline language-typescript">fork</code>, and <code class="inline language-typescript">exec</code>.  These are generally wrappers around the underlying functionality.  In addition to the base functionality, each of those functions is converted to a <code class="inline language-typescript">Promise</code> structure, that throws an error on an non-zero return status.</p>
<p>A simple example would be</p>
<app-section-header headerType="code">Running a directory listing via ls</app-section-header>
<pre><code class="language-typescript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">executeListing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
  <span class="token keyword">const</span> <span class="token punctuation">{{ '{' }}</span> result <span class="token punctuation">{{ '}' }}</span> <span class="token operator">=</span> <span class="token type">Exec</span><span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> result<span class="token punctuation">;</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><p>As you can see, the call returns not only the child process information, but the <code class="inline language-typescript">Promise</code> to wait for.  Additionally, some common patterns are provided for the default construction of the child process. In addition to the standard options for running child processes, the module also supports:</p>
<ul>
<li><code class="inline">timeout</code> as the number of milliseconds the process can run before terminating and throwing an error</li>
<li><code class="inline">quiet</code> which suppresses all stdout/stderr output</li>
<li><code class="inline">stdin</code> as a string, buffer or stream to provide input to the program you are running;</li>
<li><code class="inline">timeoutKill</code> allows for registering functionality to execute when a process is force killed by timeout</li>
</ul>
<h3 id="docker-support">Docker Support</h3>
<p>Docker provides a unified way of executing external programs with a high level of consistency and simplicity.  For that reason, the framework leverages this functionality to provide a clean cross-platform experience.  The docker functionality allows you to interact with containers in two ways:</p>
<ul>
<li>Invoke a single operation against a container</li>
<li>Spin up a container and run multiple executions against it.  In this format, the container, once started, will be scheduled to terminate on <code class="inline language-typescript">Shutdown</code> of the application. </li>
</ul>
<app-section-header headerType="code">Establishing mongo as a DockerContainer instance</app-section-header>
<pre><code class="language-typescript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
  <span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DockerContainer</span><span class="token punctuation">(</span><span class="token string">'mongo:latest'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">createTempVolume</span><span class="token punctuation">(</span><span class="token string">'/var/workspace'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">exposePort</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setWorkingDir</span><span class="token punctuation">(</span><span class="token string">'/var/workspace'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forceDestroyOnShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  container<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'--storageEngine'</span><span class="token punctuation">,</span> <span class="token string">'ephemeralForTest'</span><span class="token punctuation">,</span> <span class="token string">'--port'</span><span class="token punctuation">,</span> port<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> container<span class="token punctuation">.</span><span class="token function">waitForPorts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><h3 id="command-service">Command Service</h3>
<p>While docker containers provide a high level of flexibility, performance can be an issue.  <a class="source-link" href="https://github.com/travetto/travetto/tree/master/module/exec/src/command.ts" target="_blank" null><code class="inline language-typescript">CommandService</code></a> is a construct that wraps execution of a specific child program.  It allows for the application to decide between using docker to invoke the child program or calling the binary against the host operating system.  This is especially useful in environments where installation of programs (and specific versions) is challenging.</p>
<app-section-header headerType="code">Command Service example, using pngquant</app-section-header>
<pre><code class="language-typescript"><span class="token keyword">const</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommandService</span><span class="token punctuation">(</span><span class="token punctuation">{{ '{' }}</span>
  containerImage<span class="token punctuation">:</span> <span class="token string">'agregad/pngquant'</span><span class="token punctuation">,</span>
  localCheck<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'pngquant'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'-h'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">{{ '}' }}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">compress</span><span class="token punctuation">(</span><span class="token parameter">img</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">await</span> converter<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'pngquant'</span><span class="token punctuation">,</span> <span class="token string">'--quality'</span><span class="token punctuation">,</span> <span class="token string">'40-80'</span><span class="token punctuation">,</span> <span class="token string">'--speed 1'</span><span class="token punctuation">,</span> <span class="token string">'--force'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> out <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${{ '{' }}</span>img<span class="token interpolation-punctuation punctuation">{{ '}' }}</span></span><span class="token string">.compressed`</span></span><span class="token punctuation">;</span>

  fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>process<span class="token punctuation">.</span>stdin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> state<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
<span class="token punctuation">{{ '}' }}</span></code></pre></div>