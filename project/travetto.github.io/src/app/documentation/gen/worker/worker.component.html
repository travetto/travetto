<div class="documentation"><h2 id="worker" id="worker">Worker</h2>
<app-section-header headerType="install">Primary</app-section-header>
<pre><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> @travetto/worker</code></pre><p>This module provides the necessary primitives for handling dependent workers.  A worker can be an individual actor or could be a pool of workers. Node provides ipc (inter-process communication) functionality out of the box. This module builds upon that by providing enhanced event management, richer process management, as well as constructs for orchestrating a conversation between two processes.  </p>
<h3 id="execution-pools">Execution Pools</h3>
<p>With respect to managing multiple executions, <a class="source-link" href="https://github.com/travetto/travetto/tree/master/module/worker/src/pool.ts" target="_blank" null><code class="inline">WorkPool</code></a> is provided to allow for concurrent operation, and processing of jobs concurrently.  To manage the flow of jobs, there are various <a class="source-link" href="https://github.com/travetto/travetto/tree/master/module/worker/src/input/types.ts" target="_blank" null><code class="inline">InputSource</code></a> implementation that allow for a wide range of use cases.</p>
<p>The supported <code class="inline">InputSource</code>s are</p>
<ul>
<li><code class="inline language-typescript">Array</code> is a list of jobs, will execute in order until list is exhausted. </li>
<li><code class="inline language-typescript">Queue</code> is similar to list but will execute forever waiting for new items to be added to the queue.</li>
<li><code class="inline language-typescript">Iterator</code> is a generator function that will continue to produce jobs until the iterator is exhausted.</li>
</ul>
<p>Below is a pool that will convert images on demand, while queuing as needed.</p>
<app-section-header headerType="code">Image processing queue, with a fixed batch/pool size</app-section-header>
<pre><code class="language-typescript"><span class="token keyword">class</span> <span class="token class-name">ImageProcessor</span> <span class="token punctuation">{{ '{' }}</span>
  active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  proc<span class="token punctuation">:</span> <span class="token type">ChildProcess</span><span class="token punctuation">;</span>

  <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>proc<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{ '}' }}</span>

  <span class="token keyword">async</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{{ '{' }}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>proc <span class="token operator">=</span> <span class="token operator">...</span>convert <span class="token operator">...</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>proc<span class="token punctuation">;</span>
    <span class="token punctuation">{{ '}' }}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>

    <span class="token punctuation">{{ '}' }}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{ '}' }}</span>
<span class="token punctuation">{{ '}' }}</span>

<span class="token keyword">class</span> <span class="token class-name">ImageCompressor</span> <span class="token keyword">extends</span> <span class="token class-name">WorkerPool</span> <span class="token punctuation">{{ '{' }}</span>

  pendingImages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueueInputSource</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">ImageProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{ '}' }}</span>

  <span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pendingImages<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{ '}' }}</span>

  <span class="token function">convert</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>images<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> img <span class="token keyword">of</span> images<span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pendingImages<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{ '}' }}</span>
  <span class="token punctuation">{{ '}' }}</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><p>Once a pool is constructed, it can be shutdown by calling the <code class="inline">.shutdown()</code> method, and awaiting the result.</p>
<h3 id="ipc-support">IPC Support</h3>
<p>Within the <code class="inline">comm</code> package, there is support for two primary communication elements: <code class="inline">child</code> and <code class="inline">parent</code>.  Usually <code class="inline">parent</code> indicates it is the owner of the sub process.  <code class="inline">Child</code> indicates that it has been created/spawned/forked by the parent and will communicate back to itâ€™s parent.  This generally means that a <code class="inline">parent</code> channel can be destroyed (i.e. killing the subprocess) where a <code class="inline">child</code> channel can only exit the process, but the channel cannot be destroyed.</p>
<h4 id="ipc-as-a-worker">IPC as a Worker</h4>
<p>A common pattern is to want to model a sub process as a worker, to be a valid candidate in a <code class="inline">WorkPool</code>.  The <code class="inline">WorkUtil</code> class provides a utility to facilitate this desire.   </p>
<app-section-header headerType="code">Spawned Worker Signature</app-section-header>
<pre><code class="language-typescript"><span class="token keyword">class</span> <span class="token class-name">WorkUtil</span> <span class="token punctuation">{{ '{' }}</span>
 <span class="token keyword">static</span> spawnedWorker<span class="token operator">&lt;</span><span class="token constant">X</span><span class="token operator">></span><span class="token punctuation">(</span>
    config<span class="token punctuation">:</span> <span class="token type">SpawnConfig</span> <span class="token operator">&amp;</span> <span class="token punctuation">{{ '{' }}</span>
      <span class="token function-variable function">execute</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">channel<span class="token punctuation">:</span> <span class="token type">ParentCommChannel</span><span class="token punctuation">,</span> input<span class="token punctuation">:</span> <span class="token constant">X</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">any</span><span class="token punctuation">,</span>
      destroy<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">channel<span class="token punctuation">:</span> ParentCommChannel</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">any</span><span class="token punctuation">,</span>
      init<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">channel<span class="token punctuation">:</span> ParentCommChannel</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">any</span><span class="token punctuation">,</span>
    <span class="token punctuation">{{ '}' }}</span>
  <span class="token punctuation">)</span></code></pre><p>When creating your work, via process spawning, you will need to provide the script (and any other features you would like in <code class="inline">SpawnConfig</code>).   Additionally you must, at a minimum, provide functionality to run whenever an input element is up for grabs in the input source.  This method will be provided the communication channel (<code class="inline">parent</code>) and the input value.  A simple example could look like:</p>
<app-section-header headerType="code">Simple Spawned Worker</app-section-header>
<pre><code class="language-typescript"><span class="token keyword">const</span> pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WorkPool</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
  <span class="token type">WorkUtil</span><span class="token punctuation">.</span>spawnedWorker<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">{{ '{' }}</span>
    command<span class="token punctuation">:</span> <span class="token type">FsUtil</span><span class="token punctuation">.</span><span class="token function">resolveUnix</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'simple.child-launcher.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    fork<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">channel</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
      <span class="token keyword">return</span> channel<span class="token punctuation">.</span><span class="token function">listenOnce</span><span class="token punctuation">(</span><span class="token string">'ready'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <span class="token type">Wait</span> for child to indicate it is ready</span>
    <span class="token punctuation">{{ '}' }}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token parameter">channel<span class="token punctuation">,</span> inp</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">listenOnce</span><span class="token punctuation">(</span><span class="token string">'response'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  <span class="token type">Register</span> response listener</span>
      channel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">{{ '{' }}</span> data<span class="token punctuation">:</span> inp <span class="token punctuation">{{ '}' }}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <span class="token type">Send</span> request</span>

      <span class="token keyword">const</span> <span class="token punctuation">{{ '{' }}</span> data <span class="token punctuation">{{ '}' }}</span> <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">;</span> <span class="token comment">// <span class="token type">Get</span> answer</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'<span class="token type">Sent</span>'</span><span class="token punctuation">,</span> inp<span class="token punctuation">,</span> <span class="token string">'<span class="token type">Received</span>'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">assert</span><span class="token punctuation">(</span>inp <span class="token operator">+</span> inp <span class="token operator">===</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <span class="token type">Ensure</span> the answer is double the input</span>
    <span class="token punctuation">{{ '}' }}</span>
  <span class="token punctuation">{{ '}' }}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><app-section-header headerType="code">Spawned Worker Target</app-section-header>
<pre><code class="language-typescript"><span class="token keyword">const</span> exec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChildCommChannel</span><span class="token operator">&lt;</span><span class="token punctuation">{{ '{' }}</span> data<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token punctuation">{{ '}' }}</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exec<span class="token punctuation">.</span><span class="token function">listenFor</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">{{ '{' }}</span>
  exec<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'response'</span><span class="token punctuation">,</span> <span class="token punctuation">{{ '{' }}</span> data<span class="token punctuation">:</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>data <span class="token operator">+</span> data<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{{ '}' }}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <span class="token type">When</span> data is received, return double</span>
<span class="token punctuation">{{ '}' }}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exec<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ready'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <span class="token type">Indicate</span> the child is ready to receive requests</span>

<span class="token keyword">const</span> <span class="token function-variable function">heartbeat</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>heartbeat<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <span class="token type">Keep</span>-alive</span>
<span class="token function">heartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>